<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AUG Dialog Game</title>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <style>
        /* ===== CSS Variables ===== */
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #1a1a25;
            --bg-card-hover: #252535;
            --accent-gold: #d4a574;
            --accent-gold-light: #e8c89e;
            --accent-red: #8b3a3a;
            --accent-red-light: #a85454;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --text-muted: #606070;
            --border-color: #3a3a4a;
            --border-gold: #d4a574;
            --shadow-gold: rgba(212, 165, 116, 0.3);
            --shadow-dark: rgba(0, 0, 0, 0.5);
            --gradient-gold: linear-gradient(135deg, #d4a574 0%, #b8956a 100%);
            --gradient-card: linear-gradient(145deg, #1e1e2a 0%, #151520 100%);
        }

        /* ===== Reset & Base ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* ===== Scrollbar ===== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-gold);
        }

        /* ===== App Container ===== */
        .app {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* ===== Header ===== */
        .header {
            background: var(--gradient-card);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient-gold);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 2px;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .breadcrumb-item {
            cursor: pointer;
            transition: color 0.2s;
        }

        .breadcrumb-item:hover {
            color: var(--accent-gold);
        }

        .breadcrumb-separator {
            color: var(--text-muted);
        }

        .header-right {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.6rem 1.2rem;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            border-color: var(--accent-gold);
            background: var(--bg-card-hover);
        }

        .btn-primary {
            background: var(--gradient-gold);
            border-color: var(--accent-gold);
            color: var(--bg-dark);
            font-weight: 600;
        }

        .btn-primary:hover {
            box-shadow: 0 0 20px var(--shadow-gold);
        }

        /* ===== Main Content ===== */
        .main {
            flex: 1;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* ===== View Containers ===== */
        .view {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== Scene Selection ===== */
        .section-title {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            color: var(--accent-gold-light);
        }

        .section-desc {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .scene-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .scene-card {
            background: var(--gradient-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .scene-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-gold);
            box-shadow: 0 10px 40px var(--shadow-dark), 0 0 30px var(--shadow-gold);
        }

        .scene-card-bg {
            height: 180px;
            background: linear-gradient(135deg, #2a2a3a 0%, #1a1a25 100%);
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .scene-card-bg::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: linear-gradient(transparent, var(--bg-card));
        }

        .scene-card-content {
            padding: 1.2rem;
        }

        .scene-card-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .scene-card-info {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .scene-card-npcs {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .scene-card-npc-tag {
            padding: 0.25rem 0.6rem;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* ===== NPC Selection ===== */
        .npc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .npc-card {
            background: var(--gradient-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .npc-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-gold);
            box-shadow: 0 10px 40px var(--shadow-dark), 0 0 20px var(--shadow-gold);
        }

        .npc-portrait {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 1rem;
            background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-red) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: var(--bg-dark);
            overflow: hidden;
            border: 3px solid var(--border-color);
            transition: border-color 0.3s;
        }

        .npc-card:hover .npc-portrait {
            border-color: var(--accent-gold);
        }

        .npc-portrait img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .npc-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

        .npc-role {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* ===== Dialog View - Visual Novel Style ===== */
        #dialogView {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 50;
            overflow: hidden;
        }

        .dialog-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            z-index: 0;
        }

        .dialog-bg::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom,
                rgba(0,0,0,0.1) 0%,
                rgba(0,0,0,0.1) 50%,
                rgba(0,0,0,0.6) 100%);
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .vn-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            background: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, transparent 100%);
        }

        .vn-scene-name {
            color: var(--accent-gold-light);
            font-size: 1.1rem;
            text-shadow: 0 2px 10px rgba(0,0,0,0.8);
        }

        .vn-back-btn {
            padding: 0.5rem 1rem;
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--accent-gold);
            border-radius: 6px;
            color: var(--accent-gold-light);
            cursor: pointer;
            transition: all 0.3s;
        }

        .vn-back-btn:hover {
            background: var(--accent-gold);
            color: var(--bg-dark);
        }

        /* NPCç«‹ç»˜åŒºåŸŸ */
        .vn-character {
            position: absolute;
            bottom: 220px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 5;
            transition: all 0.5s ease;
        }

        .vn-character img {
            max-height: 500px;
            max-width: 400px;
            object-fit: contain;
            filter: drop-shadow(0 10px 30px rgba(0,0,0,0.5));
            animation: characterIn 0.5s ease;
        }

        @keyframes characterIn {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .vn-character-placeholder {
            width: 200px;
            height: 300px;
            background: linear-gradient(135deg, rgba(212,165,116,0.3) 0%, rgba(139,58,58,0.3) 100%);
            border-radius: 50% 50% 0 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5rem;
            color: rgba(255,255,255,0.5);
            text-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        /* å¯¹è¯æ¡†å®¹å™¨ */
        .vn-dialog-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 10;
        }

        /* é€‰é¡¹åŒºåŸŸ */
        .vn-choices {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.8rem;
            padding: 1rem 2rem 1.5rem;
            animation: fadeInUp 0.4s ease;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .vn-choice-btn {
            width: 100%;
            max-width: 600px;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, rgba(20, 18, 28, 0.9) 0%, rgba(35, 30, 45, 0.9) 100%);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(212, 165, 116, 0.5);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .vn-choice-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(212,165,116,0.2), transparent);
            transition: left 0.5s;
        }

        .vn-choice-btn:hover {
            border-color: var(--accent-gold);
            background: linear-gradient(135deg, rgba(212, 165, 116, 0.2) 0%, rgba(35, 30, 45, 0.95) 100%);
            transform: scale(1.02);
            box-shadow: 0 0 30px rgba(212, 165, 116, 0.3);
        }

        .vn-choice-btn:hover::before {
            left: 100%;
        }

        /* ä¸»å¯¹è¯æ¡† */
        .vn-textbox {
            background: linear-gradient(to top,
                rgba(15, 12, 20, 0.95) 0%,
                rgba(25, 22, 35, 0.9) 100%);
            backdrop-filter: blur(20px);
            border-top: 2px solid var(--accent-gold);
            padding: 0;
            min-height: 180px;
            position: relative;
            box-shadow: 0 -10px 50px rgba(0,0,0,0.5);
        }

        .vn-textbox::before {
            content: '';
            position: absolute;
            top: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg,
                transparent 0%,
                var(--accent-gold) 20%,
                var(--accent-gold-light) 50%,
                var(--accent-gold) 80%,
                transparent 100%);
        }

        /* è¯´è¯è€…åå­— */
        .vn-speaker {
            position: absolute;
            top: -20px;
            left: 50px;
            background: linear-gradient(135deg, var(--accent-gold) 0%, #b8956a 100%);
            padding: 0.5rem 2rem;
            border-radius: 8px 8px 0 0;
            color: var(--bg-dark);
            font-weight: 700;
            font-size: 1.1rem;
            box-shadow: 0 -5px 20px rgba(212,165,116,0.3);
            letter-spacing: 1px;
        }

        .vn-speaker.player {
            background: linear-gradient(135deg, #5a8f7a 0%, #3d6b5a 100%);
            color: white;
        }

        /* å¯¹è¯å†…å®¹ */
        .vn-text-content {
            padding: 2rem 3rem 1.5rem;
            min-height: 120px;
        }

        .vn-text {
            font-size: 1.15rem;
            line-height: 2;
            color: var(--text-primary);
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        .vn-text.typing::after {
            content: 'â–Œ';
            animation: blink 0.8s infinite;
            color: var(--accent-gold);
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* ç‚¹å‡»ç»§ç»­æç¤º */
        .vn-continue {
            position: absolute;
            bottom: 1rem;
            right: 2rem;
            color: var(--accent-gold);
            font-size: 0.85rem;
            animation: pulse 1.5s infinite;
            cursor: pointer;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; transform: translateY(0); }
            50% { opacity: 1; transform: translateY(-3px); }
        }

        /* å¯¹è¯ç»“æŸ */
        .vn-end {
            text-align: center;
            padding: 2rem;
        }

        .vn-end-text {
            color: var(--accent-gold-light);
            font-size: 1.2rem;
            margin-bottom: 1.5rem;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .vn-end-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .vn-end-btn {
            padding: 0.8rem 2rem;
            background: rgba(0,0,0,0.5);
            border: 2px solid var(--accent-gold);
            border-radius: 8px;
            color: var(--accent-gold-light);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .vn-end-btn:hover {
            background: var(--accent-gold);
            color: var(--bg-dark);
        }

        /* ===== Editor View ===== */
        .editor-container {
            display: flex;
            gap: 1.5rem;
            height: calc(100vh - 200px);
            min-height: 600px;
        }

        .editor-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--gradient-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .editor-panel-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-panel-title {
            font-weight: 600;
            color: var(--accent-gold-light);
        }

        .editor-textarea {
            flex: 1;
            width: 100%;
            padding: 1.5rem;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            resize: none;
            outline: none;
        }

        .editor-textarea::placeholder {
            color: var(--text-muted);
        }

        .preview-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        /* ===== Error Message ===== */
        .error-container {
            background: rgba(139, 58, 58, 0.2);
            border: 1px solid var(--accent-red);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .error-title {
            color: var(--accent-red-light);
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .error-message {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-family: monospace;
        }

        /* ===== Toast Notification ===== */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 10px 40px var(--shadow-dark);
            z-index: 1000;
            animation: toastIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .toast.success {
            border-color: #4a7c59;
        }

        .toast.error {
            border-color: var(--accent-red);
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== Empty State ===== */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        /* ===== Help Modal ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            max-width: 700px;
            max-height: 80vh;
            overflow: hidden;
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.3rem;
            color: var(--accent-gold-light);
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.5rem;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            max-height: 60vh;
        }

        .modal-body h4 {
            color: var(--accent-gold);
            margin: 1.5rem 0 0.8rem;
        }

        .modal-body h4:first-child {
            margin-top: 0;
        }

        .modal-body pre {
            background: var(--bg-dark);
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 0.85rem;
            line-height: 1.5;
            border: 1px solid var(--border-color);
        }

        .modal-body p {
            color: var(--text-secondary);
            margin-bottom: 0.8rem;
        }

        .modal-body code {
            background: var(--bg-dark);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        /* ===== Responsive ===== */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }
            .main {
                padding: 1rem;
            }
            .dialog-container,
            .editor-container {
                flex-direction: column;
                height: auto;
            }
            .scene-grid {
                grid-template-columns: 1fr;
            }
            .npc-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="logo">AUG DIALOG</div>
                <div class="breadcrumb" id="breadcrumb">
                    <span class="breadcrumb-item" onclick="showScenes()">åœºæ™¯é€‰æ‹©</span>
                </div>
            </div>
            <div class="header-right">
                <button class="btn" onclick="showHelp()">
                    <span>?</span> å¸®åŠ©
                </button>
                <button class="btn" id="editToggle" onclick="toggleEditor()">
                    <span>âœ</span> ç¼–è¾‘æ¨¡å¼
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main">
            <!-- Scene Selection View -->
            <div class="view active" id="sceneView">
                <h1 class="section-title">é€‰æ‹©åœºæ™¯</h1>
                <p class="section-desc">é€‰æ‹©ä¸€ä¸ªåœºæ™¯å¼€å§‹å¯¹è¯å†’é™©</p>
                <div class="scene-grid" id="sceneGrid"></div>
                <div class="empty-state" id="sceneEmpty" style="display: none;">
                    <div class="empty-state-icon">ğŸ </div>
                    <div class="empty-state-title">æš‚æ— åœºæ™¯</div>
                    <p>ç‚¹å‡»å³ä¸Šè§’"ç¼–è¾‘æ¨¡å¼"æ·»åŠ åœºæ™¯æ•°æ®</p>
                </div>
            </div>

            <!-- NPC Selection View -->
            <div class="view" id="npcView">
                <h1 class="section-title" id="npcViewTitle">é€‰æ‹©è§’è‰²</h1>
                <p class="section-desc" id="npcViewDesc">é€‰æ‹©ä¸€ä¸ªè§’è‰²å¼€å§‹å¯¹è¯</p>
                <div class="npc-grid" id="npcGrid"></div>
            </div>

            <!-- Dialog View - Visual Novel Style -->
            <div class="view" id="dialogView">
                <!-- å…¨å±èƒŒæ™¯ -->
                <div class="dialog-bg" id="dialogBg"></div>

                <!-- é¡¶éƒ¨å¯¼èˆª -->
                <div class="vn-header">
                    <div class="vn-scene-name" id="vnSceneName">åœºæ™¯åç§°</div>
                    <button class="vn-back-btn" onclick="exitDialog()">è¿”å›</button>
                </div>

                <!-- NPCç«‹ç»˜ -->
                <div class="vn-character" id="vnCharacter"></div>

                <!-- åº•éƒ¨å¯¹è¯åŒºåŸŸ -->
                <div class="vn-dialog-container">
                    <!-- é€‰é¡¹åŒºåŸŸ -->
                    <div class="vn-choices" id="vnChoices" style="display: none;"></div>

                    <!-- å¯¹è¯æ¡† -->
                    <div class="vn-textbox" id="vnTextbox" onclick="handleTextboxClick()">
                        <div class="vn-speaker" id="vnSpeaker">è§’è‰²å</div>
                        <div class="vn-text-content">
                            <div class="vn-text" id="vnText"></div>
                        </div>
                        <div class="vn-continue" id="vnContinue">ç‚¹å‡»ç»§ç»­ â–¼</div>
                    </div>
                </div>
            </div>

            <!-- Editor View -->
            <div class="view" id="editorView">
                <div class="editor-container">
                    <div class="editor-panel">
                        <div class="editor-panel-header">
                            <span class="editor-panel-title">YAML ç¼–è¾‘å™¨</span>
                            <button class="btn btn-primary" onclick="saveAndPreview()">ä¿å­˜å¹¶é¢„è§ˆ</button>
                        </div>
                        <textarea class="editor-textarea" id="yamlEditor" placeholder="åœ¨æ­¤ç²˜è´´æˆ–ç¼–è¾‘ YAML æ•°æ®..."></textarea>
                    </div>
                    <div class="editor-panel">
                        <div class="editor-panel-header">
                            <span class="editor-panel-title">å®æ—¶é¢„è§ˆ</span>
                            <button class="btn" onclick="resetData()">é‡ç½®æ•°æ®</button>
                        </div>
                        <div class="preview-content" id="previewContent">
                            <div class="empty-state">
                                <div class="empty-state-icon">ğŸ“</div>
                                <div class="empty-state-title">ç¼–è¾‘ YAML æ•°æ®</div>
                                <p>åœ¨å·¦ä¾§ç¼–è¾‘å™¨ä¸­ç²˜è´´æˆ–ç¼–å†™ YAML æ•°æ®ï¼Œç‚¹å‡»"ä¿å­˜å¹¶é¢„è§ˆ"æŸ¥çœ‹æ•ˆæœ</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Help Modal -->
    <div class="modal-overlay" id="helpModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">YAML æ ¼å¼è¯´æ˜</h2>
                <button class="modal-close" onclick="closeHelp()">&times;</button>
            </div>
            <div class="modal-body">
                <h4>åŸºæœ¬ç»“æ„</h4>
                <p>æ•°æ®åŒ…å« <code>scenes</code> åœºæ™¯åˆ—è¡¨ï¼Œæ¯ä¸ªåœºæ™¯åŒ…å« NPC å’Œå¯¹è¯ã€‚</p>

                <h4>å®Œæ•´ç¤ºä¾‹</h4>
                <pre>scenes:
  - id: cafe
    name: "å’–å•¡é¦†"
    description: "æ¸©é¦¨çš„è¡—è§’å’–å•¡é¦†"
    background: "cafe.jpg"  # å¯é€‰ï¼Œæ”¾åœ¨imagesæ–‡ä»¶å¤¹
    npcs:
      - id: anna
        name: "å®‰å¨œ"
        role: "å’–å•¡å¸ˆ"
        portrait: "anna.png"  # æ”¾åœ¨imagesæ–‡ä»¶å¤¹
        dialog:
          start:
            - speaker: npc
              text: "æ¬¢è¿å…‰ä¸´ï¼æƒ³å–ç‚¹ä»€ä¹ˆï¼Ÿ"
            - speaker: player
              choices:
                - text: "æ¥æ¯æ‹¿é“"
                  goto: latte
                - text: "éšä¾¿èŠèŠ"
                  goto: chat
          latte:
            - speaker: npc
              text: "å¥½çš„ï¼Œç¨ç­‰ä¸€ä¸‹~"
            - speaker: npc
              text: "æ‚¨çš„æ‹¿é“å¥½äº†ï¼Œè¯·æ…¢ç”¨ï¼"
          chat:
            - speaker: npc
              text: "ä»Šå¤©å¤©æ°”çœŸä¸é”™å‘¢ï¼"</pre>

                <h4>å­—æ®µè¯´æ˜</h4>
                <p><code>speaker</code>: è¯´è¯è€…ï¼Œ<code>npc</code> æˆ– <code>player</code></p>
                <p><code>choices</code>: ç©å®¶é€‰é¡¹ï¼ŒåŒ…å« <code>text</code> æ˜¾ç¤ºæ–‡æœ¬å’Œ <code>goto</code> è·³è½¬ç›®æ ‡</p>
                <p><code>portrait</code>: NPCç«‹ç»˜æ–‡ä»¶åï¼Œæ”¾åœ¨ <code>images/</code> æ–‡ä»¶å¤¹</p>
                <p><code>background</code>: åœºæ™¯èƒŒæ™¯å›¾ï¼Œæ”¾åœ¨ <code>images/</code> æ–‡ä»¶å¤¹</p>

                <h4>å›¾ç‰‡æ–‡ä»¶</h4>
                <p>å°†ç«‹ç»˜å’ŒèƒŒæ™¯å›¾æ”¾å…¥ <code>images/</code> æ–‡ä»¶å¤¹ï¼Œç„¶ååœ¨ YAML ä¸­å¡«å†™æ–‡ä»¶åå³å¯ã€‚</p>
            </div>
        </div>
    </div>

    <script>
        // ===== State =====
        let gameData = { scenes: [] };
        let currentScene = null;
        let currentNpc = null;
        let currentSection = 'start';
        let dialogIndex = 0;
        let isEditorMode = false;

        // ===== Initialization =====
        function init() {
            loadData();
            renderScenes();
        }

        // ===== Data Management =====
        function loadData() {
            const saved = localStorage.getItem('dialogGameData');
            if (saved) {
                try {
                    gameData = JSON.parse(saved);
                } catch (e) {
                    gameData = { scenes: [] };
                }
            } else {
                // åŠ è½½ç¤ºä¾‹æ•°æ®
                gameData = getExampleData();
                saveData();
            }
        }

        function saveData() {
            localStorage.setItem('dialogGameData', JSON.stringify(gameData));
        }

        function resetData() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†æ¢å¤ä¸ºç¤ºä¾‹æ•°æ®ã€‚')) {
                gameData = getExampleData();
                saveData();
                document.getElementById('yamlEditor').value = jsyaml.dump(gameData, { lineWidth: -1 });
                renderPreview();
                showToast('æ•°æ®å·²é‡ç½®', 'success');
            }
        }

        function getExampleData() {
            return {
                scenes: [
                    {
                        id: 'cafe',
                        name: 'è¡—è§’å’–å•¡é¦†',
                        description: 'ä¸€å®¶æ¸©é¦¨çš„å°å’–å•¡é¦†ï¼Œç©ºæ°”ä¸­å¼¥æ¼«ç€å’–å•¡é¦™æ°”',
                        npcs: [
                            {
                                id: 'anna',
                                name: 'å®‰å¨œ',
                                role: 'å’–å•¡å¸ˆ',
                                portrait: '',
                                dialog: {
                                    start: [
                                        { speaker: 'npc', text: 'æ¬¢è¿æ¥åˆ°è¡—è§’å’–å•¡é¦†ï¼æˆ‘æ˜¯å®‰å¨œï¼Œä»Šå¤©æƒ³å–ç‚¹ä»€ä¹ˆå‘¢ï¼Ÿ' },
                                        { speaker: 'player', choices: [
                                            { text: 'æ¥æ¯æ‹¿é“å§', goto: 'latte' },
                                            { text: 'æœ‰ä»€ä¹ˆæ¨èçš„å—ï¼Ÿ', goto: 'recommend' },
                                            { text: 'æˆ‘åªæ˜¯éšä¾¿çœ‹çœ‹', goto: 'browse' }
                                        ]}
                                    ],
                                    latte: [
                                        { speaker: 'npc', text: 'æ‹¿é“æ˜¯ä¸ªå¥½é€‰æ‹©ï¼ç¨ç­‰ä¸€ä¸‹...' },
                                        { speaker: 'npc', text: 'ç»™æ‚¨ï¼Œè¯·æ…¢ç”¨~ è¿™æ˜¯æˆ‘ä»¬åº—çš„æ‹›ç‰Œæ‹¿é“ï¼Œç”¨çš„æ˜¯ç‰¹é€‰å’–å•¡è±†ã€‚' },
                                        { speaker: 'player', choices: [
                                            { text: 'è°¢è°¢ï¼Œå‘³é“å¾ˆæ£’ï¼', goto: 'end_good' },
                                            { text: 'è¿˜æƒ³å†ç‚¹äº›åˆ«çš„', goto: 'start' }
                                        ]}
                                    ],
                                    recommend: [
                                        { speaker: 'npc', text: 'å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ¥çš„è¯ï¼Œæˆ‘æ¨èæˆ‘ä»¬çš„ç„¦ç³–ç›å¥‡æœµï¼' },
                                        { speaker: 'npc', text: 'ç”œåº¦åˆšåˆšå¥½ï¼Œå¾ˆå¤šå®¢äººéƒ½å¾ˆå–œæ¬¢å‘¢ã€‚' },
                                        { speaker: 'player', choices: [
                                            { text: 'é‚£å°±æ¥ä¸€æ¯å§', goto: 'macchiato' },
                                            { text: 'æˆ‘è¿˜æ˜¯è¦æ‹¿é“', goto: 'latte' }
                                        ]}
                                    ],
                                    macchiato: [
                                        { speaker: 'npc', text: 'å¥½çš„ï¼é©¬ä¸Šä¸ºæ‚¨åˆ¶ä½œ~' },
                                        { speaker: 'npc', text: 'è¿™æ˜¯æ‚¨çš„ç„¦ç³–ç›å¥‡æœµï¼Œä¸Šé¢çš„ç„¦ç³–æ˜¯æˆ‘æ‰‹å·¥åˆ¶ä½œçš„å“¦ï¼' }
                                    ],
                                    browse: [
                                        { speaker: 'npc', text: 'å¥½çš„ï¼Œéšæ—¶å«æˆ‘å°±è¡Œï¼' },
                                        { speaker: 'npc', text: 'å¯¹äº†ï¼Œä»Šå¤©æ–°åˆ°äº†ä¸€æ‰¹ç”œç‚¹ï¼Œæœ‰å…´è¶£å¯ä»¥çœ‹çœ‹~' }
                                    ],
                                    end_good: [
                                        { speaker: 'npc', text: 'è°¢è°¢å¤¸å¥–ï¼æ¬¢è¿ä¸‹æ¬¡å†æ¥å“¦~' }
                                    ]
                                }
                            },
                            {
                                id: 'old_man',
                                name: 'è€å…ˆç”Ÿ',
                                role: 'å¸¸å®¢',
                                portrait: '',
                                dialog: {
                                    start: [
                                        { speaker: 'npc', text: 'å“¦ï¼Œå¹´è½»äººï¼Œåä¸‹æ¥èŠèŠå§ã€‚' },
                                        { speaker: 'npc', text: 'æˆ‘åœ¨è¿™å®¶å’–å•¡é¦†å¾…äº†äºŒåå¹´äº†ï¼Œæœ‰ä»€ä¹ˆæƒ³çŸ¥é“çš„å—ï¼Ÿ' },
                                        { speaker: 'player', choices: [
                                            { text: 'è¿™å®¶åº—æœ‰ä»€ä¹ˆæ•…äº‹å—ï¼Ÿ', goto: 'story' },
                                            { text: 'æ‚¨æ¯å¤©éƒ½æ¥è¿™é‡Œå—ï¼Ÿ', goto: 'daily' },
                                            { text: 'æ‰“æ‰°äº†ï¼Œæˆ‘å…ˆèµ°äº†', goto: 'leave' }
                                        ]}
                                    ],
                                    story: [
                                        { speaker: 'npc', text: 'è¿™å®¶åº—å•Š...æ˜¯äºŒåå¹´å‰ä¸€å¯¹å¹´è½»å¤«å¦»å¼€çš„ã€‚' },
                                        { speaker: 'npc', text: 'ä»–ä»¬æŠŠå…¨éƒ¨å¿ƒè¡€éƒ½æŠ•å…¥åˆ°è¿™é‡Œï¼Œæ¯ä¸€æ¯å’–å•¡éƒ½ç”¨å¿ƒåˆ¶ä½œã€‚' },
                                        { speaker: 'npc', text: 'å®‰å¨œæ˜¯ä»–ä»¬çš„å¥³å„¿ï¼Œç°åœ¨ç»§æ‰¿äº†è¿™ä»½äº‹ä¸šã€‚' }
                                    ],
                                    daily: [
                                        { speaker: 'npc', text: 'æ˜¯å•Šï¼Œæ¯å¤©æ—©ä¸Šä¹ç‚¹å‡†æ—¶æ¥ï¼Œä¸‹åˆä¸‰ç‚¹ç¦»å¼€ã€‚' },
                                        { speaker: 'npc', text: 'è¿™é‡Œçš„å’–å•¡å’Œæ°›å›´ï¼Œå·²ç»æˆä¸ºæˆ‘ç”Ÿæ´»çš„ä¸€éƒ¨åˆ†äº†ã€‚' }
                                    ],
                                    leave: [
                                        { speaker: 'npc', text: 'å¥½çš„ï¼Œæ…¢èµ°ã€‚æœ‰ç©ºå†æ¥èŠã€‚' }
                                    ]
                                }
                            }
                        ]
                    },
                    {
                        id: 'park',
                        name: 'åŸå¸‚å…¬å›­',
                        description: 'ç»¿æ ‘æˆè«çš„åŸå¸‚å…¬å›­ï¼Œæ˜¯å±…æ°‘ä¼‘é—²çš„å¥½å»å¤„',
                        npcs: [
                            {
                                id: 'kid',
                                name: 'å°æ˜',
                                role: 'æ´»æ³¼çš„å°ç”·å­©',
                                portrait: '',
                                dialog: {
                                    start: [
                                        { speaker: 'npc', text: 'å˜¿ï¼ä½ ä¹Ÿæ¥å…¬å›­ç©å—ï¼Ÿ' },
                                        { speaker: 'npc', text: 'æˆ‘åœ¨æ‰¾æˆ‘çš„å°ç‹—ï¼Œå®ƒè·‘ä¸¢äº†...' },
                                        { speaker: 'player', choices: [
                                            { text: 'æˆ‘å¸®ä½ ä¸€èµ·æ‰¾å§', goto: 'help' },
                                            { text: 'å®ƒé•¿ä»€ä¹ˆæ ·ï¼Ÿ', goto: 'describe' },
                                            { text: 'ç¥ä½ å¥½è¿', goto: 'leave' }
                                        ]}
                                    ],
                                    help: [
                                        { speaker: 'npc', text: 'çœŸçš„å—ï¼Ÿå¤ªå¥½äº†ï¼' },
                                        { speaker: 'npc', text: 'å®ƒæ˜¯ä¸€åªæ£•è‰²çš„æŸ¯åŸºï¼Œåå­—å«è±†è±†ï¼' },
                                        { speaker: 'npc', text: 'å®ƒæœ€å–œæ¬¢åœ¨å–·æ³‰é™„è¿‘ç©äº†ã€‚' }
                                    ],
                                    describe: [
                                        { speaker: 'npc', text: 'æ˜¯ä¸€åªæ£•è‰²çš„æŸ¯åŸºçŠ¬ï¼Œè…¿çŸ­çŸ­çš„ç‰¹åˆ«å¯çˆ±ï¼' },
                                        { speaker: 'npc', text: 'å®ƒè„–å­ä¸Šæœ‰ä¸€ä¸ªè“è‰²çš„é¡¹åœˆã€‚' },
                                        { speaker: 'player', choices: [
                                            { text: 'å¥½ï¼Œæˆ‘å¸®ä½ æ‰¾æ‰¾', goto: 'help' },
                                            { text: 'æˆ‘åˆšæ‰å¥½åƒçœ‹åˆ°ä¸€åª', goto: 'seen' }
                                        ]}
                                    ],
                                    seen: [
                                        { speaker: 'npc', text: 'çœŸçš„å—ï¼Ÿåœ¨å“ªé‡Œï¼Ÿï¼' },
                                        { speaker: 'npc', text: 'å¿«å¸¦æˆ‘å»çœ‹çœ‹ï¼' }
                                    ],
                                    leave: [
                                        { speaker: 'npc', text: 'å—¯...å¥½å§ï¼Œè°¢è°¢ä½ ã€‚' }
                                    ]
                                }
                            }
                        ]
                    }
                ]
            };
        }

        // ===== View Management =====
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        function showScenes() {
            currentScene = null;
            currentNpc = null;
            showView('sceneView');
            updateBreadcrumb();
            renderScenes();
        }

        function showNpcs(sceneId) {
            currentScene = gameData.scenes.find(s => s.id === sceneId);
            if (!currentScene) return;
            currentNpc = null;
            showView('npcView');
            updateBreadcrumb();
            renderNpcs();
        }

        // ===== Visual Novel Dialog System =====
        let isTyping = false;
        let currentText = '';
        let typeTimer = null;

        function showDialog(npcId) {
            currentNpc = currentScene.npcs.find(n => n.id === npcId);
            if (!currentNpc) return;
            currentSection = 'start';
            dialogIndex = 0;

            // è®¾ç½®åœºæ™¯èƒŒæ™¯
            const dialogBg = document.getElementById('dialogBg');
            if (currentScene.background) {
                dialogBg.style.backgroundImage = `url('images/${currentScene.background}')`;
            } else {
                dialogBg.style.backgroundImage = 'linear-gradient(135deg, #2a2a3a 0%, #1a1a25 100%)';
            }

            // è®¾ç½®åœºæ™¯åç§°
            document.getElementById('vnSceneName').textContent = currentScene.name;

            // è®¾ç½®NPCç«‹ç»˜
            renderCharacter();

            // æ˜¾ç¤ºå¯¹è¯ç•Œé¢
            showView('dialogView');
            updateBreadcrumb();

            // å¼€å§‹å¯¹è¯
            advanceDialog();
        }

        function renderCharacter() {
            const container = document.getElementById('vnCharacter');
            if (currentNpc.portrait) {
                container.innerHTML = `<img src="images/${currentNpc.portrait}" alt="${currentNpc.name}" onerror="this.parentElement.innerHTML='<div class=\\'vn-character-placeholder\\'>${getInitial(currentNpc.name)}</div>'">`;
            } else {
                container.innerHTML = `<div class="vn-character-placeholder">${getInitial(currentNpc.name)}</div>`;
            }
        }

        function exitDialog() {
            showNpcs(currentScene.id);
        }

        function updateBreadcrumb() {
            const bc = document.getElementById('breadcrumb');
            let html = '<span class="breadcrumb-item" onclick="showScenes()">åœºæ™¯é€‰æ‹©</span>';

            if (currentScene) {
                html += '<span class="breadcrumb-separator">â€º</span>';
                html += `<span class="breadcrumb-item" onclick="showNpcs('${currentScene.id}')">${currentScene.name}</span>`;
            }

            if (currentNpc) {
                html += '<span class="breadcrumb-separator">â€º</span>';
                html += `<span class="breadcrumb-item">${currentNpc.name}</span>`;
            }

            bc.innerHTML = html;
        }

        // ===== Rendering =====
        function renderScenes() {
            const grid = document.getElementById('sceneGrid');
            const empty = document.getElementById('sceneEmpty');

            if (!gameData.scenes || gameData.scenes.length === 0) {
                grid.innerHTML = '';
                empty.style.display = 'block';
                return;
            }

            empty.style.display = 'none';
            grid.innerHTML = gameData.scenes.map(scene => {
                const npcTags = (scene.npcs || []).map(n =>
                    `<span class="scene-card-npc-tag">${n.name}</span>`
                ).join('');

                const bgStyle = scene.background
                    ? `background-image: url('images/${scene.background}')`
                    : '';

                return `
                    <div class="scene-card" onclick="showNpcs('${scene.id}')">
                        <div class="scene-card-bg" style="${bgStyle}"></div>
                        <div class="scene-card-content">
                            <div class="scene-card-title">${scene.name}</div>
                            <div class="scene-card-info">${scene.description || ''}</div>
                            <div class="scene-card-npcs">${npcTags}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderNpcs() {
            const grid = document.getElementById('npcGrid');
            document.getElementById('npcViewTitle').textContent = currentScene.name;
            document.getElementById('npcViewDesc').textContent = currentScene.description || 'é€‰æ‹©ä¸€ä¸ªè§’è‰²å¼€å§‹å¯¹è¯';

            grid.innerHTML = (currentScene.npcs || []).map(npc => {
                const portraitContent = npc.portrait
                    ? `<img src="images/${npc.portrait}" alt="${npc.name}" onerror="this.parentElement.innerHTML='${getInitial(npc.name)}'">`
                    : getInitial(npc.name);

                return `
                    <div class="npc-card" onclick="showDialog('${npc.id}')">
                        <div class="npc-portrait">${portraitContent}</div>
                        <div class="npc-name">${npc.name}</div>
                        <div class="npc-role">${npc.role || ''}</div>
                    </div>
                `;
            }).join('');
        }

        function advanceDialog() {
            const dialog = currentNpc.dialog?.[currentSection];
            if (!dialog || dialogIndex >= dialog.length) {
                showDialogEnd();
                return;
            }

            const line = dialog[dialogIndex];
            dialogIndex++;

            if (line.speaker === 'player' && line.choices) {
                showChoices(line.choices);
            } else {
                showText(line);
            }
        }

        function showText(line) {
            const isNpc = line.speaker === 'npc';
            const speakerName = isNpc ? currentNpc.name : 'ä½ ';

            // æ›´æ–°è¯´è¯è€…åå­—
            const speakerEl = document.getElementById('vnSpeaker');
            speakerEl.textContent = speakerName;
            speakerEl.className = 'vn-speaker' + (isNpc ? '' : ' player');

            // éšè—é€‰é¡¹ï¼Œæ˜¾ç¤ºå¯¹è¯æ¡†
            document.getElementById('vnChoices').style.display = 'none';
            document.getElementById('vnTextbox').style.display = 'block';
            document.getElementById('vnContinue').style.display = 'block';

            // æ‰“å­—æœºæ•ˆæœ
            const textEl = document.getElementById('vnText');
            currentText = line.text;
            isTyping = true;
            textEl.textContent = '';
            textEl.classList.add('typing');

            let charIndex = 0;
            const typeSpeed = 30;

            clearInterval(typeTimer);
            typeTimer = setInterval(() => {
                if (charIndex < currentText.length) {
                    textEl.textContent += currentText[charIndex];
                    charIndex++;
                } else {
                    clearInterval(typeTimer);
                    isTyping = false;
                    textEl.classList.remove('typing');
                }
            }, typeSpeed);
        }

        function handleTextboxClick() {
            if (isTyping) {
                clearInterval(typeTimer);
                document.getElementById('vnText').textContent = currentText;
                document.getElementById('vnText').classList.remove('typing');
                isTyping = false;
            } else {
                const dialog = currentNpc.dialog?.[currentSection];
                if (dialog && dialogIndex < dialog.length) {
                    const next = dialog[dialogIndex];
                    if (next.speaker === 'player' && next.choices) {
                        dialogIndex++;
                        showChoices(next.choices);
                    } else {
                        advanceDialog();
                    }
                } else {
                    showDialogEnd();
                }
            }
        }

        function showChoices(choices) {
            document.getElementById('vnTextbox').style.display = 'none';
            const container = document.getElementById('vnChoices');

            container.innerHTML = choices.map(c =>
                `<button class="vn-choice-btn" onclick="selectChoice('${c.goto}', '${c.text.replace(/'/g, "\\'")}')">${c.text}</button>`
            ).join('');

            container.style.display = 'flex';
        }

        function selectChoice(goto, choiceText) {
            document.getElementById('vnChoices').style.display = 'none';

            if (goto && currentNpc.dialog?.[goto]) {
                currentSection = goto;
                dialogIndex = 0;
                showText({ speaker: 'player', text: choiceText });
                setTimeout(() => {
                    if (!isTyping) advanceDialog();
                }, 800);
            } else {
                showDialogEnd();
            }
        }

        function showDialogEnd() {
            document.getElementById('vnTextbox').style.display = 'none';
            document.getElementById('vnChoices').innerHTML = `
                <div class="vn-end">
                    <div class="vn-end-text">â€” å¯¹è¯ç»“æŸ â€”</div>
                    <div class="vn-end-buttons">
                        <button class="vn-end-btn" onclick="restartDialog()">é‡æ–°å¼€å§‹</button>
                        <button class="vn-end-btn" onclick="exitDialog()">è¿”å›åœºæ™¯</button>
                    </div>
                </div>
            `;
            document.getElementById('vnChoices').style.display = 'flex';
        }

        function restartDialog() {
            currentSection = 'start';
            dialogIndex = 0;
            document.getElementById('vnChoices').style.display = 'none';
            document.getElementById('vnTextbox').style.display = 'block';
            advanceDialog();
        }

        // ===== Editor =====
        function toggleEditor() {
            isEditorMode = !isEditorMode;
            const btn = document.getElementById('editToggle');

            if (isEditorMode) {
                btn.classList.add('btn-primary');
                btn.innerHTML = '<span>âœ“</span> é€€å‡ºç¼–è¾‘';
                showView('editorView');
                document.getElementById('yamlEditor').value = jsyaml.dump(gameData, { lineWidth: -1 });
                renderPreview();
            } else {
                btn.classList.remove('btn-primary');
                btn.innerHTML = '<span>âœ</span> ç¼–è¾‘æ¨¡å¼';
                showScenes();
            }
        }

        function saveAndPreview() {
            const yaml = document.getElementById('yamlEditor').value;
            const preview = document.getElementById('previewContent');

            try {
                const parsed = jsyaml.load(yaml);
                if (!parsed || !parsed.scenes) {
                    throw new Error('æ•°æ®æ ¼å¼é”™è¯¯ï¼šéœ€è¦åŒ…å« scenes æ•°ç»„');
                }

                gameData = parsed;
                saveData();
                renderPreview();
                showToast('ä¿å­˜æˆåŠŸï¼', 'success');
            } catch (e) {
                preview.innerHTML = `
                    <div class="error-container">
                        <div class="error-title">âš  YAML è§£æé”™è¯¯</div>
                        <div class="error-message">${e.message}</div>
                    </div>
                `;
            }
        }

        function renderPreview() {
            const preview = document.getElementById('previewContent');

            if (!gameData.scenes || gameData.scenes.length === 0) {
                preview.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“</div>
                        <div class="empty-state-title">æš‚æ— æ•°æ®</div>
                        <p>æ·»åŠ åœºæ™¯å’Œ NPC å¯¹è¯æ•°æ®</p>
                    </div>
                `;
                return;
            }

            let html = '<h3 style="color: var(--accent-gold); margin-bottom: 1rem;">æ•°æ®é¢„è§ˆ</h3>';

            gameData.scenes.forEach(scene => {
                html += `
                    <div style="background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <div style="font-weight: 600; color: var(--accent-gold-light); margin-bottom: 0.5rem;">
                            ğŸ  ${scene.name}
                        </div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.8rem;">
                            ${scene.description || ''}
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            ${(scene.npcs || []).map(n => `
                                <span style="padding: 0.3rem 0.8rem; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 20px; font-size: 0.8rem;">
                                    ${n.name} (${Object.keys(n.dialog || {}).length} ä¸ªå¯¹è¯èŠ‚ç‚¹)
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            preview.innerHTML = html;
        }

        // ===== Help Modal =====
        function showHelp() {
            document.getElementById('helpModal').classList.add('active');
        }

        function closeHelp() {
            document.getElementById('helpModal').classList.remove('active');
        }

        // ===== Utilities =====
        function getInitial(name) {
            return name ? name.charAt(0) : '?';
        }

        function showToast(message, type = 'info') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span>${type === 'success' ? 'âœ“' : type === 'error' ? 'âœ—' : 'â„¹'}</span>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);

            setTimeout(() => toast.remove(), 3000);
        }

        // Click outside modal to close
        document.getElementById('helpModal').addEventListener('click', function(e) {
            if (e.target === this) closeHelp();
        });

        // Initialize
        init();
    </script>
</body>
</html>
