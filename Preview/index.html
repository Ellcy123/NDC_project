<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NDC 剧情预览器</title>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* 顶部控制栏 */
        .header {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            color: #ffd700;
            margin-bottom: 15px;
            font-size: 24px;
        }

        .controls {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            color: #aaa;
            font-size: 14px;
        }

        select {
            padding: 8px 15px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: #2a2a3e;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
        }

        select:hover {
            border-color: #ffd700;
        }

        select option {
            background: #2a2a3e;
            color: #fff;
            padding: 8px;
        }

        select option:hover,
        select option:checked {
            background: #3a3a5e;
        }

        .view-toggle {
            display: flex;
            gap: 5px;
            margin-left: auto;
        }

        .view-btn {
            padding: 8px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: transparent;
            color: #aaa;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .view-btn.active {
            background: #ffd700;
            color: #1a1a2e;
            border-color: #ffd700;
        }

        .view-btn:hover:not(.active) {
            border-color: #ffd700;
            color: #ffd700;
        }

        /* 编辑模式样式 */
        .edit-mode .dialog-node {
            cursor: pointer;
            transition: all 0.3s;
        }

        .edit-mode .dialog-node:hover {
            background: rgba(255, 215, 0, 0.2) !important;
            border-left: 3px solid #ffd700 !important;
            padding-left: 17px;
        }

        .dialog-node.edited {
            border-left: 3px solid #2ecc71 !important;
        }

        /* 编辑弹窗 */
        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .edit-modal.active {
            display: flex;
        }

        .edit-modal-content {
            background: #2a2a3e;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .edit-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .edit-modal-header h3 {
            color: #ffd700;
            font-size: 18px;
            margin: 0;
        }

        .edit-close-btn {
            background: none;
            border: none;
            color: #aaa;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 1;
            transition: all 0.3s;
        }

        .edit-close-btn:hover {
            color: #fff;
            transform: rotate(90deg);
        }

        .edit-field {
            margin-bottom: 20px;
        }

        .edit-field label {
            display: block;
            color: #aaa;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .edit-field input,
        .edit-field textarea {
            width: 100%;
            padding: 10px;
            background: #1a1a2e;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #fff;
            font-family: 'Microsoft YaHei', sans-serif;
            font-size: 14px;
            transition: all 0.3s;
        }

        .edit-field input:focus,
        .edit-field textarea:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
        }

        .edit-field textarea {
            min-height: 120px;
            resize: vertical;
            line-height: 1.6;
        }

        .edit-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        .edit-save-btn,
        .edit-cancel-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .edit-save-btn {
            background: #2ecc71;
            color: #fff;
        }

        .edit-save-btn:hover {
            background: #27ae60;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
        }

        .edit-cancel-btn {
            background: rgba(255, 255, 255, 0.1);
            color: #aaa;
        }

        .edit-cancel-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }

        /* 循环信息 */
        .loop-info {
            background: rgba(255, 215, 0, 0.2) !important;
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .loop-info h2 {
            color: #ffd700;
            font-size: 18px;
            margin-bottom: 8px;
        }

        .loop-info p {
            color: #ccc;
            font-size: 14px;
        }

        /* 阶段标签 */
        .phase-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .phase-tab {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #aaa;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .phase-tab:hover {
            border-color: #ffd700;
            color: #ffd700;
        }

        .phase-tab.active {
            background: rgba(255, 215, 0, 0.2);
            border-color: #ffd700;
            color: #ffd700;
        }

        /* 标签分隔符 */
        .tab-divider {
            width: 1px;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            margin: 0 10px;
        }

        /* 参考资料标签（NPC档案等） */
        .phase-tab.reference-tab {
            background: rgba(52, 152, 219, 0.1);
            border-color: rgba(52, 152, 219, 0.3);
            color: #3498db;
        }

        .phase-tab.reference-tab:hover {
            border-color: #3498db;
            color: #3498db;
        }

        .phase-tab.reference-tab.active {
            background: rgba(52, 152, 219, 0.2);
            border-color: #3498db;
            color: #3498db;
        }

        /* 主内容区 */
        .main-content {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 500px;
        }

        /* 开篇/结尾对话样式 */
        .dialog-section {
            margin-bottom: 30px;
        }

        .scene-header {
            background: rgba(255, 215, 0, 0.2) !important;
            padding: 12px 18px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #ffd700;
        }

        .scene-header h3 {
            color: #ffd700;
            font-size: 16px;
        }

        .scene-header p {
            color: #999;
            font-size: 13px;
            margin-top: 5px;
        }

        .dialog-node {
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 8px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dialog-node.narration {
            background: rgba(100, 100, 100, 0.2);
            color: #aaa;
            font-style: italic;
            text-align: center;
        }

        .dialog-node.speaker {
            background: rgba(255, 255, 255, 0.08);
        }

        .dialog-node .speaker-name {
            color: #4ecdc4;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }

        /* 按角色名 */
        .dialog-node .speaker-name.zack { color: #5dade2; }
        .dialog-node .speaker-name.emma { color: #f39c12; }
        .dialog-node .speaker-name.rosa { color: #e74c3c; }
        .dialog-node .speaker-name.tommy { color: #27ae60; }
        .dialog-node .speaker-name.morrison { color: #8e44ad; }
        /* 按NPC ID - 第1章 */
        .dialog-node .speaker-name.npc101 { color: #5dade2; }  /* Zack 扎克 */
        .dialog-node .speaker-name.npc102 { color: #f39c12; }  /* Emma 艾玛 */
        .dialog-node .speaker-name.npc103 { color: #e74c3c; }  /* Rosa 罗莎 */
        .dialog-node .speaker-name.npc104 { color: #8e44ad; }  /* Morrison 莫里森 */
        .dialog-node .speaker-name.npc105 { color: #27ae60; }  /* Tommy 汤米 */
        .dialog-node .speaker-name.npc106 { color: #e67e22; }  /* Jimmy 吉米 */
        .dialog-node .speaker-name.npc107 { color: #1abc9c; }  /* Coleman 科尔曼 */
        .dialog-node .speaker-name.npc108 { color: #9b59b6; }  /* Vivian 薇薇安 */
        .dialog-node .speaker-name.npc109 { color: #3498db; }  /* Webb 韦伯 */
        .dialog-node .speaker-name.npc110 { color: #e91e63; }  /* Morrison太太 */

        .dialog-node .emotion {
            color: #888;
            font-size: 12px;
            margin-left: 8px;
        }

        .dialog-node .text {
            color: #e0e0e0;
            line-height: 1.6;
        }

        .dialog-node .action {
            color: #888;
            font-size: 13px;
            margin-top: 5px;
            font-style: italic;
        }

        .dialog-node.branch {
            background: transparent;
            border: none;
        }

        .branch-option {
            padding: 8px 12px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            color: #ccc;
            border-left: 3px solid #888;
        }

        .branch-option.important {
            border-left-color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        /* 分支选项按钮样式 */
        .branch-option-btn {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 12px 16px;
            margin: 6px 0;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-left: 3px solid #3498db;
            border-radius: 6px;
            color: #ccc;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            font-size: 14px;
        }

        .branch-option-btn:hover {
            background: rgba(52, 152, 219, 0.15);
            border-color: #3498db;
            color: #fff;
            transform: translateX(5px);
        }

        .branch-option-btn.important {
            border-left-color: #e74c3c;
            background: rgba(231, 76, 60, 0.08);
        }

        .branch-option-btn.important:hover {
            background: rgba(231, 76, 60, 0.2);
            border-color: #e74c3c;
        }

        .branch-option-btn.active {
            background: rgba(52, 152, 219, 0.2);
            border-color: #3498db;
            color: #3498db;
        }

        .branch-option-btn .branch-arrow {
            color: #666;
            transition: all 0.3s;
        }

        .branch-option-btn:hover .branch-arrow {
            color: #3498db;
            transform: translateX(3px);
        }

        /* 分支展开内容 */
        .branch-content {
            margin: 10px 0 10px 15px;
            padding: 12px 15px;
            background: transparent;
            border-left: 2px solid rgba(52, 152, 219, 0.4);
            border-radius: 0;
            animation: fadeSlideIn 0.3s ease;
        }

        .branch-content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px dashed rgba(52, 152, 219, 0.3);
        }

        .branch-path-label {
            color: #3498db;
            font-size: 12px;
            font-weight: normal;
            opacity: 0.8;
        }

        .branch-content-nodes {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .branch-content-nodes .dialog-node {
            margin: 0;
        }

        /* 嵌套分支的样式调整 */
        .branch-content .dialog-node.branch {
            background: transparent;
            border: none;
        }

        /* 自由环节样式 */
        .free-phase-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* 场景按钮列表 */
        .scene-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .scene-btn {
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #ccc;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .scene-btn:hover {
            border-color: #ffd700;
            color: #ffd700;
            transform: translateY(-2px);
        }

        .scene-btn.active {
            background: rgba(255, 215, 0, 0.15);
            border-color: #ffd700;
            color: #ffd700;
        }

        .scene-btn .scene-icon {
            font-size: 16px;
        }

        .scene-btn .scene-name {
            font-weight: bold;
        }

        .scene-btn .scene-badge {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 5px;
        }

        .scene-btn .scene-badge.search {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .scene-btn .scene-badge.npc {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }

        .scene-btn.locked {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: rgba(231, 76, 60, 0.3);
        }

        .scene-btn.locked:hover {
            background: rgba(255, 255, 255, 0.03);
            transform: none;
        }

        .scene-btn .scene-badge.locked {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        /* 场景卡片网格布局 */
        .scene-cards-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* 场景卡片 */
        .scene-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }

        .scene-card:hover {
            border-color: rgba(255, 215, 0, 0.4);
        }

        .scene-card.highlight {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            animation: cardHighlight 1.5s ease;
        }

        @keyframes cardHighlight {
            0% { box-shadow: 0 0 0 rgba(255, 215, 0, 0); }
            30% { box-shadow: 0 0 25px rgba(255, 215, 0, 0.5); }
            100% { box-shadow: 0 0 0 rgba(255, 215, 0, 0); }
        }

        .scene-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .scene-card-icon {
            font-size: 24px;
        }

        .scene-card-title {
            flex: 1;
        }

        .scene-card-title h4 {
            color: #ffd700;
            font-size: 16px;
            margin-bottom: 3px;
        }

        .scene-card-id {
            color: #666;
            font-size: 12px;
        }

        .scene-card-note {
            color: #888;
            font-size: 13px;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
        }

        /* 场景详情面板（流程版点击后显示） */
        .scene-detail-panel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .scene-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .scene-detail-header h3 {
            color: #ffd700;
            font-size: 18px;
        }

        .scene-detail-header .scene-type-badge {
            padding: 5px 12px;
            border-radius: 5px;
            font-size: 12px;
        }

        .scene-type-badge.search {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .scene-type-badge.npc {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }

        .scene-npc-info {
            background: rgba(52, 152, 219, 0.1);
            border-left: 3px solid #3498db;
            padding: 12px 15px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 20px;
            color: #3498db;
        }

        /* 证据列表 - 可点击展开 */
        .evidence-list {
            margin-top: 15px;
        }

        .evidence-list.hidden {
            display: none;
        }

        .evidence-list.fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .evidence-list-header {
            color: #4ecdc4;
            font-size: 14px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .evidence-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin: 8px 0;
            overflow: hidden;
            transition: all 0.3s;
        }

        .evidence-card:hover {
            border-color: #4ecdc4;
        }

        .evidence-card-header {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            gap: 12px;
        }

        .evidence-card-header .ev-icon {
            width: 32px;
            height: 32px;
            background: rgba(78, 205, 196, 0.2);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4ecdc4;
            font-size: 14px;
            flex-shrink: 0;
        }

        .evidence-card-header .ev-info {
            flex: 1;
        }

        .evidence-card-header .ev-name {
            color: #e0e0e0;
            font-size: 14px;
            font-weight: bold;
        }

        .evidence-card-header .ev-id {
            color: #666;
            font-size: 11px;
        }

        .evidence-card-header .ev-type {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 500;
        }

        .evidence-card-header .ev-type.item {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .evidence-card-header .ev-type.clue {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }

        .evidence-card-header .ev-type.envir {
            background: rgba(243, 156, 18, 0.2);
            color: #f39c12;
        }

        .evidence-card-header .ev-expand {
            color: #666;
            font-size: 12px;
            transition: transform 0.3s;
        }

        .evidence-card.expanded .ev-expand {
            transform: rotate(180deg);
        }

        .evidence-card-body {
            display: none;
            padding: 0 15px 15px 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .evidence-card.expanded .evidence-card-body {
            display: block;
        }

        .ev-description {
            background: rgba(78, 205, 196, 0.1);
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
        }

        .ev-description .desc-label {
            color: #4ecdc4;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .ev-description .desc-text {
            color: #ccc;
            font-size: 13px;
            line-height: 1.6;
        }

        .ev-hint {
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
        }

        .ev-hint.puzzle {
            background: rgba(243, 156, 18, 0.1);
            color: #f39c12;
        }

        .ev-hint.requires {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }

        .ev-hint.location {
            background: rgba(52, 152, 219, 0.1);
            color: #3498db;
        }

        /* 分析按钮 */
        .analyze-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed rgba(255, 255, 255, 0.1);
        }

        .analyze-btn {
            padding: 8px 16px;
            background: rgba(155, 89, 182, 0.2);
            border: 1px solid rgba(155, 89, 182, 0.4);
            border-radius: 5px;
            color: #9b59b6;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .analyze-btn:hover {
            background: rgba(155, 89, 182, 0.3);
            border-color: #9b59b6;
        }

        .analyze-btn.analyzed {
            background: rgba(46, 204, 113, 0.2);
            border-color: rgba(46, 204, 113, 0.4);
            color: #2ecc71;
        }

        .analyzed-result {
            display: none;
            margin-top: 12px;
            background: rgba(155, 89, 182, 0.1);
            border-radius: 6px;
            padding: 12px;
            animation: fadeIn 0.3s ease;
        }

        .analyzed-result.visible {
            display: block;
        }

        .analyzed-result .result-label {
            color: #9b59b6;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .analyzed-result .result-text {
            color: #ccc;
            font-size: 13px;
            line-height: 1.6;
        }

        /* 对话展开区域 */
        .scene-dialog-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dialog-toggle-btn {
            padding: 10px 20px;
            background: rgba(52, 152, 219, 0.15);
            border: 1px solid rgba(52, 152, 219, 0.3);
            border-radius: 6px;
            color: #3498db;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            width: 100%;
            text-align: center;
        }

        .dialog-toggle-btn:hover {
            background: rgba(52, 152, 219, 0.25);
            border-color: #3498db;
        }

        .scene-dialog-content {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
        }

        .scene-dialog-content.visible {
            display: block;
        }

        /* 流程版对话逐条展开样式 */
        .dialog-flow-container {
            padding: 15px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
        }

        .dialog-flow-node {
            display: none;
        }

        .dialog-flow-node.visible {
            display: block;
            animation: fadeSlideIn 0.3s ease;
        }

        @keyframes fadeSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dialog-next-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: rgba(52, 152, 219, 0.1);
            border: 1px dashed rgba(52, 152, 219, 0.4);
            border-radius: 6px;
            color: #3498db;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            text-align: center;
        }

        .dialog-next-btn:hover {
            background: rgba(52, 152, 219, 0.2);
            border-style: solid;
            border-color: #3498db;
        }

        .dialog-next-btn.hidden {
            display: none;
        }

        /* 无场景选中提示 */
        .no-scene-hint {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .no-scene-hint .hint-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .no-scene-hint p {
            font-size: 14px;
        }

        /* 指证环节样式 */
        .expose-section {
            margin-bottom: 25px;
        }

        .expose-extra-section {
            background: rgba(155, 89, 182, 0.1);
            border: 1px solid rgba(155, 89, 182, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 25px;
        }

        .extra-section-header {
            color: #9b59b6;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(155, 89, 182, 0.3);
        }

        .round-dialogs {
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid rgba(52, 152, 219, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .round-dialogs .dialog-nodes {
            max-height: 400px;
            overflow-y: auto;
        }

        .expose-extra-buttons {
            margin-bottom: 15px;
        }

        .expose-extra-btn {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 12px 20px;
            background: rgba(155, 89, 182, 0.15);
            border: 1px solid rgba(155, 89, 182, 0.4);
            border-radius: 8px;
            color: #9b59b6;
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .expose-extra-btn:hover {
            background: rgba(155, 89, 182, 0.25);
        }

        .expose-extra-btn.ending-btn {
            background: rgba(46, 204, 113, 0.15);
            border-color: rgba(46, 204, 113, 0.4);
            color: #2ecc71;
        }

        .expose-extra-btn.ending-btn:hover {
            background: rgba(46, 204, 113, 0.25);
        }

        .expose-extra-content {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .sequential-dialog {
            margin-bottom: 10px;
        }

        .sequential-line {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .next-line-btn {
            display: block;
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .next-line-btn:hover {
            background: linear-gradient(135deg, #2980b9, #1f5f89);
            transform: scale(1.02);
        }

        .opening-section {
            background: rgba(241, 196, 15, 0.1);
            border-color: rgba(241, 196, 15, 0.3);
            margin-bottom: 20px;
        }

        .opening-section .extra-section-header {
            color: #f1c40f;
            border-bottom-color: rgba(241, 196, 15, 0.3);
        }

        .expose-header {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .expose-header h3 {
            color: #e74c3c;
            margin-bottom: 10px;
        }

        .expose-header .target-info {
            color: #ccc;
            font-size: 14px;
        }

        .expose-round {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .round-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .round-number {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .round-title {
            color: #e74c3c;
            font-size: 16px;
        }

        .round-duration {
            color: #888;
            font-size: 12px;
            margin-left: auto;
        }

        .lie-box {
            background: rgba(231, 76, 60, 0.1);
            border-left: 4px solid #e74c3c;
            padding: 12px 15px;
            margin-bottom: 15px;
            border-radius: 0 6px 6px 0;
        }

        .lie-box .label {
            color: #e74c3c;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .lie-box .content {
            color: #e0e0e0;
            font-size: 14px;
            line-height: 1.5;
        }

        .evidence-box {
            background: rgba(78, 205, 196, 0.1);
            border-left: 4px solid #4ecdc4;
            padding: 12px 15px;
            margin-bottom: 15px;
            border-radius: 0 6px 6px 0;
        }

        .evidence-box .label {
            color: #4ecdc4;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .evidence-box .content {
            color: #e0e0e0;
            font-size: 14px;
        }

        .dialog-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .dialog-box .speaker-tag {
            color: #5dade2;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .dialog-box .speaker-tag.rosa {
            color: #e74c3c;
        }

        .dialog-box .dialog-text {
            color: #e0e0e0;
            line-height: 1.7;
            white-space: pre-line;
        }

        .dialog-box .emotion-tag {
            display: inline-block;
            padding: 2px 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            font-size: 12px;
            color: #888;
            margin-left: 10px;
        }

        .result-box {
            background: rgba(46, 204, 113, 0.1);
            border-left: 4px solid #2ecc71;
            padding: 12px 15px;
            border-radius: 0 6px 6px 0;
        }

        .result-box .label {
            color: #2ecc71;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .result-box .content {
            color: #e0e0e0;
            font-size: 14px;
        }

        /* 加载状态 */
        .loading {
            text-align: center;
            padding: 50px;
            color: #888;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ffd700;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 错误提示 */
        .error-box {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .error-box h3 {
            color: #e74c3c;
            margin-bottom: 10px;
        }

        .error-box p {
            color: #ccc;
        }

        /* 缺失内容提示框 */
        .missing-content-box {
            background: rgba(255, 152, 0, 0.1);
            border: 2px dashed rgba(255, 152, 0, 0.4);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
        }

        .missing-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .missing-content-box h3 {
            color: #ff9800;
            margin: 10px 0;
            font-size: 18px;
        }

        .missing-reason {
            color: #ccc;
            font-size: 14px;
            line-height: 1.6;
            margin: 15px 0;
        }

        .inherited-info {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 152, 0, 0.05);
            border-radius: 6px;
            font-size: 13px;
        }

        .inherited-label {
            color: #ff9800;
            font-weight: bold;
        }

        .inherited-source {
            color: #ffd54f;
            font-family: 'Courier New', monospace;
            margin-left: 5px;
        }

        /* 下一循环提示框 */
        .next-loop-hint {
            margin-top: 20px;
            padding: 15px 20px;
            background: rgba(33, 150, 243, 0.1);
            border-left: 4px solid #2196f3;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .hint-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .hint-content {
            color: #ccc;
            font-size: 14px;
            line-height: 1.5;
        }

        .hint-content strong {
            color: #64b5f6;
        }

        /* 场景对话展开 */
        .scene-dialog-content {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .collapse-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            color: #aaa;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s;
        }

        .collapse-btn:hover {
            border-color: #ffd700;
            color: #ffd700;
        }

        /* NPC信息样式 */
        .npc-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .npc-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
        }

        .npc-card:hover {
            border-color: #3498db;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .npc-card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .npc-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            font-weight: bold;
        }

        .npc-card-title h4 {
            color: #3498db;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .npc-card-title .npc-role {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        .npc-role.suspect {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        .npc-role.witness {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .npc-role.protagonist {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }

        .npc-role.partner {
            background: rgba(243, 156, 18, 0.2);
            color: #f39c12;
        }

        .npc-role.victim {
            background: rgba(155, 89, 182, 0.2);
            color: #9b59b6;
        }

        .npc-info-section {
            margin-bottom: 15px;
        }

        .npc-info-section h5 {
            color: #ffd700;
            font-size: 13px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .npc-info-section h5::before {
            content: '';
            width: 3px;
            height: 14px;
            background: #ffd700;
            border-radius: 2px;
        }

        .info-table {
            width: 100%;
        }

        .info-row {
            display: flex;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #888;
            font-size: 13px;
            min-width: 100px;
            flex-shrink: 0;
        }

        .info-value {
            color: #e0e0e0;
            font-size: 13px;
            line-height: 1.5;
        }

        .info-value.highlight {
            color: #4ecdc4;
        }

        .info-value.warning {
            color: #e74c3c;
        }

        .testimony-list {
            margin-top: 10px;
        }

        .testimony-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 10px 12px;
            border-radius: 6px;
            margin: 6px 0;
            border-left: 3px solid #e74c3c;
            color: #ccc;
            font-size: 13px;
            line-height: 1.5;
        }

        .testimony-item::before {
            content: '"';
            color: #e74c3c;
            font-size: 18px;
            margin-right: 5px;
        }

        .testimony-item::after {
            content: '"';
            color: #e74c3c;
            font-size: 18px;
            margin-left: 5px;
        }

        .no-info-hint {
            color: #666;
            font-size: 13px;
            font-style: italic;
            padding: 10px;
            text-align: center;
        }

        /* 流程版开篇/结尾样式 */
        .opening-scene-buttons,
        .ending-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .opening-scene-btn,
        .ending-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: rgba(255, 215, 0, 0.2) !important;
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            color: #ffd700;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .opening-scene-btn:hover,
        .ending-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            border-color: #ffd700;
        }

        .opening-scene-btn.active,
        .ending-btn.active {
            background: rgba(255, 215, 0, 0.25);
            border-color: #ffd700;
        }

        .opening-scene-btn .scene-arrow,
        .ending-btn .ending-arrow {
            transition: transform 0.3s;
            margin-left: auto;
        }

        .opening-scene-btn.active .scene-arrow,
        .ending-btn.active .ending-arrow {
            transform: rotate(180deg);
        }

        .opening-scene-content,
        .ending-dialog-content {
            animation: slideIn 0.3s ease;
        }

        /* 流程版指证样式 */
        .expose-rounds-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .expose-round-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            width: 100%;
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
            border-radius: 8px;
            color: #e74c3c;
            cursor: pointer;
            transition: all 0.3s;
        }

        .expose-round-btn:hover {
            background: rgba(231, 76, 60, 0.2);
            border-color: #e74c3c;
        }

        .expose-round-btn.active {
            background: rgba(231, 76, 60, 0.25);
            border-color: #e74c3c;
        }

        .expose-round-btn .round-num {
            width: 28px;
            height: 28px;
            background: #e74c3c;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .expose-round-btn .round-arrow {
            transition: transform 0.3s;
        }

        .expose-round-btn.active .round-arrow {
            transform: rotate(180deg);
        }

        .expose-round-flow {
            animation: slideIn 0.3s ease;
        }

        .flow-step {
            margin: 10px 0;
        }

        .flow-step-btn {
            width: 100%;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px dashed rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #aaa;
            cursor: pointer;
            text-align: left;
            font-size: 14px;
            transition: all 0.3s;
        }

        .flow-step-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.4);
            color: #fff;
        }

        .flow-step-content {
            animation: fadeIn 0.3s ease;
        }

        /* 场景总览样式 */
        .scenes-overview-container {
            padding: 20px;
        }

        .scenes-overview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .scenes-overview-header h3 {
            color: #ffd700;
            font-size: 20px;
        }

        .scenes-stats {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .stat-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .stat-badge.accessible {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        .stat-badge.locked {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .stat-badge.story {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }

        .stat-badge.hidden {
            background: rgba(149, 165, 166, 0.2);
            color: #95a5a6;
            border: 1px solid rgba(149, 165, 166, 0.3);
        }

        .scenes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .scene-overview-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .scene-overview-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .scene-overview-card.accessible {
            border-left: 3px solid #2ecc71 !important;
        }

        .scene-overview-card.locked {
            border-left: 3px solid #e74c3c;
            opacity: 0.8;
        }

        .scene-overview-card.hidden {
            border-left: 3px solid #95a5a6;
            opacity: 0.6;
        }

        .scene-overview-card.story_only {
            border-left: 3px solid #3498db;
        }

        .scene-overview-header {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 10px;
        }

        .scene-status-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .scene-overview-title {
            flex: 1;
        }

        .scene-overview-title h4 {
            color: #fff;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .scene-overview-title .scene-id {
            color: #888;
            font-size: 11px;
            font-family: monospace;
        }

        .scene-type-icon {
            font-size: 16px;
            opacity: 0.7;
        }

        .scene-overview-body {
            margin-bottom: 12px;
        }

        .scene-overview-body .scene-desc {
            color: #aaa;
            font-size: 12px;
            line-height: 1.5;
            margin-bottom: 5px;
        }

        .scene-overview-body .scene-note {
            color: #4ecdc4;
            font-size: 11px;
            font-style: italic;
        }

        .scene-overview-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-label {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 4px;
        }

        .status-label.accessible {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .status-label.locked {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        .status-label.hidden {
            background: rgba(149, 165, 166, 0.2);
            color: #95a5a6;
        }

        .status-label.story_only {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }

        .type-label {
            font-size: 11px;
            color: #888;
        }

        /* 响应式 */
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .view-toggle {
                margin-left: 0;
                margin-top: 10px;
            }

            .free-phase-grid {
                grid-template-columns: 1fr;
            }

            .scenes-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>NDC 剧情预览器</h1>
            <div class="controls">
                <div class="control-group">
                    <label>章节:</label>
                    <select id="unitSelect">
                        <option value="">加载中...</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>循环:</label>
                    <select id="loopSelect">
                        <option value="">请先选择章节</option>
                    </select>
                </div>
                <div class="view-toggle">
                    <button class="view-btn active" data-view="full">开发版</button>
                    <button class="view-btn" data-view="flow">体验版</button>
                    <button class="view-btn" id="editModeBtn" style="background: rgba(52, 152, 219, 0.2); color: #3498db; margin-left: 15px;">✏️ 编辑</button>
                    <button class="view-btn" id="exportBtn" style="background: rgba(46, 204, 113, 0.2); color: #2ecc71;">📥 导出</button>
                </div>
            </div>
        </div>

        <div class="loop-info" id="loopInfo" style="display: none;">
            <h2 id="loopTitle"></h2>
            <p id="loopObjective"></p>
        </div>

        <div class="phase-tabs" id="phaseTabs">
            <button class="phase-tab active" data-phase="opening">开篇</button>
            <button class="phase-tab" data-phase="free">自由环节</button>
            <button class="phase-tab" data-phase="expose">指证</button>
            <button class="phase-tab" data-phase="ending">结尾</button>
            <span class="tab-divider"></span>
            <button class="phase-tab reference-tab" data-phase="scenes">场景总览</button>
            <button class="phase-tab reference-tab" data-phase="npcinfo">NPC档案</button>
        </div>

        <div class="main-content" id="mainContent">
            <div class="loading">请选择章节和循环</div>
        </div>

    </div>

    <script>
        // 全局状态
        const state = {
            index: null,
            currentUnit: null,
            currentLoop: null,
            loopData: null,
            dialogs: {},
            masterData: {
                scenes: null,
                npcs: null,
                evidences: null
            },
            currentPhase: 'opening',
            viewMode: 'full', // 'full' or 'flow'
            flowIndex: 0,
            flowNodes: [],
            currentDialogData: null // 当前正在查看的对话数据（供分支展开使用）
        };

        // 基础路径
        const BASE_PATH = 'data/';

        // 加载YAML文件
        async function loadYaml(path) {
            try {
                const response = await fetch(BASE_PATH + path);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const text = await response.text();
                return jsyaml.load(text);
            } catch (error) {
                console.error(`加载 ${path} 失败:`, error);
                return null;
            }
        }

        // 获取NPC显示名称
        function getNpcDisplayName(npcId) {
            if (!npcId) return '???';

            // 特殊类型处理
            if (npcId === 'narration' || npcId === 'narrator') return '旁白';
            if (npcId === 'unknown_voice') return '神秘声音';

            // 从masterData中查找NPC
            const npc = state.masterData.npcs?.[npcId];
            if (npc) {
                // 优先使用中文名，没有则用英文名
                return npc.name_cn || npc.name || npcId;
            }

            // 如果找不到，返回原始ID
            return npcId;
        }

        // 从对话数据中提取节点（兼容多种格式）
        // 支持的格式：
        // 1. { nodes: [...] } - 旧格式
        // 2. { sections: { section_name: { lines: [...] } } } - 新格式
        // 3. { dialog: [...] } - NPC对话格式
        // 4. { opening: { lines: [...] } } - 指证开篇格式
        // 5. { rounds: [...] } - 指证回合格式
        function getDialogNodes(dialogData, sectionName = null) {
            if (!dialogData) return [];

            // 1. 如果指定了section，优先从sections中获取
            if (sectionName && dialogData.sections && dialogData.sections[sectionName]) {
                const section = dialogData.sections[sectionName];
                return convertLinesToNodes(section.lines || section.nodes || []);
            }

            // 2. 尝试直接获取nodes
            if (dialogData.nodes) {
                return dialogData.nodes;
            }

            // 3. 如果指定了section但没有在sections中，尝试直接作为属性
            if (sectionName && dialogData[sectionName]) {
                const section = dialogData[sectionName];
                return convertLinesToNodes(section.lines || section.nodes || []);
            }

            // 4. NPC对话格式
            if (dialogData.dialog && Array.isArray(dialogData.dialog)) {
                return convertLinesToNodes(dialogData.dialog);
            }

            // 5. 指证格式 - opening
            if (dialogData.opening && dialogData.opening.lines) {
                return convertLinesToNodes(dialogData.opening.lines);
            }

            // 6. 指证格式 - rounds（返回所有回合的对话）
            if (dialogData.rounds && Array.isArray(dialogData.rounds)) {
                let allNodes = [];
                // 如果有opening，先添加
                if (dialogData.opening && dialogData.opening.lines) {
                    allNodes = allNodes.concat(convertLinesToNodes(dialogData.opening.lines));
                }
                // 添加每轮对话
                dialogData.rounds.forEach(round => {
                    if (round.dialog) {
                        allNodes = allNodes.concat(convertLinesToNodes(round.dialog));
                    }
                });
                // 如果有truth_reveal，添加
                if (dialogData.truth_reveal && dialogData.truth_reveal.lines) {
                    allNodes = allNodes.concat(convertLinesToNodes(dialogData.truth_reveal.lines));
                }
                return allNodes;
            }

            // 7. 如果有sections，合并所有section的lines
            if (dialogData.sections) {
                let allNodes = [];
                Object.values(dialogData.sections).forEach(section => {
                    if (section.lines) {
                        allNodes = allNodes.concat(convertLinesToNodes(section.lines));
                    }
                });
                return allNodes;
            }

            return [];
        }

        // 将lines格式转换为nodes格式
        function convertLinesToNodes(lines) {
            if (!lines || !Array.isArray(lines)) return [];

            return lines.map((line, index) => {
                // 如果是narration类型
                if (line.speaker === 'narration' || line.speaker === 'narrator') {
                    return {
                        id: `line_${index}`,
                        type: 'narration',
                        text: line.text || ''
                    };
                }

                // 如果是unknown_voice（神秘声音）
                if (line.speaker === 'unknown_voice') {
                    return {
                        id: `line_${index}`,
                        type: 'dialog',
                        speaker: '神秘声音',
                        text: line.text || '',
                        emotion: line.emotion || '',
                        action: line.action || ''
                    };
                }

                // 普通对话
                return {
                    id: `line_${index}`,
                    type: 'dialog',
                    speaker: line.speaker || '???',
                    text: line.text || '',
                    emotion: line.emotion || '',
                    action: line.action || ''
                };
            });
        }

        // 初始化
        async function init() {
            // 加载索引文件
            state.index = await loadYaml('_index.yaml');
            if (!state.index) {
                showError('无法加载索引文件 _index.yaml');
                return;
            }

            // 加载主数据
            const [scenes, npcs, evidences] = await Promise.all([
                loadYaml('master/scenes.yaml'),
                loadYaml('master/npcs.yaml'),
                loadYaml('master/evidences.yaml')
            ]);

            state.masterData.scenes = scenes?.scenes || {};
            state.masterData.npcs = npcs?.npcs || {};
            state.masterData.evidences = evidences?.evidences || {};

            // 调试：输出加载的数据数量
            console.log('加载的NPC数量:', Object.keys(state.masterData.npcs).length);
            console.log('NPC示例:', Object.keys(state.masterData.npcs).slice(0, 5));
            console.log('加载的证据数量:', Object.keys(state.masterData.evidences).length);
            console.log('证据示例:', Object.keys(state.masterData.evidences).slice(0, 5));

            // 填充章节选择器
            const unitSelect = document.getElementById('unitSelect');
            unitSelect.innerHTML = '<option value="">请选择章节</option>';

            state.index.units.forEach(unit => {
                if (unit.status === 'active' || unit.status === 'draft') {
                    const option = document.createElement('option');
                    option.value = unit.id;
                    option.textContent = `${unit.name} ${unit.status === 'draft' ? '(草稿)' : ''}`;
                    unitSelect.appendChild(option);
                }
            });

            // 绑定事件
            bindEvents();
        }

        // 绑定事件
        function bindEvents() {
            // 章节选择
            document.getElementById('unitSelect').addEventListener('change', async (e) => {
                const unitId = e.target.value;
                if (!unitId) return;

                state.currentUnit = unitId;
                await loadUnitLoops(unitId);
            });

            // 循环选择
            document.getElementById('loopSelect').addEventListener('change', async (e) => {
                const loopFile = e.target.value;
                if (!loopFile) return;

                await loadLoop(loopFile);
            });

            // 阶段切换
            document.querySelectorAll('.phase-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.phase-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    state.currentPhase = tab.dataset.phase;
                    renderPhase();
                });
            });

            // 视图切换
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.viewMode = btn.dataset.view;
                    renderPhase();
                });
            });
        }

        // 加载章节循环列表
        async function loadUnitLoops(unitId) {
            const loopSelect = document.getElementById('loopSelect');
            loopSelect.innerHTML = '<option value="">加载中...</option>';

            // 获取循环文件列表 (由于是静态文件，我们尝试加载loop1-6)
            const loops = [];
            for (let i = 1; i <= 6; i++) {
                const loopData = await loadYaml(`${unitId}/loops/loop${i}.yaml`);
                if (loopData) {
                    loops.push({
                        file: `${unitId}/loops/loop${i}.yaml`,
                        number: i,
                        name: loopData.name || `循环 ${i}`
                    });
                }
            }

            loopSelect.innerHTML = '<option value="">请选择循环</option>';
            loops.forEach(loop => {
                const option = document.createElement('option');
                option.value = loop.file;
                option.textContent = `Loop ${loop.number}: ${loop.name}`;
                loopSelect.appendChild(option);
            });
        }

        // 加载循环数据
        async function loadLoop(loopFile) {
            const content = document.getElementById('mainContent');
            content.innerHTML = '<div class="loading">加载循环数据</div>';

            state.loopData = await loadYaml(loopFile);
            if (!state.loopData) {
                showError('无法加载循环文件');
                return;
            }

            // 加载对话文件
            state.dialogs = {};
            const dialogFiles = new Set();

            // 收集所有对话文件
            if (state.loopData.opening?.scenes) {
                state.loopData.opening.scenes.forEach(s => {
                    if (s.dialog_file) dialogFiles.add(s.dialog_file);
                });
            }
            if (state.loopData.free_phase?.scenes) {
                state.loopData.free_phase.scenes.forEach(s => {
                    if (s.dialog_file) dialogFiles.add(s.dialog_file);
                });
            }
            if (state.loopData.ending?.dialog_file) {
                dialogFiles.add(state.loopData.ending.dialog_file);
            }

            // 并行加载对话
            const dialogPromises = Array.from(dialogFiles).map(async file => {
                const data = await loadYaml(`${state.currentUnit}/dialogs/${file}`);
                if (data) state.dialogs[file] = data;
            });
            await Promise.all(dialogPromises);

            // 显示循环信息
            document.getElementById('loopInfo').style.display = 'block';
            document.getElementById('loopTitle').textContent =
                `${state.loopData.title || state.loopData.name || '未命名循环'} (${state.loopData.loop_id})`;
            document.getElementById('loopObjective').textContent =
                `目标: ${state.loopData.investigation_target || state.loopData.objective || '无'}`;

            // 渲染当前阶段
            state.currentPhase = 'opening';
            document.querySelectorAll('.phase-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.phase-tab[data-phase="opening"]').classList.add('active');
            renderPhase();
        }

        // 渲染当前阶段
        function renderPhase() {
            const content = document.getElementById('mainContent');

            switch (state.currentPhase) {
                case 'scenes':
                    renderScenesOverview(content);
                    break;
                case 'opening':
                    renderOpening(content);
                    break;
                case 'free':
                    renderFreePhase(content);
                    break;
                case 'npcinfo':
                    renderNpcInfo(content);
                    break;
                case 'expose':
                    renderExpose(content);
                    break;
                case 'ending':
                    renderEnding(content);
                    break;
            }
        }

        // 渲染场景总览
        function renderScenesOverview(container) {
            const scenesOverview = state.loopData?.scenes_overview;

            if (!scenesOverview || scenesOverview.length === 0) {
                container.innerHTML = '<div class="error-box"><h3>无场景总览数据</h3><p>请在loop文件中添加 scenes_overview 字段</p></div>';
                return;
            }

            // 统计各状态数量
            const stats = {
                accessible: scenesOverview.filter(s => s.status === 'accessible').length,
                locked: scenesOverview.filter(s => s.status === 'locked').length,
                hidden: scenesOverview.filter(s => s.status === 'hidden').length,
                story_only: scenesOverview.filter(s => s.status === 'story_only').length
            };

            let html = `
                <div class="scenes-overview-container">
                    <div class="scenes-overview-header">
                        <h3>本循环场景总览</h3>
                        <div class="scenes-stats">
                            <span class="stat-badge accessible">可进入 ${stats.accessible}</span>
                            <span class="stat-badge locked">锁定 ${stats.locked}</span>
                            ${stats.story_only > 0 ? `<span class="stat-badge story">剧情 ${stats.story_only}</span>` : ''}
                            ${stats.hidden > 0 ? `<span class="stat-badge hidden">隐藏 ${stats.hidden}</span>` : ''}
                        </div>
                    </div>
                    <div class="scenes-grid">
            `;

            scenesOverview.forEach(scene => {
                const masterScene = state.masterData.scenes[scene.scene] || {};
                const statusIcon = {
                    'accessible': '✅',
                    'locked': '🔒',
                    'hidden': '👁️‍🗨️',
                    'story_only': '🎬'
                }[scene.status] || '❓';

                const typeIcon = {
                    'search': '🔍',
                    'npc': '💬',
                    'story': '📖'
                }[scene.type] || '📍';

                html += `
                    <div class="scene-overview-card ${scene.status}">
                        <div class="scene-overview-header">
                            <span class="scene-status-icon">${statusIcon}</span>
                            <div class="scene-overview-title">
                                <h4>${scene.name || masterScene.name || '未知场景'}</h4>
                                <span class="scene-id">${scene.scene}</span>
                            </div>
                            <span class="scene-type-icon" title="${scene.type}">${typeIcon}</span>
                        </div>
                        <div class="scene-overview-body">
                            ${masterScene.description ? `<p class="scene-desc">${masterScene.description}</p>` : ''}
                            ${scene.note ? `<p class="scene-note">${scene.note}</p>` : ''}
                        </div>
                        <div class="scene-overview-footer">
                            <span class="status-label ${scene.status}">${
                                scene.status === 'accessible' ? '可进入' :
                                scene.status === 'locked' ? '锁定' :
                                scene.status === 'hidden' ? '隐藏' :
                                scene.status === 'story_only' ? '仅剧情' : scene.status
                            }</span>
                            <span class="type-label">${
                                scene.type === 'search' ? '探索' :
                                scene.type === 'npc' ? 'NPC对话' :
                                scene.type === 'story' ? '剧情' : scene.type
                            }</span>
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // 渲染开篇
        function renderOpening(container) {
            if (!state.loopData?.opening) {
                container.innerHTML = '<div class="error-box"><h3>无开篇数据</h3></div>';
                return;
            }

            const opening = state.loopData.opening;

            // 处理 missing 情况
            if (opening.missing === true) {
                container.innerHTML = `
                    <div class="missing-content-box">
                        <div class="missing-icon">⚠️</div>
                        <h3>开篇对话缺失</h3>
                        <p class="missing-reason">${opening.reason || '未提供原因'}</p>
                        ${opening.inherited_from ? `
                            <div class="inherited-info">
                                <span class="inherited-label">内容继承自：</span>
                                <span class="inherited-source">${opening.inherited_from}</span>
                            </div>
                        ` : ''}
                    </div>
                `;
                return;
            }

            const isFlowMode = state.viewMode === 'flow';
            let html = '';

            if (isFlowMode) {
                // 流程版：显示场景按钮，点击展开
                html += '<div class="opening-scene-buttons">';
                opening.scenes?.forEach((scene, index) => {
                    html += `
                        <button class="opening-scene-btn" onclick="toggleOpeningScene(${index})">
                            <span class="scene-icon">🎬</span>
                            <span>${scene.name}</span>
                            <span class="scene-arrow">▼</span>
                        </button>
                    `;
                });
                html += '</div>';

                // 场景内容（初始隐藏，使用逐条展开）
                opening.scenes?.forEach((scene, index) => {
                    const dialogData = state.dialogs[scene.dialog_file];
                    const section = scene.dialog_section;
                    // 使用新的兼容函数获取节点
                    const nodes = getDialogNodes(dialogData, section);

                    html += `
                        <div class="dialog-section opening-scene-content" id="openingScene_${index}" style="display:none;">
                            <div class="scene-header">
                                <h3>${scene.name}</h3>
                                <p>${scene.description || ''}</p>
                            </div>
                            <div class="dialog-flow-container" id="openingDialogFlow_${index}">
                                ${renderOpeningDialogFlow(nodes, index)}
                            </div>
                        </div>
                    `;
                });
            } else {
                // 完整版：直接显示所有内容
                opening.scenes?.forEach(scene => {
                    html += `
                        <div class="dialog-section">
                            <div class="scene-header">
                                <h3>${scene.name}</h3>
                                <p>${scene.description || ''}</p>
                            </div>
                            <div class="dialog-nodes">
                    `;

                    const dialogData = state.dialogs[scene.dialog_file];
                    const section = scene.dialog_section;
                    // 使用新的兼容函数获取节点
                    const nodes = getDialogNodes(dialogData, section);

                    // 存储当前对话数据以供分支展开使用
                    state.currentDialogData = { nodes: nodes };

                    nodes.forEach(node => {
                        html += renderDialogNode(node);
                    });

                    html += '</div></div>';
                });
            }

            container.innerHTML = html || '<div class="error-box"><h3>无对话数据</h3></div>';
        }

        // 切换开篇场景显示
        window.toggleOpeningScene = function(index) {
            const scene = document.getElementById(`openingScene_${index}`);
            const btn = document.querySelectorAll('.opening-scene-btn')[index];

            if (scene) {
                const isVisible = scene.style.display !== 'none';
                scene.style.display = isVisible ? 'none' : 'block';
                btn.classList.toggle('active', !isVisible);

                // 更新当前对话数据以供分支展开使用
                if (!isVisible && state.loopData?.opening?.scenes) {
                    const openingScene = state.loopData.opening.scenes[index];
                    if (openingScene?.dialog_file) {
                        const dialogData = state.dialogs[openingScene.dialog_file];
                        const section = openingScene.dialog_section;
                        // 使用兼容函数获取节点
                        const nodes = getDialogNodes(dialogData, section);
                        state.currentDialogData = { nodes: nodes };
                    }
                }
            }
        };

        // 渲染开篇对话（流程版：逐条展开）
        function renderOpeningDialogFlow(nodes, sceneIndex) {
            if (!nodes || nodes.length === 0) return '<div style="color:#888;">无对话数据</div>';

            let html = '';

            // 第一条对话直接显示，后续需要点击
            nodes.forEach((node, nodeIndex) => {
                const nodeId = `openingNode_${sceneIndex}_${nodeIndex}`;
                const isFirst = nodeIndex === 0;

                if (isFirst) {
                    // 第一条直接显示
                    html += `
                        <div class="dialog-flow-node visible" id="${nodeId}">
                            ${renderDialogNode(node)}
                        </div>
                    `;
                    // 如果还有下一条，显示"继续"按钮
                    if (nodes.length > 1) {
                        html += `
                            <button class="dialog-next-btn" id="openingNextBtn_${sceneIndex}_${nodeIndex}" onclick="showNextOpeningNode(${sceneIndex}, ${nodeIndex + 1}, ${nodes.length})">
                                ▼ 继续
                            </button>
                        `;
                    }
                } else {
                    // 后续对话初始隐藏
                    html += `
                        <div class="dialog-flow-node" id="${nodeId}">
                            ${renderDialogNode(node)}
                        </div>
                    `;
                    // 如果还有下一条，显示"继续"按钮（初始隐藏）
                    if (nodeIndex < nodes.length - 1) {
                        html += `
                            <button class="dialog-next-btn hidden" id="openingNextBtn_${sceneIndex}_${nodeIndex}" onclick="showNextOpeningNode(${sceneIndex}, ${nodeIndex + 1}, ${nodes.length})">
                                ▼ 继续
                            </button>
                        `;
                    }
                }
            });

            return html;
        }

        // 显示下一条开篇对话节点
        window.showNextOpeningNode = function(sceneIndex, nodeIndex, totalNodes) {
            // 隐藏当前的"继续"按钮
            const prevBtn = document.getElementById(`openingNextBtn_${sceneIndex}_${nodeIndex - 1}`);
            if (prevBtn) prevBtn.classList.add('hidden');

            // 显示下一条对话
            const nextNode = document.getElementById(`openingNode_${sceneIndex}_${nodeIndex}`);
            if (nextNode) {
                nextNode.classList.add('visible');
            }

            // 如果还有更多，显示下一个"继续"按钮并滚动到它
            if (nodeIndex < totalNodes - 1) {
                const nextBtn = document.getElementById(`openingNextBtn_${sceneIndex}_${nodeIndex}`);
                if (nextBtn) {
                    nextBtn.classList.remove('hidden');
                    // 延迟滚动，等待DOM更新
                    setTimeout(() => {
                        nextBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 50);
                }
            } else {
                // 最后一条，滚动到该节点
                if (nextNode) {
                    setTimeout(() => {
                        nextNode.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 50);
                }
            }
        };

        // 渲染对话节点
        // dialogFile: 可选，用于分支选项跳转
        // branchId: 可选，当前分支的唯一标识
        function renderDialogNode(node, dialogFile = null, branchId = null) {
            if (node.type === 'narration') {
                return `<div class="dialog-node narration">${node.text}</div>`;
            }

            if (node.type === 'branch') {
                const uniqueId = branchId || `branch_${Math.random().toString(36).substr(2, 9)}`;
                let optionsHtml = node.options.map((opt, optIndex) => `
                    <button class="branch-option-btn ${opt.important ? 'important' : ''}"
                            onclick="expandBranchOption('${uniqueId}', ${optIndex}, '${opt.next || 'END'}', '${dialogFile || ''}')">
                        ${opt.text}
                        <span class="branch-arrow">→</span>
                    </button>
                `).join('');

                // 添加展开后的内容区域
                let branchContentsHtml = node.options.map((opt, optIndex) => `
                    <div class="branch-content" id="${uniqueId}_content_${optIndex}" style="display:none;">
                        <div class="branch-content-header">
                            <span class="branch-path-label">选择: ${opt.text}</span>
                        </div>
                        <div class="branch-content-nodes" id="${uniqueId}_nodes_${optIndex}">
                            <!-- 分支内容将在点击时加载 -->
                        </div>
                    </div>
                `).join('');

                return `
                    <div class="dialog-node branch" id="${uniqueId}">
                        <div class="speaker-name">选项</div>
                        <div class="branch-options">${optionsHtml}</div>
                        <div class="branch-contents">${branchContentsHtml}</div>
                    </div>
                `;
            }

            if (node.type === 'scene_end' || node.type === 'phase_end' || node.type === 'dialog_end' || node.type === 'loop_end') {
                return `<div class="dialog-node narration">[${node.message || '场景结束'}]</div>`;
            }

            if (node.type === 'evidence_gain') {
                return `
                    <div class="dialog-node" style="background: rgba(78, 205, 196, 0.15); border-left: 3px solid #4ecdc4;">
                        <div class="speaker-name" style="color: #4ecdc4;">获得证据</div>
                        <div class="text">${node.evidence_name} (${node.evidence_id})</div>
                        <div class="action">${node.description || ''}</div>
                    </div>
                `;
            }

            // 普通对话
            const speakerId = node.speaker || '';
            const speakerName = getNpcDisplayName(speakerId);
            const speakerClass = speakerId.toLowerCase();
            return `
                <div class="dialog-node speaker">
                    <div class="speaker-name ${speakerClass}">
                        ${speakerName}
                        ${node.emotion ? `<span class="emotion">[${node.emotion}]</span>` : ''}
                    </div>
                    <div class="text">${node.text || ''}</div>
                    ${node.action ? `<div class="action">${node.action}</div>` : ''}
                </div>
            `;
        }

        // 展开分支选项内容
        window.expandBranchOption = function(branchId, optIndex, nextNodeId, dialogFilePath) {
            const contentDiv = document.getElementById(`${branchId}_content_${optIndex}`);
            const nodesDiv = document.getElementById(`${branchId}_nodes_${optIndex}`);
            const btn = document.querySelector(`#${branchId} .branch-options .branch-option-btn:nth-child(${optIndex + 1})`);

            if (!contentDiv || !nodesDiv) return;

            // 如果已经显示，则隐藏（切换行为）
            if (contentDiv.style.display !== 'none') {
                contentDiv.style.display = 'none';
                if (btn) btn.classList.remove('active');
                return;
            }

            // 隐藏同分支的其他展开内容
            const allContents = document.querySelectorAll(`#${branchId} .branch-content`);
            allContents.forEach(c => c.style.display = 'none');

            // 移除所有按钮的active状态
            const allBtns = document.querySelectorAll(`#${branchId} .branch-options .branch-option-btn`);
            allBtns.forEach(b => b.classList.remove('active'));

            // 显示当前选项的内容
            contentDiv.style.display = 'block';
            if (btn) btn.classList.add('active');

            // 如果已经加载过内容（排除初始的注释和加载中状态），直接滚动
            const currentContent = nodesDiv.innerHTML.trim();
            const isLoaded = currentContent !== '' &&
                             !currentContent.includes('加载中') &&
                             !currentContent.includes('<!--') &&
                             !currentContent.includes('分支内容将在点击时加载');
            if (isLoaded) {
                setTimeout(() => {
                    contentDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 50);
                return;
            }

            // 加载分支内容
            nodesDiv.innerHTML = '<div style="color:#888;padding:10px;">加载中...</div>';

            // 从state中获取当前对话数据
            let dialogNodes = null;

            // 优先从dialogFilePath获取（如果传入了的话）
            if (dialogFilePath && state.dialogs[dialogFilePath]) {
                dialogNodes = state.dialogs[dialogFilePath].nodes;
            }
            // 否则尝试从当前状态获取对话节点
            else if (state.currentDialogData && state.currentDialogData.nodes) {
                dialogNodes = state.currentDialogData.nodes;
            }

            if (!dialogNodes) {
                console.log('expandBranchOption debug:', {
                    dialogFilePath,
                    hasDialogs: !!state.dialogs,
                    dialogKeys: Object.keys(state.dialogs || {}),
                    currentDialogData: state.currentDialogData
                });
                nodesDiv.innerHTML = '<div style="color:#e74c3c;padding:10px;">无法加载分支内容（请确保已选择场景）</div>';
                return;
            }

            console.log('找到对话数据，节点数量:', dialogNodes.length, '开始节点:', nextNodeId);

            // 从nextNodeId开始，收集后续节点直到遇到回到分支节点或结束
            const branchPath = [];
            let currentId = nextNodeId;
            const visitedIds = new Set();
            const maxSteps = 50; // 防止无限循环

            while (currentId && currentId !== 'END' && branchPath.length < maxSteps) {
                if (visitedIds.has(currentId)) break; // 检测循环
                visitedIds.add(currentId);

                const node = dialogNodes.find(n => n.id === currentId);
                if (!node) break;

                branchPath.push(node);

                // 如果是分支节点或结束节点，停止
                if (node.type === 'branch' || node.type === 'dialog_end' ||
                    node.type === 'scene_end' || node.type === 'phase_end' ||
                    node.type === 'loop_end') {
                    break;
                }

                currentId = node.next;
            }

            console.log('收集到分支路径节点数:', branchPath.length, branchPath.map(n => n.id));

            // 渲染分支路径（逐条展开模式）
            if (branchPath.length > 0) {
                const fileToUse = dialogFilePath || null;
                const branchFlowId = `${branchId}_flow_${optIndex}`;

                let html = '';
                branchPath.forEach((node, nodeIndex) => {
                    const nodeId = `${branchFlowId}_node_${nodeIndex}`;
                    const isFirst = nodeIndex === 0;

                    if (isFirst) {
                        // 第一条直接显示
                        html += `
                            <div class="dialog-flow-node visible" id="${nodeId}">
                                ${renderDialogNode(node, fileToUse, `${branchId}_sub`)}
                            </div>
                        `;
                        // 如果还有下一条，显示"继续"按钮
                        if (branchPath.length > 1) {
                            html += `
                                <button class="dialog-next-btn" id="${branchFlowId}_btn_${nodeIndex}"
                                        onclick="showNextBranchNode('${branchFlowId}', ${nodeIndex + 1}, ${branchPath.length})">
                                    ▼ 继续
                                </button>
                            `;
                        }
                    } else {
                        // 后续对话初始隐藏
                        html += `
                            <div class="dialog-flow-node" id="${nodeId}">
                                ${renderDialogNode(node, fileToUse, `${branchId}_sub`)}
                            </div>
                        `;
                        // 如果还有下一条，显示"继续"按钮（初始隐藏）
                        if (nodeIndex < branchPath.length - 1) {
                            html += `
                                <button class="dialog-next-btn hidden" id="${branchFlowId}_btn_${nodeIndex}"
                                        onclick="showNextBranchNode('${branchFlowId}', ${nodeIndex + 1}, ${branchPath.length})">
                                    ▼ 继续
                                </button>
                            `;
                        }
                    }
                });

                nodesDiv.innerHTML = html;
            } else {
                nodesDiv.innerHTML = '<div style="color:#888;padding:10px;">[此选项直接结束对话或返回主分支]</div>';
            }

            // 滚动到展开的内容
            setTimeout(() => {
                contentDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 50);
        };

        // 显示下一条分支对话节点
        window.showNextBranchNode = function(branchFlowId, nodeIndex, totalNodes) {
            // 隐藏当前的"继续"按钮
            const prevBtn = document.getElementById(`${branchFlowId}_btn_${nodeIndex - 1}`);
            if (prevBtn) prevBtn.classList.add('hidden');

            // 显示下一条对话
            const nextNode = document.getElementById(`${branchFlowId}_node_${nodeIndex}`);
            if (nextNode) {
                nextNode.classList.add('visible');
            }

            // 如果还有更多，显示下一个"继续"按钮并滚动到它
            if (nodeIndex < totalNodes - 1) {
                const nextBtn = document.getElementById(`${branchFlowId}_btn_${nodeIndex}`);
                if (nextBtn) {
                    nextBtn.classList.remove('hidden');
                    setTimeout(() => {
                        nextBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 50);
                }
            } else {
                // 最后一条，滚动到该节点
                if (nextNode) {
                    setTimeout(() => {
                        nextNode.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 50);
                }
            }
        };

        // 渲染NPC信息
        function renderNpcInfo(container) {
            if (!state.loopData) {
                container.innerHTML = '<div class="error-box"><h3>请先选择循环</h3></div>';
                return;
            }

            // 获取当前循环号
            const loopNumber = state.loopData.loop_number || 1;
            const loopKey = `loop${loopNumber}`;

            // 收集本循环出现的NPC
            const npcsInLoop = new Set();

            // 从自由环节收集
            state.loopData.free_phase?.scenes?.forEach(scene => {
                if (scene.npc) npcsInLoop.add(scene.npc);
            });

            // 从指证收集
            if (state.loopData.expose?.target) {
                npcsInLoop.add(state.loopData.expose.target);
            }

            // 角色类型中文映射
            const roleMap = {
                'protagonist': '主角',
                'partner': '搭档',
                'suspect': '嫌疑人',
                'witness': '证人',
                'victim': '受害者'
            };

            let html = `
                <div class="scene-header">
                    <h3>NPC 信息档案 - ${state.loopData.title || state.loopData.name || '当前循环'}</h3>
                    <p>玩家在本循环中可以了解到的NPC信息</p>
                </div>
                <div class="npc-info-grid">
            `;

            // 遍历本循环的NPC
            npcsInLoop.forEach(npcId => {
                const npc = state.masterData.npcs[npcId];
                if (!npc) return;

                const info = npc.info?.[loopKey] || {};
                const testimonies = npc.testimonies?.[loopKey] || [];
                const hasInfo = Object.keys(info).length > 0 || testimonies.length > 0;

                // 获取名字首字母作为头像
                const initial = (npc.name_cn || npc.name || '?')[0];

                html += `
                    <div class="npc-card">
                        <div class="npc-card-header">
                            <div class="npc-avatar">${initial}</div>
                            <div class="npc-card-title">
                                <h4>${npc.name_cn || npc.name} <span style="color:#666;font-size:12px;">(${npcId})</span></h4>
                                <span class="npc-role ${npc.role}">${roleMap[npc.role] || npc.role}</span>
                            </div>
                        </div>
                `;

                if (hasInfo) {
                    // 渲染info字段
                    if (Object.keys(info).length > 0) {
                        html += `
                            <div class="npc-info-section">
                                <h5>基本信息</h5>
                                <div class="info-table">
                        `;

                        for (const [key, value] of Object.entries(info)) {
                            // 根据关键词添加高亮样式
                            let valueClass = '';
                            if (key.includes('线索') || key.includes('关键')) {
                                valueClass = 'highlight';
                            } else if (key.includes('异常') || key.includes('谎')) {
                                valueClass = 'warning';
                            }

                            html += `
                                <div class="info-row">
                                    <span class="info-label">${key}</span>
                                    <span class="info-value ${valueClass}">${value}</span>
                                </div>
                            `;
                        }

                        html += '</div></div>';
                    }

                    // 渲染证词
                    if (testimonies.length > 0) {
                        html += `
                            <div class="npc-info-section">
                                <h5>证词记录</h5>
                                <div class="testimony-list">
                        `;

                        testimonies.forEach(testimony => {
                            html += `<div class="testimony-item">${testimony}</div>`;
                        });

                        html += '</div></div>';
                    }
                } else {
                    html += `<div class="no-info-hint">本循环暂无该NPC的详细信息配置</div>`;
                }

                html += '</div>';
            });

            // 如果没有NPC
            if (npcsInLoop.size === 0) {
                html += '<div class="no-info-hint">本循环没有可交互的NPC</div>';
            }

            html += '</div>';
            container.innerHTML = html;
        }

        // 渲染自由环节
        function renderFreePhase(container) {
            if (!state.loopData?.free_phase?.scenes) {
                container.innerHTML = '<div class="error-box"><h3>无自由环节数据</h3></div>';
                return;
            }

            const freeScenes = state.loopData.free_phase.scenes;
            const scenesOverview = state.loopData.scenes_overview || [];
            const isFlowMode = state.viewMode === 'flow';

            // 获取free_phase中已有的场景ID
            const freeScenesIds = new Set(freeScenes.map(s => s.scene));

            // 从scenes_overview中获取锁定场景（排除story_only类型，因为那是纯剧情场景）
            const lockedScenes = scenesOverview.filter(s =>
                s.status === 'locked' &&
                !freeScenesIds.has(s.scene)
            );

            // 生成场景按钮（两种模式都显示，都是切换行为）
            let buttonsHtml = '<div class="scene-buttons">';

            // 可访问场景
            freeScenes.forEach((scene, index) => {
                const sceneInfo = state.masterData.scenes[scene.scene] || {};
                const icon = scene.type === 'search' ? '🔍' : '💬';

                buttonsHtml += `
                    <button class="scene-btn" data-index="${index}" onclick="selectScene(${index})">
                        <span class="scene-icon">${icon}</span>
                        <span class="scene-name">${scene.name || sceneInfo.name || '未知场景'}</span>
                        <span class="scene-badge ${scene.type}">${scene.type === 'search' ? '探索' : 'NPC'}</span>
                        ${scene.evidences?.length ? `<span style="color:#4ecdc4;font-size:11px;">(${scene.evidences.length})</span>` : ''}
                    </button>
                `;
            });

            // 锁定场景
            lockedScenes.forEach((scene) => {
                const sceneInfo = state.masterData.scenes[scene.scene] || {};

                buttonsHtml += `
                    <button class="scene-btn locked" disabled>
                        <span class="scene-icon">🔒</span>
                        <span class="scene-name">${scene.name || sceneInfo.name || '未知场景'}</span>
                        <span class="scene-badge locked">锁定</span>
                    </button>
                `;
            });

            buttonsHtml += '</div>';

            // 两种模式都是点击切换，初始显示提示
            let contentHtml = `
                <div id="sceneDetailArea">
                    <div class="no-scene-hint">
                        <div class="hint-icon">👆</div>
                        <p>点击上方场景按钮查看详情</p>
                    </div>
                </div>
            `;

            const totalScenes = freeScenes.length + lockedScenes.length;
            const lockedText = lockedScenes.length > 0 ? `，${lockedScenes.length} 个锁定` : '';

            container.innerHTML = `
                <div class="free-phase-container">
                    <div class="scene-header">
                        <h3>自由探索 - ${state.loopData.free_phase.description || ''}</h3>
                        <p>共 ${freeScenes.length} 个可探索场景${lockedText}</p>
                    </div>
                    ${buttonsHtml}
                    ${contentHtml}
                </div>
            `;
        }

        // 完整版场景卡片渲染（所有内容直接展示）
        function renderSceneCardFull(scene, index) {
            const sceneInfo = state.masterData.scenes[scene.scene] || {};
            const npcInfo = scene.npc ? state.masterData.npcs[scene.npc] : null;
            const icon = scene.type === 'search' ? '🔍' : '💬';

            let html = `
                <div class="scene-card" id="sceneCard_${index}">
                    <div class="scene-card-header">
                        <span class="scene-card-icon">${icon}</span>
                        <div class="scene-card-title">
                            <h4>${scene.name || sceneInfo.name || '未知场景'}</h4>
                            <span class="scene-card-id">${scene.scene}</span>
                        </div>
                        <span class="scene-type-badge ${scene.type}">${scene.type === 'search' ? '探索' : 'NPC'}</span>
                    </div>
                    ${scene.note ? `<div class="scene-card-note">${scene.note}</div>` : ''}
            `;

            // NPC信息
            if (npcInfo) {
                html += `
                    <div class="scene-npc-info">
                        <strong>NPC:</strong> ${npcInfo.name_cn || npcInfo.name} (${scene.npc})
                    </div>
                `;
            }

            // 证据列表（完整版：全部展开）
            if (scene.evidences && scene.evidences.length > 0) {
                html += `
                    <div class="evidence-list">
                        <div class="evidence-list-header">
                            <span>📦</span> 可获取证据 (${scene.evidences.length})
                        </div>
                `;

                scene.evidences.forEach((ev, evIndex) => {
                    html += renderEvidenceCardFull(ev, index, evIndex);
                });

                html += '</div>';
            }

            // 对话内容（完整版：直接显示）
            if (scene.dialog_file) {
                html += `
                    <div class="scene-dialog-section">
                        <div style="color:#3498db;font-size:14px;margin-bottom:10px;">💬 对话内容</div>
                        <div class="scene-dialog-content visible">
                            ${renderSceneDialog(scene.dialog_file)}
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            return html;
        }

        // 完整版证据卡片渲染（直接展开，分析结果直接显示）
        function renderEvidenceCardFull(ev, sceneIndex, evIndex) {
            const evInfo = state.masterData.evidences[ev.id] || {};
            const cardId = `ev_full_${sceneIndex}_${evIndex}`;
            const hasAnalysis = evInfo.requires_analysis || evInfo.description?.analyzed;
            const typeText = {
                'item': '物品',
                'clue': '线索',
                'envir': '环境'
            }[evInfo.type] || evInfo.type || '线索';

            const typeClass = evInfo.type || 'clue';

            let html = `
                <div class="evidence-card expanded">
                    <div class="evidence-card-header">
                        <div class="ev-icon">📋</div>
                        <div class="ev-info">
                            <div class="ev-name">${ev.name || evInfo.name || '未知证据'}</div>
                            <div class="ev-id">${ev.id}</div>
                        </div>
                        <span class="ev-type ${typeClass}">${typeText}</span>
                    </div>
                    <div class="evidence-card-body" style="display:block;">
            `;

            // 初始描述
            if (evInfo.description?.initial) {
                html += `
                    <div class="ev-description">
                        <div class="desc-label">描述</div>
                        <div class="desc-text">${evInfo.description.initial}</div>
                    </div>
                `;
            }

            // 位置信息
            if (ev.location) {
                html += `<div class="ev-hint location">📍 位置: ${ev.location}</div>`;
            }

            // 谜题提示
            if (ev.puzzle_hint) {
                html += `<div class="ev-hint puzzle">💡 提示: ${ev.puzzle_hint}</div>`;
            }

            // 前置条件
            if (ev.requires) {
                html += `<div class="ev-hint requires">🔒 需要: ${ev.requires}</div>`;
            }

            // 分析结果（完整版：直接显示）
            if (hasAnalysis && evInfo.description?.analyzed) {
                html += `
                    <div class="analyze-section">
                        <div style="color:#9b59b6;font-size:12px;margin-bottom:8px;">🔬 ${evInfo.analysis_action || '分析证据'}</div>
                        <div class="analyzed-result visible">
                            <div class="result-label">分析结果</div>
                            <div class="result-text">${evInfo.description.analyzed}</div>
                        </div>
                    </div>
                `;
            }

            html += '</div></div>';
            return html;
        }

        // 选择场景（两种模式共用）
        window.selectScene = function(index) {
            const scenes = state.loopData.free_phase.scenes;
            const scene = scenes[index];
            if (!scene) return;

            // 更新按钮状态
            document.querySelectorAll('.scene-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });

            // 根据视图模式渲染不同的场景卡片
            const detailArea = document.getElementById('sceneDetailArea');
            if (state.viewMode === 'full') {
                detailArea.innerHTML = renderSceneCardFull(scene, index);
            } else {
                detailArea.innerHTML = renderSceneCardFlow(scene, index);
            }
        };

        // 流程版场景卡片渲染（需要点击展开）
        function renderSceneCardFlow(scene, index) {
            const sceneInfo = state.masterData.scenes[scene.scene] || {};
            const npcInfo = scene.npc ? state.masterData.npcs[scene.npc] : null;
            const icon = scene.type === 'search' ? '🔍' : '💬';

            let html = `
                <div class="scene-card">
                    <div class="scene-card-header">
                        <span class="scene-card-icon">${icon}</span>
                        <div class="scene-card-title">
                            <h4>${scene.name || sceneInfo.name || '未知场景'}</h4>
                            <span class="scene-card-id">${scene.scene}</span>
                        </div>
                        <span class="scene-type-badge ${scene.type}">${scene.type === 'search' ? '探索' : 'NPC'}</span>
                    </div>
                    ${scene.note ? `<div class="scene-card-note">${scene.note}</div>` : ''}
            `;

            // NPC信息
            if (npcInfo) {
                html += `
                    <div class="scene-npc-info">
                        <strong>NPC:</strong> ${npcInfo.name_cn || npcInfo.name} (${scene.npc})
                    </div>
                `;
            }

            // 证据列表（体验版：NPC对话场景初始隐藏，对话完成后显示）
            if (scene.evidences && scene.evidences.length > 0) {
                // NPC场景有对话时，证据初始隐藏
                const hasDialog = scene.dialog_file && scene.type === 'npc';
                const hiddenClass = hasDialog ? 'hidden' : '';

                html += `
                    <div class="evidence-list ${hiddenClass}" id="evidenceList_${index}">
                        <div class="evidence-list-header">
                            <span>📦</span> 可获取证据 (${scene.evidences.length})
                        </div>
                `;

                scene.evidences.forEach((ev, evIndex) => {
                    html += renderEvidenceCard(ev, index, evIndex);
                });

                html += '</div>';
            }

            // 对话内容（流程版：逐条点击展开）
            if (scene.dialog_file) {
                html += `
                    <div class="scene-dialog-section">
                        <div style="color:#3498db;font-size:14px;margin-bottom:10px;">💬 对话内容</div>
                        <div class="dialog-flow-container" id="dialogFlow_${index}">
                            ${renderSceneDialogFlow(scene.dialog_file, index)}
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            return html;
        }

        // 渲染证据卡片（体验版：可展开）
        function renderEvidenceCard(ev, sceneIndex, evIndex) {
            const evInfo = state.masterData.evidences[ev.id] || {};
            const cardId = `ev_${sceneIndex}_${evIndex}`;
            const hasAnalysis = evInfo.requires_analysis || evInfo.description?.analyzed;
            const typeText = {
                'item': '物品',
                'clue': '线索',
                'envir': '环境'
            }[evInfo.type] || evInfo.type || '线索';
            const typeClass = evInfo.type || 'clue';

            let html = `
                <div class="evidence-card" id="${cardId}">
                    <div class="evidence-card-header" onclick="toggleEvidence('${cardId}')">
                        <div class="ev-icon">📋</div>
                        <div class="ev-info">
                            <div class="ev-name">${ev.name || evInfo.name || '未知证据'}</div>
                            <div class="ev-id">${ev.id}</div>
                        </div>
                        <span class="ev-type ${typeClass}">${typeText}</span>
                        <span class="ev-expand">▼</span>
                    </div>
                    <div class="evidence-card-body">
            `;

            // 初始描述
            if (evInfo.description?.initial) {
                html += `
                    <div class="ev-description">
                        <div class="desc-label">描述</div>
                        <div class="desc-text">${evInfo.description.initial}</div>
                    </div>
                `;
            }

            // 位置信息
            if (ev.location) {
                html += `<div class="ev-hint location">📍 位置: ${ev.location}</div>`;
            }

            // 谜题提示
            if (ev.puzzle_hint) {
                html += `<div class="ev-hint puzzle">💡 提示: ${ev.puzzle_hint}</div>`;
            }

            // 前置条件
            if (ev.requires) {
                html += `<div class="ev-hint requires">🔒 需要: ${ev.requires}</div>`;
            }

            // 分析功能
            if (hasAnalysis && evInfo.description?.analyzed) {
                const analyzeId = `analyze_${cardId}`;
                html += `
                    <div class="analyze-section">
                        <button class="analyze-btn" id="btn_${analyzeId}" onclick="analyzeEvidence('${analyzeId}')">
                            🔬 ${evInfo.analysis_action || '分析证据'}
                        </button>
                        <div class="analyzed-result" id="result_${analyzeId}">
                            <div class="result-label">分析结果</div>
                            <div class="result-text">${evInfo.description.analyzed}</div>
                        </div>
                    </div>
                `;
            }

            html += '</div></div>';
            return html;
        }

        // 展开/收起证据
        window.toggleEvidence = function(cardId) {
            const card = document.getElementById(cardId);
            if (card) {
                card.classList.toggle('expanded');
            }
        };

        // 分析证据
        window.analyzeEvidence = function(analyzeId) {
            const btn = document.getElementById(`btn_${analyzeId}`);
            const result = document.getElementById(`result_${analyzeId}`);

            if (btn && result) {
                btn.classList.add('analyzed');
                btn.textContent = '✓ 已分析';
                result.classList.add('visible');
            }
        };

        // 切换对话显示
        window.toggleDialog = function(index) {
            const content = document.getElementById(`dialogContent_${index}`);
            if (content) {
                content.classList.toggle('visible');
                const btn = content.previousElementSibling;
                if (content.classList.contains('visible')) {
                    btn.textContent = '📖 收起对话内容';
                } else {
                    btn.textContent = '💬 查看对话内容';
                }
            }
        };

        // 渲染场景对话（完整版）
        function renderSceneDialog(dialogFile, sectionName = null) {
            const dialogData = state.dialogs[dialogFile];
            const nodes = getDialogNodes(dialogData, sectionName);
            if (!nodes || nodes.length === 0) return '<div style="color:#888;">无对话数据</div>';

            // 存储当前对话数据以供分支展开使用
            state.currentDialogData = dialogData;

            return nodes.map(node => renderDialogNode(node, dialogFile)).join('');
        }

        // 渲染场景对话（流程版：逐条展开）
        function renderSceneDialogFlow(dialogFile, sceneIndex, sectionName = null) {
            const dialogData = state.dialogs[dialogFile];
            const nodes = getDialogNodes(dialogData, sectionName);
            if (!nodes || nodes.length === 0) return '<div style="color:#888;">无对话数据</div>';

            // 存储当前对话数据以供分支展开使用
            state.currentDialogData = dialogData;
            let html = '';

            // 第一条对话直接显示，后续需要点击
            nodes.forEach((node, nodeIndex) => {
                const nodeId = `dialogNode_${sceneIndex}_${nodeIndex}`;
                const isFirst = nodeIndex === 0;

                if (isFirst) {
                    // 第一条直接显示
                    html += `
                        <div class="dialog-flow-node visible" id="${nodeId}">
                            ${renderDialogNode(node, dialogFile)}
                        </div>
                    `;
                    // 如果还有下一条，显示"继续"按钮
                    if (nodes.length > 1) {
                        html += `
                            <button class="dialog-next-btn" id="nextBtn_${sceneIndex}_${nodeIndex}" onclick="showNextDialogNode(${sceneIndex}, ${nodeIndex + 1}, ${nodes.length})">
                                ▼ 继续
                            </button>
                        `;
                    }
                } else {
                    // 后续对话初始隐藏（通过CSS控制，没有visible类就隐藏）
                    html += `
                        <div class="dialog-flow-node" id="${nodeId}">
                            ${renderDialogNode(node, dialogFile)}
                        </div>
                    `;
                    // 如果还有下一条，显示"继续"按钮（初始隐藏）
                    if (nodeIndex < nodes.length - 1) {
                        html += `
                            <button class="dialog-next-btn hidden" id="nextBtn_${sceneIndex}_${nodeIndex}" onclick="showNextDialogNode(${sceneIndex}, ${nodeIndex + 1}, ${nodes.length})">
                                ▼ 继续
                            </button>
                        `;
                    }
                }
            });

            return html;
        }

        // 显示下一条对话节点
        window.showNextDialogNode = function(sceneIndex, nodeIndex, totalNodes) {
            // 隐藏当前的"继续"按钮
            const prevBtn = document.getElementById(`nextBtn_${sceneIndex}_${nodeIndex - 1}`);
            if (prevBtn) prevBtn.classList.add('hidden');

            // 显示下一条对话
            const nextNode = document.getElementById(`dialogNode_${sceneIndex}_${nodeIndex}`);
            if (nextNode) {
                nextNode.classList.add('visible');
            }

            // 如果还有更多，显示下一个"继续"按钮并滚动到它
            if (nodeIndex < totalNodes - 1) {
                const nextBtn = document.getElementById(`nextBtn_${sceneIndex}_${nodeIndex}`);
                if (nextBtn) {
                    nextBtn.classList.remove('hidden');
                    setTimeout(() => {
                        nextBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 50);
                }
            } else {
                // 最后一条对话，显示证据列表（如果有的话）
                const evidenceList = document.getElementById(`evidenceList_${sceneIndex}`);
                if (evidenceList) {
                    evidenceList.classList.remove('hidden');
                    evidenceList.classList.add('fade-in');
                    setTimeout(() => {
                        evidenceList.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                }
                // 滚动到最后一条对话
                if (nextNode) {
                    setTimeout(() => {
                        nextNode.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 50);
                }
            }
        };

        // 切换场景对话显示（旧版兼容）
        window.toggleSceneDialog = function(btn, index) {
            const card = btn.closest('.scene-card');
            const content = card.querySelector('.scene-dialog-content');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = '收起对话';
            } else {
                content.style.display = 'none';
                btn.textContent = '展开对话';
            }
        };

        // 渲染指证环节
        async function renderExpose(container) {
            if (!state.loopData?.expose) {
                container.innerHTML = '<div class="error-box"><h3>无指证数据</h3></div>';
                return;
            }

            const expose = state.loopData.expose;
            const targetNpc = state.masterData.npcs[expose.target] || {};
            const isFlowMode = state.viewMode === 'flow';

            // 加载指证对话文件
            let accusationDialogs = null;
            if (expose.dialog_file) {
                try {
                    const dialogPath = `${state.currentUnit}/dialogs/${expose.dialog_file}`;
                    accusationDialogs = await loadYaml(dialogPath);
                } catch (e) {
                    console.warn('无法加载指证对话文件:', e);
                }
            }

            // 分类段落：opening在前，round段落，其他段落在后
            let openingSections = [];
            let endingSections = [];

            // 兼容两种数据格式：sections格式 和 直接字段格式
            if (accusationDialogs?.sections) {
                // 新格式：sections.opening, sections.round1 等
                Object.keys(accusationDialogs.sections).forEach(key => {
                    if (key.startsWith('round')) return;
                    const section = accusationDialogs.sections[key];
                    if (section.lines && section.lines.length > 0) {
                        if (key === 'opening' || key.includes('intro') || key.includes('start')) {
                            openingSections.push({ key, section });
                        } else {
                            endingSections.push({ key, section });
                        }
                    }
                });
            } else if (accusationDialogs) {
                // 旧格式：opening.lines, rounds[].dialog, truth_reveal.lines 等
                if (accusationDialogs.opening?.lines?.length > 0) {
                    openingSections.push({ key: 'opening', section: { lines: accusationDialogs.opening.lines, description: '开场对话' } });
                }
                if (accusationDialogs.truth_reveal?.lines?.length > 0) {
                    endingSections.push({ key: 'truth_reveal', section: { lines: accusationDialogs.truth_reveal.lines, description: '真相揭露' } });
                }
            }

            // 从accusation YAML中获取轮次对话的辅助函数
            function getRoundDialogs(roundNum) {
                // 新格式：sections.roundX.lines
                if (accusationDialogs?.sections?.[`round${roundNum}`]?.lines) {
                    return accusationDialogs.sections[`round${roundNum}`].lines;
                }
                // 旧格式：rounds数组中找到对应round的dialog
                if (accusationDialogs?.rounds) {
                    const roundData = accusationDialogs.rounds.find(r => r.round === roundNum);
                    if (roundData?.dialog) {
                        return roundData.dialog;
                    }
                }
                return [];
            }

            let html = `
                <div class="expose-section">
                    <div class="expose-header">
                        <h3>指证环节</h3>
                        <div class="target-info">
                            <strong>指证对象:</strong> ${expose.target_name || targetNpc.name_cn || expose.target}<br>
                            <strong>场景:</strong> ${expose.scene_name || expose.scene}<br>
                            <strong>设计理念:</strong> ${expose.design_concept || ''}
                        </div>
                    </div>
            `;

            if (isFlowMode) {
                // 流程版：先显示开场对话按钮
                if (openingSections.length > 0) {
                    html += '<div class="expose-extra-buttons">';
                    openingSections.forEach((item, idx) => {
                        html += `
                            <button class="expose-extra-btn" onclick="toggleExposeExtra('opening_${idx}')">
                                🎬 ${item.section.description || item.key}
                                <span class="round-arrow">▼</span>
                            </button>
                            <div class="expose-extra-content" id="exposeExtra_opening_${idx}" style="display:none;">
                                <div class="sequential-dialog" data-section="opening_${idx}">
                                    ${renderSequentialDialogLines(item.section.lines, 'opening_' + idx)}
                                </div>
                                <button class="next-line-btn" onclick="showNextDialogLine('opening_${idx}')">
                                    ▶ 下一句
                                </button>
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                // 流程版：显示轮次按钮和对应内容（每个按钮后紧跟其内容）
                html += '<div class="expose-rounds-buttons">';
                expose.rounds?.forEach((round, index) => {
                    const roundDialogs = getRoundDialogs(round.round);
                    html += `
                        <button class="expose-round-btn" onclick="toggleExposeRound(${index})">
                            <span class="round-num">${round.round}</span>
                            <span class="round-name">${round.name || `第${round.round}轮`}</span>
                            <span class="round-arrow">▼</span>
                        </button>
                    `;
                    html += renderExposeRoundFlow(round, index, roundDialogs);
                });
                html += '</div>';

                // 流程版：结尾段落按钮
                if (endingSections.length > 0) {
                    html += '<div class="expose-extra-buttons expose-ending-buttons">';
                    endingSections.forEach((item, idx) => {
                        html += `
                            <button class="expose-extra-btn ending-btn" onclick="toggleExposeExtra('ending_${idx}')">
                                📖 ${item.section.description || item.key}
                                <span class="round-arrow">▼</span>
                            </button>
                            <div class="expose-extra-content" id="exposeExtra_ending_${idx}" style="display:none;">
                                <div class="sequential-dialog" data-section="ending_${idx}">
                                    ${renderSequentialDialogLines(item.section.lines, 'ending_' + idx)}
                                </div>
                                <button class="next-line-btn" onclick="showNextDialogLine('ending_${idx}')">
                                    ▶ 下一句
                                </button>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
            } else {
                // 完整版：先显示开场对话
                openingSections.forEach(item => {
                    html += `
                        <div class="expose-extra-section opening-section">
                            <div class="extra-section-header">🎬 ${item.section.description || item.key}</div>
                            <div class="dialog-nodes">
                                ${renderAccusationDialogLines(item.section.lines)}
                            </div>
                        </div>
                    `;
                });

                // 完整版：显示所有轮次
                expose.rounds?.forEach(round => {
                    const roundDialogs = getRoundDialogs(round.round);
                    html += renderExposeRoundFull(round, roundDialogs);
                });

                // 完整版：结尾段落
                endingSections.forEach(item => {
                    html += `
                        <div class="expose-extra-section">
                            <div class="extra-section-header">📖 ${item.section.description || item.key}</div>
                            <div class="dialog-nodes">
                                ${renderAccusationDialogLines(item.section.lines)}
                            </div>
                        </div>
                    `;
                });
            }

            html += '</div>';
            container.innerHTML = html;
        }

        // 渲染顺序展示的对话行（体验版用）
        function renderSequentialDialogLines(lines, sectionId) {
            if (!lines || lines.length === 0) return '';
            return lines.map((line, idx) => {
                const npc = state.masterData.npcs[line.speaker] || {};
                const speakerName = npc.name_cn || line.speaker || '旁白';
                const speakerClass = line.speaker?.toLowerCase() || '';
                const isFirst = idx === 0;
                return `
                    <div class="dialog-node speaker sequential-line" data-line-idx="${idx}" style="display: ${isFirst ? 'block' : 'none'};">
                        <div class="speaker-name ${speakerClass}">
                            ${speakerName}
                            ${line.emotion ? `<span class="emotion">[${line.emotion}]</span>` : ''}
                        </div>
                        <div class="text">${line.text || ''}</div>
                        ${line.action ? `<div class="action">${line.action}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // 显示下一句对话
        window.showNextDialogLine = function(sectionId) {
            const container = document.querySelector(`[data-section="${sectionId}"]`);
            if (!container) return;

            const lines = container.querySelectorAll('.sequential-line');
            let foundHidden = false;

            for (let i = 0; i < lines.length; i++) {
                if (lines[i].style.display === 'none') {
                    lines[i].style.display = 'block';
                    lines[i].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    foundHidden = true;
                    break;
                }
            }

            // 如果没有更多隐藏的行，隐藏"下一句"按钮
            if (!foundHidden) {
                const btn = container.parentElement.querySelector('.next-line-btn');
                if (btn) btn.style.display = 'none';
            }
        }

        // 切换额外段落显示
        window.toggleExposeExtra = function(id) {
            const content = document.getElementById(`exposeExtra_${id}`);
            if (content) {
                const isVisible = content.style.display !== 'none';
                content.style.display = isVisible ? 'none' : 'block';
            }
        }

        // 渲染指证对话行
        function renderAccusationDialogLines(lines) {
            if (!lines || lines.length === 0) return '';
            return lines.map(line => {
                const npc = state.masterData.npcs[line.speaker] || {};
                const speakerName = npc.name_cn || line.speaker || '旁白';
                const speakerClass = line.speaker?.toLowerCase() || '';
                return `
                    <div class="dialog-node speaker">
                        <div class="speaker-name ${speakerClass}">
                            ${speakerName}
                            ${line.emotion ? `<span class="emotion">[${line.emotion}]</span>` : ''}
                        </div>
                        <div class="text">${line.text || ''}</div>
                        ${line.action ? `<div class="action">${line.action}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // 完整版指证轮次渲染
        function renderExposeRoundFull(round, dialogLines = []) {
            const evidenceNames = round.evidence_names ||
                (round.evidences ? round.evidences.map(id => state.masterData.evidences[id]?.name || id) :
                [state.masterData.evidences[round.evidence]?.name || round.evidence]);

            return `
                <div class="expose-round">
                    <div class="round-header">
                        <div class="round-number">${round.round}</div>
                        <div class="round-title">${round.name || `第${round.round}轮`}</div>
                        ${round.duration ? `<div class="round-duration">${round.duration}</div>` : ''}
                    </div>

                    <div class="lie-box">
                        <div class="label">谎言</div>
                        <div class="content">${round.lie?.content || round.lie || ''}</div>
                        ${round.lie?.source ? `<div style="color:#888;font-size:12px;margin-top:5px;">来源: ${round.lie.source}</div>` : ''}
                    </div>

                    <div class="evidence-box">
                        <div class="label">举证</div>
                        <div class="content">
                            ${round.evidence || round.evidences?.join(', ') || ''}:
                            ${evidenceNames.join(', ')}
                        </div>
                    </div>

                    ${dialogLines.length > 0 ? `
                        <div class="round-dialogs">
                            <div class="label" style="color:#ffd700;margin-bottom:10px;">💬 对话内容</div>
                            <div class="dialog-nodes">
                                ${renderAccusationDialogLines(dialogLines)}
                            </div>
                        </div>
                    ` : ''}

                    <div class="result-box">
                        <div class="label">结果</div>
                        <div class="content">${round.result || ''}</div>
                    </div>
                </div>
            `;
        }

        // 流程版指证轮次渲染（可展开）
        function renderExposeRoundFlow(round, index, dialogLines = []) {
            const evidenceNames = round.evidence_names ||
                (round.evidences ? round.evidences.map(id => state.masterData.evidences[id]?.name || id) :
                [state.masterData.evidences[round.evidence]?.name || round.evidence]);

            return `
                <div class="expose-round expose-round-flow" id="exposeRound_${index}" style="display:none;">
                    <div class="round-header">
                        <div class="round-number">${round.round}</div>
                        <div class="round-title">${round.name || `第${round.round}轮`}</div>
                        ${round.duration ? `<div class="round-duration">${round.duration}</div>` : ''}
                    </div>

                    <div class="flow-step" data-step="lie">
                        <button class="flow-step-btn" onclick="revealExposeStep(${index}, 'lie')">
                            🎭 查看谎言
                        </button>
                        <div class="flow-step-content lie-box" style="display:none;">
                            <div class="label">谎言</div>
                            <div class="content">${round.lie?.content || round.lie || ''}</div>
                            ${round.lie?.source ? `<div style="color:#888;font-size:12px;margin-top:5px;">来源: ${round.lie.source}</div>` : ''}
                        </div>
                    </div>

                    <div class="flow-step" data-step="evidence">
                        <button class="flow-step-btn" onclick="revealExposeStep(${index}, 'evidence')">
                            📋 选择证据
                        </button>
                        <div class="flow-step-content evidence-box" style="display:none;">
                            <div class="label">举证</div>
                            <div class="content">
                                ${round.evidence || round.evidences?.join(', ') || ''}:
                                ${evidenceNames.join(', ')}
                            </div>
                        </div>
                    </div>

                    ${round.zack_dialog ? `
                        <div class="flow-step" data-step="zack">
                            <button class="flow-step-btn" onclick="revealExposeStep(${index}, 'zack')">
                                💬 Zack 质问
                            </button>
                            <div class="flow-step-content dialog-box" style="display:none;">
                                <div class="speaker-tag">Zack 质问</div>
                                <div class="dialog-text">${round.zack_dialog}</div>
                            </div>
                        </div>
                    ` : ''}

                    ${round.rosa_reaction ? `
                        <div class="flow-step" data-step="reaction">
                            <button class="flow-step-btn" onclick="revealExposeStep(${index}, 'reaction')">
                                😰 对方反应
                            </button>
                            <div class="flow-step-content dialog-box" style="display:none;">
                                <div class="speaker-tag rosa">
                                    Rosa 反应
                                    <span class="emotion-tag">${round.rosa_reaction.emotion || ''}</span>
                                </div>
                                <div class="dialog-text">${round.rosa_reaction.dialog || ''}</div>
                            </div>
                        </div>
                    ` : ''}

                    ${dialogLines.length > 0 ? `
                        <div class="flow-step" data-step="dialog">
                            <button class="flow-step-btn" onclick="revealExposeStep(${index}, 'dialog')">
                                💬 详细对话
                            </button>
                            <div class="flow-step-content round-dialogs" style="display:none;">
                                <div class="sequential-dialog" data-section="round_${index}">
                                    ${renderSequentialDialogLines(dialogLines, 'round_' + index)}
                                </div>
                                <button class="next-line-btn" onclick="showNextDialogLine('round_${index}')">
                                    ▶ 下一句
                                </button>
                            </div>
                        </div>
                    ` : ''}

                    <div class="flow-step" data-step="result">
                        <button class="flow-step-btn" onclick="revealExposeStep(${index}, 'result')">
                            ✅ 查看结果
                        </button>
                        <div class="flow-step-content result-box" style="display:none;">
                            <div class="label">结果</div>
                            <div class="content">${round.result || ''}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 切换指证轮次显示
        window.toggleExposeRound = function(index) {
            const round = document.getElementById(`exposeRound_${index}`);
            const btn = document.querySelectorAll('.expose-round-btn')[index];

            if (round) {
                const isVisible = round.style.display !== 'none';
                round.style.display = isVisible ? 'none' : 'block';
                btn.classList.toggle('active', !isVisible);

                // 展开时，滚动到第一个步骤按钮
                if (!isVisible) {
                    const firstStepBtn = round.querySelector('.flow-step-btn');
                    if (firstStepBtn) {
                        setTimeout(() => {
                            firstStepBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 50);
                    }
                }
            }
        };

        // 展示指证步骤
        window.revealExposeStep = function(roundIndex, step) {
            const round = document.getElementById(`exposeRound_${roundIndex}`);
            const stepDiv = round.querySelector(`.flow-step[data-step="${step}"]`);

            if (stepDiv) {
                const btn = stepDiv.querySelector('.flow-step-btn');
                const content = stepDiv.querySelector('.flow-step-content');

                if (btn && content) {
                    btn.style.display = 'none';
                    content.style.display = 'block';

                    // 找到下一个未展开的步骤按钮，滚动到它
                    const nextStepBtn = round.querySelector('.flow-step-btn:not([style*="display: none"])');
                    if (nextStepBtn) {
                        setTimeout(() => {
                            nextStepBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 50);
                    } else {
                        // 如果没有下一个按钮（所有步骤都展开了），滚动到当前内容
                        setTimeout(() => {
                            content.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 50);
                    }
                }
            }
        };

        // 渲染正常结尾的辅助函数
        function renderNormalEnding(ending, dialogData, isFlowMode) {
            let html = '';

            if (isFlowMode) {
                // 流程版：显示按钮，点击展开，对话逐条显示
                const nodes = getDialogNodes(dialogData, 'ending_scene');

                html += `
                    <div class="ending-buttons">
                        <button class="ending-btn" onclick="toggleEndingDialog()">
                            <span>🎬</span> 查看结尾对话
                            <span class="ending-arrow">▼</span>
                        </button>
                        <button class="ending-btn transition-btn" onclick="toggleEndingTransition()">
                            <span>➡️</span> 查看过渡信息
                            <span class="ending-arrow">▼</span>
                        </button>
                    </div>

                    <div class="dialog-section ending-dialog-content" id="endingDialog" style="display:none;">
                        <div class="scene-header">
                            <h3>循环结尾</h3>
                            <p>${ending.description || ''}</p>
                        </div>
                        <div class="dialog-flow-container" id="endingDialogFlow">
                            ${renderEndingDialogFlow(nodes)}
                        </div>
                    </div>

                    <div class="ending-transition-content" id="endingTransition" style="display:none; margin-top:20px; padding:15px; background:rgba(255,215,0,0.1); border-radius:8px;">
                        <div style="color:#ffd700; margin-bottom:10px;">过渡信息</div>
                        <div style="color:#ccc;">
                            <strong>下一循环:</strong> ${ending.transition_to || '无'}<br>
                            <strong>下一目标:</strong> ${ending.next_objective || '无'}
                        </div>
                    </div>
                `;
            } else {
                // 完整版：直接显示所有内容
                // 存储当前对话数据以供分支展开使用
                if (dialogData) {
                    state.currentDialogData = dialogData;
                }

                html = `
                    <div class="dialog-section">
                        <div class="scene-header">
                            <h3>循环结尾</h3>
                            <p>${ending.description || ''}</p>
                        </div>
                        <div class="dialog-nodes">
                `;

                const endingNodes = getDialogNodes(dialogData, 'ending_scene');
                if (endingNodes && endingNodes.length > 0) {
                    endingNodes.forEach(node => {
                        html += renderDialogNode(node);
                    });
                }

                html += `
                        </div>
                    </div>
                    <div style="margin-top:20px; padding:15px; background:rgba(255,215,0,0.1); border-radius:8px;">
                        <div style="color:#ffd700; margin-bottom:10px;">过渡信息</div>
                        <div style="color:#ccc;">
                            <strong>下一循环:</strong> ${ending.transition_to || '无'}<br>
                            <strong>下一目标:</strong> ${ending.next_objective || '无'}
                        </div>
                    </div>
                `;
            }

            return html;
        }

        // 渲染结尾
        function renderEnding(container) {
            if (!state.loopData?.ending) {
                container.innerHTML = '<div class="error-box"><h3>无结尾数据</h3></div>';
                return;
            }

            const ending = state.loopData.ending;

            // 检查是否包含下一循环opening（不显示missing提示）
            if (ending.includes_next_loop_opening === true) {
                const dialogData = state.dialogs[ending.dialog_file];
                const isFlowMode = state.viewMode === 'flow';

                // 正常显示ending，但添加提示信息
                let html = renderNormalEnding(ending, dialogData, isFlowMode);

                // 添加提示：包含下一循环opening
                html += `
                    <div class="next-loop-hint">
                        <div class="hint-icon">ℹ️</div>
                        <div class="hint-content">
                            <strong>提示：</strong>此结尾对话已包含下一循环的开篇内容
                        </div>
                    </div>
                `;

                container.innerHTML = html;
                return;
            }

            // 正常渲染结尾
            const dialogData = state.dialogs[ending.dialog_file];
            const isFlowMode = state.viewMode === 'flow';
            container.innerHTML = renderNormalEnding(ending, dialogData, isFlowMode);
        }

        // 切换结尾对话显示
        window.toggleEndingDialog = function() {
            const dialog = document.getElementById('endingDialog');
            const btn = document.querySelector('.ending-btn:not(.transition-btn)');

            if (dialog) {
                const isVisible = dialog.style.display !== 'none';
                dialog.style.display = isVisible ? 'none' : 'block';
                btn.classList.toggle('active', !isVisible);

                // 更新当前对话数据以供分支展开使用
                if (!isVisible && state.loopData?.ending?.dialog_file) {
                    state.currentDialogData = state.dialogs[state.loopData.ending.dialog_file];
                }
            }
        };

        // 切换过渡信息显示
        window.toggleEndingTransition = function() {
            const transition = document.getElementById('endingTransition');
            const btn = document.querySelector('.ending-btn.transition-btn');

            if (transition) {
                const isVisible = transition.style.display !== 'none';
                transition.style.display = isVisible ? 'none' : 'block';
                btn.classList.toggle('active', !isVisible);
            }
        };

        // 渲染结尾对话（流程版：逐条展开）
        function renderEndingDialogFlow(nodes) {
            if (!nodes || nodes.length === 0) return '<div style="color:#888;">无对话数据</div>';

            let html = '';

            nodes.forEach((node, nodeIndex) => {
                const nodeId = `endingNode_${nodeIndex}`;
                const isFirst = nodeIndex === 0;

                if (isFirst) {
                    html += `
                        <div class="dialog-flow-node visible" id="${nodeId}">
                            ${renderDialogNode(node)}
                        </div>
                    `;
                    if (nodes.length > 1) {
                        html += `
                            <button class="dialog-next-btn" id="endingNextBtn_${nodeIndex}" onclick="showNextEndingNode(${nodeIndex + 1}, ${nodes.length})">
                                ▼ 继续
                            </button>
                        `;
                    }
                } else {
                    html += `
                        <div class="dialog-flow-node" id="${nodeId}">
                            ${renderDialogNode(node)}
                        </div>
                    `;
                    if (nodeIndex < nodes.length - 1) {
                        html += `
                            <button class="dialog-next-btn hidden" id="endingNextBtn_${nodeIndex}" onclick="showNextEndingNode(${nodeIndex + 1}, ${nodes.length})">
                                ▼ 继续
                            </button>
                        `;
                    }
                }
            });

            return html;
        }

        // 显示下一条结尾对话节点
        window.showNextEndingNode = function(nodeIndex, totalNodes) {
            const prevBtn = document.getElementById(`endingNextBtn_${nodeIndex - 1}`);
            if (prevBtn) prevBtn.classList.add('hidden');

            const nextNode = document.getElementById(`endingNode_${nodeIndex}`);
            if (nextNode) {
                nextNode.classList.add('visible');
            }

            if (nodeIndex < totalNodes - 1) {
                const nextBtn = document.getElementById(`endingNextBtn_${nodeIndex}`);
                if (nextBtn) {
                    nextBtn.classList.remove('hidden');
                    setTimeout(() => {
                        nextBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 50);
                }
            } else {
                if (nextNode) {
                    setTimeout(() => {
                        nextNode.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 50);
                }
            }
        };

        // 显示错误
        function showError(message) {
            document.getElementById('mainContent').innerHTML = `
                <div class="error-box">
                    <h3>加载失败</h3>
                    <p>${message}</p>
                    <p style="margin-top:10px;font-size:12px;color:#888;">
                        请确保数据文件存在且格式正确。<br>
                        如果使用本地文件，需要通过HTTP服务器访问。
                    </p>
                </div>
            `;
        }

        // 启动
        init();

        // ========== 编辑功能 ==========
        let isEditMode = false;
        let currentEditingNode = null;

        // 切换编辑模式
        document.getElementById('editModeBtn').addEventListener('click', function() {
            isEditMode = !isEditMode;
            this.classList.toggle('active', isEditMode);

            if (isEditMode) {
                this.style.background = 'rgba(255, 215, 0, 0.3)';
                this.style.color = '#ffd700';
                this.style.borderColor = '#ffd700';
                document.getElementById('mainContent').classList.add('edit-mode');
                alert('✏️ 编辑模式已开启\
\
点击任意对话行即可编辑。\
编辑后点击"📥 导出"可下载YAML文件。');
            } else {
                this.style.background = 'rgba(52, 152, 219, 0.2)';
                this.style.color = '#3498db';
                this.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                document.getElementById('mainContent').classList.remove('edit-mode');
            }
        });

        // 使用事件委托处理对话点击（动态加载的内容也能响应）
        document.getElementById('mainContent').addEventListener('click', function(e) {
            if (!isEditMode) return;

            // 找到被点击的 .dialog-node 元素
            const line = e.target.closest('.dialog-node');
            if (!line) return;

            e.stopPropagation();
            currentEditingNode = line;

            // 获取说话人名字
            const speakerNameEl = line.querySelector('.speaker-name');
            let speaker = '';
            if (speakerNameEl) {
                const firstText = speakerNameEl.childNodes[0];
                speaker = firstText?.textContent?.trim() || '';
            }

            const text = line.querySelector('.text')?.textContent || '';

            // 情感在 .emotion 类里
            const emotionEl = line.querySelector('.emotion');
            let emotion = '';
            if (emotionEl) {
                emotion = emotionEl.textContent?.replace(/[\[\]]/g, '') || '';
            }

            const action = line.querySelector('.action')?.textContent || '';

            document.getElementById('editSpeaker').value = speaker;
            document.getElementById('editText').value = text;
            document.getElementById('editEmotion').value = emotion;
            document.getElementById('editAction').value = action;

            document.getElementById('editModal').classList.add('active');
        });

        // 关闭编辑弹窗
        window.closeEditModal = function() {
            document.getElementById('editModal').classList.remove('active');
            currentEditingNode = null;
        }

        // 保存编辑
        window.saveEdit = function() {
            const newSpeaker = document.getElementById('editSpeaker').value.trim();
            const newText = document.getElementById('editText').value.trim();
            const newEmotion = document.getElementById('editEmotion').value.trim();
            const newAction = document.getElementById('editAction').value.trim();

            if (!newText && !newAction) {
                alert('对话内容和动作描述至少填写一项!');
                return;
            }

            if (currentEditingNode) {
                const speakerNameEl = currentEditingNode.querySelector('.speaker-name');
                const textEl = currentEditingNode.querySelector('.text');
                const emotionEl = currentEditingNode.querySelector('.emotion');
                const actionEl = currentEditingNode.querySelector('.action');

                // 更新说话人名字
                if (speakerNameEl && newSpeaker) {
                    const firstTextNode = speakerNameEl.childNodes[0];
                    if (firstTextNode && firstTextNode.nodeType === Node.TEXT_NODE) {
                        firstTextNode.textContent = newSpeaker + ' ';
                    }
                }
                if (textEl) textEl.textContent = newText;
                if (emotionEl && newEmotion) emotionEl.textContent = '[' + newEmotion + ']';
                if (actionEl && newAction) actionEl.textContent = newAction;

                currentEditingNode.classList.add('edited');
            }

            closeEditModal();
            console.log('对话已编辑');
        }

        // 导出YAML
        document.getElementById('exportBtn').addEventListener('click', function() {
            try {
                const dialogLines = document.querySelectorAll('.dialog-node');
                const loop = document.getElementById('loopSelect').value;

                if (!loop) {
                    alert('请先选择一个循环!');
                    return;
                }

                if (dialogLines.length === 0) {
                    alert('当前页面没有可导出的对话内容!');
                    return;
                }

                const exportData = {
                    dialog_id: 'loop' + loop + '_edited_' + Date.now(),
                    loop: parseInt(loop),
                    type: 'edited',
                    edited_at: new Date().toISOString(),
                    editor_note: '此文件由剧情预览器编辑功能导出',
                    sections: {
                        main: {
                            description: '编辑后的对话',
                            lines: []
                        }
                    }
                };

                dialogLines.forEach(line => {
                    const speaker = line.querySelector('.speaker')?.textContent.trim() || '';
                    const text = line.querySelector('.text')?.textContent.trim() || '';
                    const emotion = line.querySelector('.emotion-badge')?.textContent.trim() || '';
                    const action = line.querySelector('.action')?.textContent.trim() || '';

                    const lineData = {};
                    if (speaker) lineData.speaker = speaker;
                    if (emotion) lineData.emotion = emotion;
                    if (action) lineData.action = action;
                    if (text) lineData.text = text;

                    if (Object.keys(lineData).length > 0) {
                        exportData.sections.main.lines.push(lineData);
                    }
                });

                const yamlString = jsyaml.dump(exportData, {
                    indent: 2,
                    lineWidth: -1,
                    noRefs: true
                });

                const blob = new Blob([yamlString], { type: 'text/yaml;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'loop' + loop + '_edited_' + new Date().toISOString().slice(0,10) + '.yaml';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                alert('✅ 导出成功!\
\
YAML文件已下载，包含 ' + exportData.sections.main.lines.length + ' 条对话。');
            } catch (error) {
                console.error('导出失败:', error);
                alert('❌ 导出失败: ' + error.message);
            }
        });

        // ESC关闭弹窗
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('editModal').classList.contains('active')) {
                closeEditModal();
            }
        });

        // 点击弹窗外部关闭
        document.getElementById('editModal')?.addEventListener('click', function(e) {
            if (e.target === this) closeEditModal();
        });
    </script>

    <!-- 编辑弹窗 -->
    <div class="edit-modal" id="editModal">
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h3>编辑对话</h3>
                <button class="edit-close-btn" onclick="closeEditModal()">×</button>
            </div>
            <div class="edit-field">
                <label>说话人</label>
                <input type="text" id="editSpeaker" placeholder="例如: NPC101">
            </div>
            <div class="edit-field">
                <label>对话内容</label>
                <textarea id="editText" placeholder="输入对话内容..."></textarea>
            </div>
            <div class="edit-field">
                <label>情绪标签 (可选)</label>
                <input type="text" id="editEmotion" placeholder="例如: calm, angry">
            </div>
            <div class="edit-field">
                <label>动作描述 (可选)</label>
                <input type="text" id="editAction" placeholder="例如: 站起来，走向门口">
            </div>
            <div class="edit-actions">
                <button class="edit-cancel-btn" onclick="closeEditModal()">取消</button>
                <button class="edit-save-btn" onclick="saveEdit()">保存</button>
            </div>
        </div>
    </div>
</body>
</html>
