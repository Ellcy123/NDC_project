<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NDC Loop Preview v2.0</title>
    <script src="js-yaml.min.js"></script>

    <style>
        /* ===== CSS Variables - ÈªëÈáëÁ∫¢È´òÂØπÊØîÂ∫¶ÈÖçËâ≤ ===== */
        :root {
            --primary: #0a0a0a;        /* Á∫ØÈªëËÉåÊôØ */
            --secondary: #2a1515;      /* Ê∑±ÈÖíÁ∫¢Âç°Áâá */
            --accent: #b84040;         /* ÊµÖÁ∫¢ËæπÊ°Ü */
            --highlight: #e8c678;      /* ÊµÖÈáëËâ≤ */
            --text-primary: #ffffff;   /* Á∫ØÁôΩÊñáÂ≠ó */
            --text-secondary: #e8c678; /* ÊµÖÈáëËâ≤ÊñáÂ≠ó */
            --warning: #c41e3a;        /* È≤úÁ∫¢Ë≠¶Âëä */
            --success: #4a7c59;        /* Ê∑±Áªø */
            --gold: #e8c678;           /* ÊµÖÈáëËâ≤ */
            --border: #e8c678;         /* ÊµÖÈáëËæπÊ°Ü */
        }

        /* ===== Reset & Base ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: url('1Fcorridor_1.jpg') center/cover fixed;
            color: var(--text-primary);
            line-height: 1.6;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 10, 0.85);
            z-index: -1;
        }

        /* ===== Layout ===== */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Header */
        .header {
            background: var(--secondary);
            padding: 1rem 2rem;
            border-bottom: 2px solid var(--accent);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--highlight);
        }

        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: var(--secondary);
            border-right: 2px solid var(--accent);
            overflow-y: auto;
            padding: 1.5rem 0;
        }

        .sidebar-section {
            margin-bottom: 1.5rem;
        }

        .sidebar-section-title {
            padding: 0.5rem 1.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .sidebar-item {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .sidebar-item:hover {
            background: rgba(232, 198, 120, 0.15);
            border-left-color: var(--highlight);
        }

        .sidebar-item.active {
            background: rgba(232, 198, 120, 0.25);
            border-left-color: var(--highlight);
            color: var(--highlight);
        }

        /* Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }

        /* Section Container */
        .section-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .section-header {
            background: var(--secondary);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border: 1px solid var(--highlight);
            border-left-width: 3px;
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .section-description {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        /* Dialog Node */
        .dialog-node {
            background: var(--secondary);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid var(--accent);
            border-left-width: 3px;
            transition: all 0.2s;
        }

        .dialog-node:hover {
            border-left-color: var(--highlight);
            border-color: var(--highlight);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        .speaker-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }

        .speaker-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--text-primary);
        }

        .speaker-name {
            font-weight: 600;
            font-size: 1.05rem;
        }

        .speaker-emotion {
            padding: 0.25rem 0.75rem;
            background: var(--accent);
            border-radius: 12px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .dialog-content {
            padding-left: 56px;
            color: var(--text-primary);
            font-size: 1rem;
            line-height: 1.8;
        }

        .dialog-action {
            padding-left: 56px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-style: italic;
            margin-top: 0.5rem;
        }

        /* Narration Node - ‰ΩéË∞ÉÊóÅÁôΩÊ†∑Âºè */
        .dialog-node.narration {
            background: rgba(30, 30, 30, 0.7);
            border: none;
            border-radius: 4px;
            padding: 0.75rem 1.5rem;
            margin: 0.75rem 0;
        }

        .dialog-node.narration .dialog-content {
            text-align: center;
            font-style: italic;
            font-size: 0.9rem;
            color: #a0a0a0;
        }

        /* Evidence Card */
        .evidence-card {
            background: rgba(20, 18, 15, 0.95);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 2px solid var(--border);
            transition: all 0.2s;
        }

        .evidence-card:hover {
            border-color: var(--highlight);
            background: rgba(42, 35, 25, 0.9);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.2);
        }

        .evidence-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .evidence-id {
            color: var(--highlight);
            font-weight: 600;
            font-family: monospace;
        }

        .evidence-type {
            padding: 0.25rem 0.5rem;
            background: var(--accent);
            border-radius: 4px;
            font-size: 0.75rem;
            text-transform: uppercase;
        }

        .evidence-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .evidence-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* ========== Round Header (Expose) ========== */
        .round-card {
            margin-bottom: 2rem;
            border: 1px solid var(--highlight);
            border-radius: 8px;
            overflow: hidden;
            background: var(--secondary);
        }

        .round-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            background: linear-gradient(135deg, rgba(60, 45, 25, 0.95) 0%, rgba(42, 35, 21, 0.95) 100%);
            border-bottom: 1px solid rgba(232, 198, 120, 0.5);
        }

        .round-number {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .round-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2.5rem;
            height: 2.5rem;
            background: var(--gold);
            color: var(--primary);
            font-weight: 700;
            font-size: 1.1rem;
            border-radius: 50%;
        }

        .round-title {
            color: var(--highlight);
            font-size: 1.1rem;
            font-weight: 600;
        }

        .round-duration {
            padding: 0.4rem 0.75rem;
            background: rgba(50, 40, 25, 0.95);
            border: 1px solid rgba(232, 198, 120, 0.6);
            border-radius: 4px;
            font-size: 0.85rem;
            color: var(--gold);
            font-weight: 500;
        }

        .round-body {
            padding: 1.25rem;
        }

        /* Player Choice Node */
        .player-choice-node {
            background: var(--secondary);
            border: 1px solid var(--highlight);
            border-left-width: 3px;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .choice-prompt {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--highlight);
            margin-bottom: 1rem;
            text-align: center;
        }

        .choice-options {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .choice-option {
            background: var(--accent);
            border: 1px solid var(--highlight);
            padding: 1rem 1.25rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .choice-option:hover:not(.locked) {
            background: var(--highlight);
            color: var(--primary);
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(232, 198, 120, 0.4);
        }

        .choice-option.locked {
            opacity: 0.6;
            cursor: not-allowed;
            border-color: var(--warning);
            background: rgba(60, 25, 30, 0.9);
        }

        .choice-text {
            flex: 1;
        }

        .choice-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .choice-lock-icon {
            color: var(--warning);
        }

        /* Evidence Analysis Button */
        .evidence-analyze-btn {
            margin-top: 0.75rem;
            padding: 0.5rem 1rem;
            background: var(--gold);
            color: var(--primary);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
            width: 100%;
        }

        .evidence-analyze-btn:hover {
            background: var(--highlight);
            box-shadow: 0 4px 12px rgba(232, 198, 120, 0.5);
        }

        .evidence-analyze-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .evidence-analyzed {
            border-color: var(--gold);
            background: rgba(42, 35, 21, 0.9);
        }

        .evidence-analysis-result {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: rgba(50, 40, 25, 0.95);
            border-left: 3px solid var(--gold);
            border-radius: 4px;
        }

        .evidence-analysis-result .result-label {
            color: var(--gold);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        /* Flow View Mode - ‰ΩìÈ™åÁâàÔºàÊ∏∏Êàè‰ΩìÈ™åÊ®°ÂºèÔºâ*/
        /* ÂØπËØùÊµÅ - ÈÄêÂè•Â±ïÂºÄ */
        .dialog-flow-node {
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .dialog-flow-node.visible {
            opacity: 1;
            max-height: 1000px;
            margin-bottom: 1rem;
        }

        .dialog-next-btn {
            display: block;
            width: 100%;
            max-width: 200px;
            margin: 1rem auto;
            padding: 0.75rem 1.5rem;
            background: var(--accent);
            border: 1px solid var(--highlight);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .dialog-next-btn:hover {
            background: var(--highlight);
            color: var(--primary);
            transform: scale(1.05);
        }

        .dialog-next-btn.hidden {
            display: none;
        }

        /* ËØÅÊçÆÂç°Áâá - ÂèØÊäòÂè† */
        .flow-view .evidence-card {
            cursor: pointer;
        }

        .flow-view .evidence-card .evidence-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .flow-view .evidence-card.expanded .evidence-body {
            max-height: 1000px;
            padding-top: 0.75rem;
        }

        .flow-view .evidence-header {
            position: relative;
            padding-right: 2rem;
        }

        .flow-view .evidence-expand-icon {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            transition: transform 0.3s;
            color: var(--highlight);
        }

        .flow-view .evidence-card.expanded .evidence-expand-icon {
            transform: translateY(-50%) rotate(180deg);
        }

        /* ========== ÂèØÊäòÂè†Ê®°ÂùóÁ≥ªÁªü ========== */
        .collapsible-module {
            margin-bottom: 0.75rem;
        }

        .collapsible-module-btn {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(42, 35, 25, 0.95);
            border: 1px solid rgba(139, 115, 85, 0.4);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .collapsible-module-btn:hover {
            background: rgba(55, 45, 30, 0.95);
            border-color: rgba(232, 198, 120, 0.5);
        }

        .collapsible-module-btn .module-title {
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.95rem;
        }

        .collapsible-module-btn .module-icon {
            color: var(--highlight);
            font-size: 0.8rem;
            transition: transform 0.3s;
        }

        .collapsible-module-content {
            display: none;
            margin-top: 0.5rem;
            padding: 1rem;
            border-radius: 4px;
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .collapsible-module.expanded .collapsible-module-content {
            display: block;
        }

        .collapsible-module.expanded .module-icon {
            transform: rotate(180deg);
        }

        /* ‰∏çÂêåÁ±ªÂûãÊ®°ÂùóÁöÑÂÜÖÂÆπÂå∫È¢úËâ≤ */
        .collapsible-module-content.type-lie {
            background: rgba(42, 21, 21, 0.95);
            border-left: 3px solid #c41e3a;
        }

        .collapsible-module-content.type-evidence {
            background: rgba(42, 35, 21, 0.95);
            border-left: 3px solid var(--gold);
        }

        .collapsible-module-content.type-dialog {
            background: rgba(35, 30, 25, 0.95);
            border-left: 3px solid var(--accent);
        }

        .collapsible-module-content.type-result {
            background: rgba(25, 42, 30, 0.95);
            border-left: 3px solid #2ecc71;
        }

        /* ÂºÄÂèëÁâàÊ®°ÂºèÔºöÊâÄÊúâÊ®°ÂùóÂº∫Âà∂Â±ïÂºÄ */
        .full-view .collapsible-module-content {
            display: block !important;
        }

        .full-view .collapsible-module-btn {
            cursor: default;
        }

        .full-view .collapsible-module-btn .module-icon {
            display: none;
        }

        /* ÊóßÁöÑÊäòÂè†Á≥ªÁªüÂÖºÂÆπÔºàÁî®‰∫éOpening/EndingÁ≠âÔºâ */
        .collapsible-section {
            cursor: pointer;
            position: relative;
            margin-top: 1rem;
        }

        .collapsible-section:first-child {
            margin-top: 0;
        }

        .collapsible-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            padding-right: 2.5rem;
            user-select: none;
            background: rgba(42, 35, 25, 0.95);
            border: 1px solid rgba(139, 115, 85, 0.3);
            border-radius: 4px;
        }

        .collapsible-section-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            transition: transform 0.3s;
            color: var(--highlight);
            font-size: 0.9rem;
        }

        .collapsible-section-body {
            margin-top: 0.5rem;
            padding: 1rem 0;
        }

        .flow-view .collapsible-section-body {
            display: none;
        }

        .flow-view .collapsible-section.expanded .collapsible-section-body {
            display: block;
        }

        .flow-view .collapsible-section.expanded .collapsible-section-icon {
            transform: rotate(180deg);
        }

        .full-view .collapsible-section-body {
            display: block !important;
        }

        .full-view .collapsible-section {
            cursor: default;
        }

        .full-view .collapsible-section-icon {
            display: none;
        }

        /* ===== Free Phase Layout ===== */
        .free-phase-wrapper {
            background: var(--secondary);
            border-radius: 8px;
            overflow: hidden;
        }

        .free-phase-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1rem;
            background: rgba(10, 10, 10, 0.3);
            border-bottom: 1px solid var(--border);
        }

        .free-phase-title {
            font-size: 0.95rem;
            color: var(--highlight);
            font-weight: 600;
        }

        .free-phase-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* ‰∫åÁ∫ßÈ°µÁ≠æÔºöÂú∞ÁÇπÈÄâÊã©Âç°Áâá */
        .location-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 0.75rem;
            padding: 1rem;
            background: rgba(10, 10, 10, 0.2);
        }

        .location-card {
            padding: 1rem;
            background: rgba(42, 35, 25, 0.8);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .location-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .location-card.active {
            border-color: var(--highlight);
            background: rgba(232, 198, 120, 0.1);
        }

        .location-card .icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .location-card .name {
            font-size: 1rem;
            font-weight: 600;
            color: var(--highlight);
            margin-bottom: 0.25rem;
        }

        .location-card .type-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Âú∫ÊôØËØ¶ÊÉÖÈù¢Êùø */
        .scene-detail-panel {
            display: none;
            padding: 1rem;
            border-top: 1px solid var(--border);
        }

        .scene-detail-panel.active {
            display: block;
        }

        .scene-detail-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .scene-type-badge {
            padding: 0.4rem 0.75rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .scene-type-badge.search { background: var(--gold); color: var(--primary); }
        .scene-type-badge.npc { background: var(--accent); color: white; }
        .scene-type-badge.story { background: #9b59b6; color: white; }

        .scene-detail-title {
            font-size: 1.2rem;
            color: var(--highlight);
            font-weight: 600;
        }

        .scene-detail-desc {
            color: var(--text);
            margin-bottom: 1rem;
        }

        /* ‰∏âÁ∫ßÈ°µÁ≠æÔºöÂäüËÉΩÈÄâÊã© */
        .function-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .function-tab-btn {
            padding: 0.6rem 1rem;
            background: rgba(42, 35, 25, 0.5);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
            font-family: inherit;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .function-tab-btn:hover {
            border-color: var(--accent);
            color: var(--text);
        }

        .function-tab-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .function-content {
            display: none;
            padding: 1rem;
            background: rgba(10, 10, 10, 0.2);
            border-radius: 6px;
        }

        .function-content.active {
            display: block;
        }

        /* NPC ÂØπËØùÂ§ßÊåâÈíÆ */
        .npc-dialog-btn {
            display: flex;
            align-items: center;
            gap: 1rem;
            width: 100%;
            padding: 1rem 1.25rem;
            background: rgba(42, 35, 25, 0.8);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            margin-bottom: 0.75rem;
        }

        .npc-dialog-btn:hover {
            border-color: var(--highlight);
            background: rgba(232, 198, 120, 0.1);
        }

        .npc-dialog-btn .npc-avatar {
            width: 50px;
            height: 50px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .npc-dialog-btn .npc-info {
            flex: 1;
        }

        .npc-dialog-btn .npc-name {
            font-size: 1.1rem;
            color: var(--highlight);
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .npc-dialog-btn .npc-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .npc-dialog-btn .dialog-action {
            padding: 0.5rem 1rem;
            background: var(--accent);
            color: white;
            border-radius: 4px;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .npc-dialog-btn.expanded {
            border-color: var(--highlight);
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        .npc-dialog-btn.expanded .dialog-action {
            background: var(--highlight);
            color: var(--primary);
        }

        /* NPCËµÑÊ∫êIDÊòæÁ§∫Ôºà‰ªÖÂºÄÂèëÁâàÔºâ */
        .npc-assets-info {
            margin-top: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: rgba(50, 40, 25, 0.8);
            border: 1px dashed var(--gold);
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .npc-assets-info .assets-label {
            color: var(--gold);
            font-weight: 600;
            margin-right: 0.5rem;
        }

        .npc-assets-info code {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
            font-family: monospace;
            color: var(--text-primary);
            margin-right: 0.5rem;
            margin-bottom: 0.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .npc-assets-info code:hover {
            background: rgba(232, 198, 120, 0.3);
            color: var(--gold);
        }

        .npc-assets-info code.copied {
            background: rgba(74, 124, 89, 0.5);
            color: #90EE90;
        }

        .npc-assets-info code.copied::after {
            content: '‚úì';
            margin-left: 0.3rem;
        }

        /* ‰ΩìÈ™åÁâàÈöêËóèËµÑÊ∫êID */
        .flow-view .npc-assets-info {
            display: none;
        }

        /* Â±ïÂºÄÁöÑÂØπËØùÂÜÖÂÆπ */
        .npc-dialog-expand {
            display: none;
            background: rgba(10, 10, 10, 0.4);
            border: 2px solid var(--highlight);
            border-top: none;
            border-radius: 0 0 8px 8px;
            margin-top: -0.75rem;
            margin-bottom: 0.75rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .npc-dialog-expand.active {
            display: block;
        }

        .npc-dialog-expand .dialog-lines {
            padding: 1rem;
        }

        .npc-dialog-expand .dialog-line {
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .npc-dialog-expand .dialog-line:last-child {
            border-bottom: none;
        }

        .npc-dialog-expand .speaker-name {
            font-weight: 600;
            color: var(--highlight);
            margin-bottom: 0.25rem;
        }

        .npc-dialog-expand .dialog-text {
            color: var(--text);
            line-height: 1.5;
        }

        .npc-dialog-expand .dialog-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .npc-dialog-expand .narration {
            color: var(--text-secondary);
            font-style: italic;
        }

        /* Full View Mode - Default */
        .full-view .dialog-node {
            /* Use default styles */
        }

        /* Controls */
        .control-button {
            padding: 0.5rem 1rem;
            background: var(--accent);
            color: var(--text-primary);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .control-button:hover {
            background: var(--highlight);
        }

        .control-button.active {
            background: var(--highlight);
            box-shadow: 0 0 8px rgba(50, 130, 184, 0.5);
        }

        select {
            padding: 0.5rem 1rem;
            background: var(--accent);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        select option {
            background: var(--secondary);
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(3, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* Error State */
        .error {
            background: rgba(60, 25, 25, 0.95);
            border: 2px solid var(--warning);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 2rem 0;
            color: var(--warning);
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--highlight);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }

            .content-area {
                padding: 1rem;
            }

            .header {
                padding: 0.75rem 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-title">NDC Loop Preview v2.0</div>
            <div class="header-controls">
                <select id="unitSelect">
                    <option value="Unit1">Unit 1</option>
                </select>
                <select id="loopSelect">
                    <option value="loop1">Loop 1</option>
                    <option value="loop2">Loop 2</option>
                    <option value="loop3">Loop 3</option>
                    <option value="loop4">Loop 4</option>
                    <option value="loop5">Loop 5</option>
                    <option value="loop6">Loop 6</option>
                </select>
                <button class="control-button active" id="viewModeBtn">ÂºÄÂèëÁâà</button>
                <button class="control-button" id="editModeBtn">‚úèÔ∏è ÁºñËæë</button>
                <button class="control-button" id="exportBtn" style="background: rgba(46, 204, 113, 0.2); color: #2ecc71;">üì• ÂØºÂá∫</button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <nav class="sidebar">
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Navigation</div>
                    <div class="sidebar-item active" data-section="opening">Opening</div>
                    <div class="sidebar-item" data-section="free_phase">Free Phase</div>
                    <div class="sidebar-item" data-section="expose">Expose</div>
                    <div class="sidebar-item" data-section="ending">Ending</div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-title">Data</div>
                    <div class="sidebar-item" data-section="scenes">Scenes</div>
                    <div class="sidebar-item" data-section="npcs">NPCs</div>
                    <div class="sidebar-item" data-section="evidences">Evidences</div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-title">üõ†Ô∏è Debug</div>
                    <div class="sidebar-item" data-section="player_state">Player State</div>
                    <div class="sidebar-item" data-section="test_conditional">Test Conditional</div>
                </div>
            </nav>

            <!-- Content Area -->
            <main class="content-area">
                <div id="contentContainer">
                    <div class="loading">Loading data</div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // ===== Global State =====
        const AppState = {
            currentUnit: 'Unit1',
            currentLoop: 'loop1',
            currentSection: 'opening',
            viewMode: 'full', // 'flow'=‰ΩìÈ™åÁâà or 'full'=ÂºÄÂèëÁâà
            editMode: false,

            // Loaded Data
            masterData: {
                scenes: {},
                npcs: {},
                evidences: {}
            },
            loopData: null,
            dialogData: {},

            // Current Dialog Context
            currentDialogFile: null,
            currentDialogData: null,
            currentDialogSections: [],

            // Player State (for future use)
            playerState: {
                evidences: new Set(),
                analyzedEvidences: new Set(),
                variables: {}
            }
        };

        // ===== Data Loader =====
        const DataLoader = {
            async loadYAML(path) {
                try {
                    // Check if js-yaml library is loaded
                    if (typeof jsyaml === 'undefined') {
                        throw new Error('js-yaml library not loaded. Please check CDN connection.');
                    }
                    const response = await fetch(path);
                    if (!response.ok) {
                        throw new Error(`Failed to load ${path}: ${response.statusText}`);
                    }
                    const text = await response.text();
                    return jsyaml.load(text);
                } catch (error) {
                    console.error(`Error loading ${path}:`, error.message || error);
                    throw error;
                }
            },

            async loadMasterData(unit) {
                // Master data is shared across all units, stored in data/master/
                const basePath = `data/master`;
                try {
                    const [scenesData, npcsData, evidencesData] = await Promise.all([
                        this.loadYAML(`${basePath}/scenes.yaml`),
                        this.loadYAML(`${basePath}/npcs.yaml`),
                        this.loadYAML(`${basePath}/evidences.yaml`)
                    ]);

                    // Extract data from wrapper keys (scenes:, npcs:, evidences:)
                    AppState.masterData.scenes = scenesData.scenes || scenesData;
                    AppState.masterData.npcs = npcsData.npcs || npcsData;
                    AppState.masterData.evidences = evidencesData.evidences || evidencesData;

                    console.log('Master data loaded:', AppState.masterData);
                    return AppState.masterData;
                } catch (error) {
                    console.error('Error loading master data:', error);
                    throw error;
                }
            },

            async loadLoopData(unit, loopNum) {
                const path = `data/${unit}/loops/${loopNum}.yaml`;
                try {
                    const data = await this.loadYAML(path);
                    AppState.loopData = data;
                    console.log('Loop data loaded:', data);
                    return data;
                } catch (error) {
                    console.error('Error loading loop data:', error);
                    throw error;
                }
            },

            async loadDialogFile(unit, dialogPath) {
                const path = `data/${unit}/dialogs/${dialogPath}`;
                try {
                    const data = await this.loadYAML(path);
                    console.log(`Dialog loaded from ${dialogPath}:`, data);
                    return data;
                } catch (error) {
                    console.error(`Error loading dialog ${dialogPath}:`, error);
                    throw error;
                }
            },

            async loadAllData() {
                try {
                    await this.loadMasterData(AppState.currentUnit);
                    await this.loadLoopData(AppState.currentUnit, AppState.currentLoop);
                    return true;
                } catch (error) {
                    return false;
                }
            }
        };

        // ===== Renderer =====
        const Renderer = {
            container: null,

            init() {
                this.container = document.getElementById('contentContainer');
            },

            // Â§çÂà∂ËµÑÊ∫êIDÂà∞Ââ™Ë¥¥Êùø
            copyToClipboard(element, text) {
                navigator.clipboard.writeText(text).then(() => {
                    // Ê∑ªÂä†Â∑≤Â§çÂà∂Ê†∑Âºè
                    element.classList.add('copied');
                    // 1.5ÁßíÂêéÁßªÈô§Ê†∑Âºè
                    setTimeout(() => {
                        element.classList.remove('copied');
                    }, 1500);
                }).catch(err => {
                    console.error('Â§çÂà∂Â§±Ë¥•:', err);
                    // ÈôçÁ∫ßÊñπÊ°àÔºö‰ΩøÁî®‰º†ÁªüÊñπÊ≥ï
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    element.classList.add('copied');
                    setTimeout(() => {
                        element.classList.remove('copied');
                    }, 1500);
                });
            },

            renderError(message) {
                this.container.innerHTML = `
                    <div class="error">
                        <h3>Error Loading Data</h3>
                        <p>${message}</p>
                        <p>Please check the console for details.</p>
                    </div>
                `;
            },

            // NPCÈ¢úËâ≤Êò†Â∞Ñ
            getNpcColor(speakerId) {
                const colorMap = {
                    'NPC101': '#e8c678', // Zack - ÈáëËâ≤
                    'NPC102': '#7eb8da', // Emma - ËìùËâ≤
                    'NPC103': '#e07b7b', // Rosa - Á∫¢Ëâ≤
                    'NPC104': '#c9a86c', // Morrison - Ê£ïÈªÑËâ≤
                    'NPC105': '#8bc88b', // Tommy - ÁªøËâ≤
                    'NPC106': '#d4a5d9', // Vivian - Á¥´Ëâ≤
                    'NPC107': '#f0a060', // Jimmy - Ê©ôËâ≤
                    'NPC108': '#f5b5c8', // Anna - Á≤âËâ≤
                    'NPC109': '#a0a0a0', // Webb - ÁÅ∞Ëâ≤ÔºàÊ≠ªËÄÖÔºâ
                    'NPC110': '#b8d4b8', // Mrs. Morrison - ÊµÖÁªøËâ≤
                };
                return colorMap[speakerId] || '#d4c4a8'; // ÈªòËÆ§Á±≥Ëâ≤
            },

            // NPCÂ§¥ÂÉèemojiÊò†Â∞ÑÔºàÊ†πÊçÆ‰∫∫ËÆæÔºâ
            getNpcEmoji(speakerId) {
                const emojiMap = {
                    'NPC101': 'üïµÔ∏è',  // Zack - ÁßÅÂÆ∂‰æ¶Êé¢
                    'NPC102': 'üì∞',  // Emma - ËÆ∞ËÄÖ
                    'NPC103': 'üßπ',  // Rosa - Ê∏ÖÊ¥ÅÂ•≥Â∑•
                    'NPC104': 'üëÆ',  // Morrison - Ë≠¶Êé¢
                    'NPC105': 'üìã',  // Tommy - ÁªèÁêÜ
                    'NPC106': 'üé§',  // Vivian - Ê≠åÂ•≥
                    'NPC107': 'üç≥',  // Jimmy - Âé®Â∏à
                    'NPC108': 'ü§∞',  // Anna - Â≠ïÂ¶á
                    'NPC109': 'üíÄ',  // Webb - Ê≠ªËÄÖ/ËÄÅÊùø
                    'NPC110': 'üë©',  // Mrs. Morrison - Â§™Â§™
                };
                return emojiMap[speakerId] || 'üë§'; // ÈªòËÆ§‰∫∫Áâ©
            },

            renderSection(sectionName) {
                AppState.currentSection = sectionName;

                const renderer = {
                    'opening': () => this.renderOpening(),
                    'free_phase': () => this.renderFreePhase(),
                    'expose': () => this.renderExpose(),
                    'ending': () => this.renderEnding(),
                    'scenes': () => this.renderScenes(),
                    'npcs': () => this.renderNPCs(),
                    'evidences': () => this.renderEvidences(),
                    'player_state': () => this.renderPlayerState(),
                    'test_conditional': () => this.renderTestConditional()
                };

                if (renderer[sectionName]) {
                    renderer[sectionName]();
                } else {
                    this.container.innerHTML = `<div class="error">Section "${sectionName}" not implemented yet.</div>`;
                }
            },

            async renderOpening() {
                const opening = AppState.loopData.opening;
                if (!opening) {
                    this.renderError('No opening data found');
                    return;
                }

                let html = `
                    <div class="section-container">
                        <div class="section-header">
                            <div class="section-title">Opening - ${AppState.loopData.title}</div>
                            <div class="section-description">${opening.description}</div>
                        </div>
                `;

                // Load and render each scene's dialog
                const sceneNumbers = ['‚ë†', '‚ë°', '‚ë¢', '‚ë£', '‚ë§'];
                let sceneIndex = 0;
                for (const scene of opening.scenes) {
                    try {
                        const dialogData = await DataLoader.loadDialogFile(
                            AppState.currentUnit,
                            scene.dialog_file
                        );

                        // Store the dialog data for navigation (last loaded dialog becomes active)
                        AppState.currentDialogFile = scene.dialog_file;
                        AppState.currentDialogData = dialogData;

                        // Render specified section or all sections
                        const sectionToRender = scene.dialog_section;

                        // Get sequence number for multiple scenes
                        const seqNum = opening.scenes.length > 1 ? `${sceneNumbers[sceneIndex]} ` : '';
                        sceneIndex++;

                        // Make each scene a collapsible section (collapsed by default in flow view)
                        html += `
                            <div class="scene-block collapsible-section" onclick="Renderer.toggleCollapsibleSection(this)">
                                <div class="collapsible-section-header" style="position: relative;">
                                    <div>
                                        <h3 style="margin: 0;">${seqNum}${scene.name || scene.scene_id}</h3>
                                        <p class="scene-description" style="margin: 0.25rem 0 0 0;">${scene.description || ''}</p>
                                    </div>
                                    <div class="collapsible-section-icon">‚ñº</div>
                                </div>
                                <div class="collapsible-section-body">
                        `;

                        if (sectionToRender && dialogData[sectionToRender]) {
                            // Render specific section
                            html += this.renderDialogSection(dialogData[sectionToRender], `opening_${sectionToRender}`);
                        } else {
                            // Render all sections (excluding metadata)
                            const metadataKeys = ['dialog_id', 'loop', 'type', 'npc', 'target',
                                                  'expose_info', 'rounds', 'next_loop_hint',
                                                  'evidence_obtained', 'transition_to', 'truth_summary'];
                            for (const [key, section] of Object.entries(dialogData)) {
                                if (!metadataKeys.includes(key)) {
                                    html += this.renderDialogSection(section, `opening_${key}`);
                                }
                            }
                        }

                        html += `
                                </div>
                            </div>
                        `;
                    } catch (error) {
                        console.error(`Error loading dialog ${scene.dialog_file}:`, error);
                        html += `<div class="error">Failed to load dialog: ${scene.dialog_file}</div>`;
                    }
                }

                html += `</div>`;
                this.container.innerHTML = html;
            },

            async renderDialogFile(dialogPath, initialSection = null) {
                try {
                    const dialogData = await DataLoader.loadDialogFile(
                        AppState.currentUnit,
                        dialogPath
                    );

                    // Store dialog context
                    AppState.currentDialogFile = dialogPath;
                    AppState.currentDialogData = dialogData;

                    // Get dialog info
                    const dialogType = dialogData.type || 'dialog';
                    const npcId = dialogData.npc;
                    const npc = npcId ? AppState.masterData.npcs[npcId] : null;

                    let html = `
                        <div class="section-container">
                            <div class="section-header">
                                <div class="section-title">${npc ? `ÂØπËØù: ${npc.name_cn}` : 'Dialog'}</div>
                                <div class="section-description">Type: ${dialogType}</div>
                            </div>
                    `;

                    // Render specified section or first section
                    const metadataKeys = ['dialog_id', 'loop', 'type', 'npc', 'target',
                                          'expose_info', 'rounds', 'next_loop_hint',
                                          'evidence_obtained', 'transition_to', 'truth_summary'];
                    if (initialSection && dialogData[initialSection]) {
                        html += this.renderDialogSection(dialogData[initialSection]);
                    } else {
                        // Render first non-metadata section
                        for (const [key, section] of Object.entries(dialogData)) {
                            if (!metadataKeys.includes(key)) {
                                html += this.renderDialogSection(section);
                                break; // Only render first section
                            }
                        }
                    }

                    html += `</div>`;
                    this.container.innerHTML = html;

                } catch (error) {
                    console.error(`Error loading dialog ${dialogPath}:`, error);
                    this.renderError(`Failed to load dialog: ${dialogPath}`);
                }
            },

            renderDialogSection(section, sectionId = null) {
                if (!section || !section.lines) return '';

                // ‰ΩìÈ™åÁâàÔºöÈÄêÂè•Â±ïÂºÄ
                if (AppState.viewMode === 'flow') {
                    return this.renderDialogSectionFlow(section, sectionId);
                }

                // ÂºÄÂèëÁâàÔºö‰∏ÄÊ¨°ÊÄßÂÖ®ÈÉ®ÊòæÁ§∫
                let html = '';
                for (const line of section.lines) {
                    html += this.renderDialogLine(line);
                }
                return html;
            },

            renderDialogSectionFlow(section, sectionId) {
                if (!section || !section.lines) return '';

                const flowId = sectionId || `flow_${Date.now()}`;
                let html = '';

                section.lines.forEach((line, index) => {
                    const nodeId = `${flowId}_node_${index}`;
                    const isFirst = index === 0;
                    const isLast = index === section.lines.length - 1;

                    // ÊØèÂè•ÂØπËØùÂåÖË£ÖÂú®dialog-flow-node‰∏≠
                    html += `
                        <div class="dialog-flow-node ${isFirst ? 'visible' : ''}" id="${nodeId}">
                            ${this.renderDialogLine(line)}
                        </div>
                    `;

                    // Â¶ÇÊûú‰∏çÊòØÊúÄÂêé‰∏ÄÂè•ÔºåÊ∑ªÂä†"ÁªßÁª≠"ÊåâÈíÆ
                    if (!isLast) {
                        html += `
                            <button class="dialog-next-btn ${isFirst ? '' : 'hidden'}" id="${flowId}_btn_${index}"
                                    onclick="event.stopPropagation(); Renderer.showNextDialogNode('${flowId}', ${index + 1}, ${section.lines.length})">
                                ‚ñº ÁªßÁª≠
                            </button>
                        `;
                    }
                });

                return html;
            },

            showNextDialogNode(flowId, nextIndex, totalCount) {
                // ÈöêËóèÂΩìÂâçÁöÑÁªßÁª≠ÊåâÈíÆ
                const prevBtn = document.getElementById(`${flowId}_btn_${nextIndex - 1}`);
                if (prevBtn) prevBtn.classList.add('hidden');

                // ÊòæÁ§∫‰∏ã‰∏ÄÂè•ÂØπËØù
                const nextNode = document.getElementById(`${flowId}_node_${nextIndex}`);
                if (nextNode) {
                    nextNode.classList.add('visible');
                    // ÊªöÂä®Âà∞Êñ∞ÊòæÁ§∫ÁöÑÂÜÖÂÆπ
                    setTimeout(() => {
                        nextNode.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                }

                // ÊòæÁ§∫‰∏ã‰∏Ä‰∏™ÁªßÁª≠ÊåâÈíÆ
                if (nextIndex < totalCount - 1) {
                    const nextBtn = document.getElementById(`${flowId}_btn_${nextIndex}`);
                    if (nextBtn) nextBtn.classList.remove('hidden');
                }
            },

            renderDialogLine(line) {
                const speaker = line.speaker;

                if (speaker === 'narration') {
                    return `
                        <div class="dialog-node narration">
                            <div class="dialog-content">${line.text}</div>
                        </div>
                    `;
                }

                if (speaker === 'player_choice') {
                    return this.renderPlayerChoice(line);
                }

                // Get NPC data, color and emoji
                const npc = AppState.masterData.npcs[speaker];
                const npcName = npc ? npc.name_cn || npc.name : speaker;
                const avatar = this.getNpcEmoji(speaker);
                const npcColor = this.getNpcColor(speaker);

                return `
                    <div class="dialog-node" style="border-left-color: ${npcColor};">
                        <div class="speaker-info">
                            <div class="speaker-avatar" style="background: ${npcColor};">${avatar}</div>
                            <span class="speaker-name" style="color: ${npcColor};">${npcName}</span>
                        </div>
                        <div class="dialog-content">${line.text}</div>
                        ${line.action ? `<div class="dialog-action">${line.action}</div>` : ''}
                    </div>
                `;
            },

            renderPlayerChoice(choiceLine) {
                if (!choiceLine.options || choiceLine.options.length === 0) {
                    return '<div class="error">No options provided for player choice</div>';
                }

                let html = `
                    <div class="player-choice-node">
                        <div class="choice-prompt">üîç ÈÄâÊã©‰Ω†ÁöÑË°åÂä®</div>
                        <div class="choice-options">
                `;

                for (const option of choiceLine.options) {
                    const isLocked = this.checkRequiredEvidences(option.required_evidences);
                    const lockedClass = isLocked ? 'locked' : '';

                    // Prepare set_variables as JSON string if present
                    const setVarsAttr = option.set_variables
                        ? `data-set-variables='${JSON.stringify(option.set_variables)}'`
                        : '';

                    html += `
                        <div class="choice-option ${lockedClass}"
                             data-next-section="${option.next_section || ''}"
                             ${setVarsAttr}
                             ${!isLocked ? 'onclick="Renderer.handleChoiceClick(this)"' : ''}>
                            <span class="choice-text">${option.text}</span>
                            <span class="choice-indicator">
                                ${isLocked
                                    ? `<span class="choice-lock-icon">üîí ÈúÄË¶ÅËØÅÊçÆ: ${option.required_evidences.join(', ')}</span>`
                                    : `<span>‚Üí ${option.next_section || 'continue'}</span>`
                                }
                            </span>
                        </div>
                    `;
                }

                html += `
                        </div>
                    </div>
                `;

                return html;
            },

            checkRequiredEvidences(requiredEvidences) {
                if (!requiredEvidences || requiredEvidences.length === 0) {
                    return false; // Not locked
                }

                // Check if player has all required evidences
                for (const evId of requiredEvidences) {
                    if (!AppState.playerState.evidences.has(evId)) {
                        return true; // Locked - missing evidence
                    }
                }

                return false; // Not locked - has all evidences
            },

            renderEvidenceCard(evId, evData, note = null, extraInfo = null) {
                const isAnalyzed = AppState.playerState.analyzedEvidences.has(evId);
                const canAnalyze = evData.analysis?.required && !isAnalyzed;

                // Use analyzed names/descriptions if available
                const displayName = isAnalyzed && evData.analysis?.result_name
                    ? evData.analysis.result_name
                    : evData.name;
                const displayDescription = isAnalyzed && evData.analysis?.result_description
                    ? evData.analysis.result_description
                    : (evData.description?.initial || evData.description);

                // ‰ΩìÈ™åÁâàÔºöËØÅÊçÆÂèØÊäòÂè†
                if (AppState.viewMode === 'flow') {
                    return `
                        <div class="evidence-card ${isAnalyzed ? 'evidence-analyzed' : ''}" id="evidence-${evId}"
                             onclick="event.stopPropagation(); Renderer.toggleEvidenceCard('evidence-${evId}')">
                            <div class="evidence-header">
                                <span class="evidence-id">${evId}</span>
                                <span class="evidence-type">${evData.type}</span>
                                <span class="evidence-expand-icon">‚ñº</span>
                            </div>
                            <div class="evidence-name">${displayName}</div>
                            <div class="evidence-body">
                                <div class="evidence-description">${displayDescription}</div>
                                ${note ? `<div class="evidence-note" style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">ËØ¥ÊòéÔºö${note}</div>` : ''}
                                ${extraInfo ? extraInfo : ''}
                                ${canAnalyze ? `
                                    <button class="evidence-analyze-btn" onclick="event.stopPropagation(); Renderer.analyzeEvidence('${evId}')">
                                        üîç ${evData.analysis.action || 'Analyze'}
                                    </button>
                                ` : ''}
                                ${isAnalyzed ? `
                                    <div class="evidence-analysis-result">
                                        <div class="result-label">üîç ÂàÜÊûêÂêé</div>
                                        ${evData.analysis?.result_name ? `<div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">${evData.analysis.result_name}</div>` : ''}
                                        ${evData.analysis?.result_description ? `<div style="font-size: 0.9rem; color: var(--text-secondary);">${evData.analysis.result_description}</div>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }

                // ÂºÄÂèëÁâàÔºöËØÅÊçÆÂÖ®ÈÉ®Â±ïÂºÄÔºàÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°Ôºâ
                return `
                    <div class="evidence-card ${isAnalyzed ? 'evidence-analyzed' : ''}" id="evidence-${evId}"
                         onclick="event.stopPropagation()">
                        <div class="evidence-header">
                            <span class="evidence-id">${evId}</span>
                            <span class="evidence-type">${evData.type}</span>
                        </div>
                        <div class="evidence-name">${displayName}</div>
                        <div class="evidence-description">${displayDescription}</div>
                        ${note ? `<div class="evidence-note" style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">ËØ¥ÊòéÔºö${note}</div>` : ''}
                        ${extraInfo ? extraInfo : ''}
                        ${canAnalyze ? `
                            <button class="evidence-analyze-btn" onclick="Renderer.analyzeEvidence('${evId}')">
                                üîç ${evData.analysis.action || 'Analyze'}
                            </button>
                        ` : ''}
                        ${isAnalyzed ? `
                            <div class="evidence-analysis-result">
                                <div class="result-label">üîç ÂàÜÊûêÂêé</div>
                                ${evData.analysis?.result_name ? `<div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">${evData.analysis.result_name}</div>` : ''}
                                ${evData.analysis?.result_description ? `<div style="font-size: 0.9rem; color: var(--text-secondary);">${evData.analysis.result_description}</div>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            },

            toggleEvidenceCard(cardId) {
                const card = document.getElementById(cardId);
                if (card) {
                    card.classList.toggle('expanded');
                }
            },

            analyzeEvidence(evId) {
                const evData = AppState.masterData.evidences[evId];
                if (!evData || !evData.analysis?.required) {
                    console.error('Cannot analyze evidence:', evId);
                    return;
                }

                // Mark as analyzed
                AppState.playerState.analyzedEvidences.add(evId);
                AppState.playerState.evidences.add(evId);

                console.log('Evidence analyzed:', evId);
                console.log('Analysis result:', evData.analysis.result_name);

                // Update the evidence card in place without re-rendering
                const card = document.getElementById(`evidence-${evId}`);
                if (card) {
                    // Add analyzed styling
                    card.classList.add('evidence-analyzed');

                    // Find and hide the analyze button
                    const analyzeBtn = card.querySelector('.evidence-analyze-btn');
                    if (analyzeBtn) {
                        analyzeBtn.style.display = 'none';
                    }

                    // Build the analysis result panel with analyzed content
                    const analyzedName = evData.analysis?.result_name || '';
                    const analyzedDesc = evData.analysis?.result_description || '';

                    const analysisResultHtml = `
                        <div class="evidence-analysis-result">
                            <div class="result-label">üîç ÂàÜÊûêÂêé</div>
                            ${analyzedName ? `<div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">${analyzedName}</div>` : ''}
                            ${analyzedDesc ? `<div style="font-size: 0.9rem; color: var(--text-secondary);">${analyzedDesc}</div>` : ''}
                        </div>
                    `;

                    // Find the body element to append result
                    const bodyEl = card.querySelector('.evidence-body');
                    if (bodyEl) {
                        bodyEl.insertAdjacentHTML('beforeend', analysisResultHtml);
                    } else {
                        // For full view mode (no body wrapper)
                        card.insertAdjacentHTML('beforeend', analysisResultHtml);
                    }
                }
            },

            handleChoiceClick(element) {
                const nextSection = element.dataset.nextSection;
                const setVariables = element.dataset.setVariables;

                console.log('Player chose:', element.querySelector('.choice-text').textContent);
                console.log('Next section:', nextSection);

                // Set variables if specified (JSON format)
                if (setVariables) {
                    try {
                        const variables = JSON.parse(setVariables);
                        for (const [key, value] of Object.entries(variables)) {
                            this.setVariable(key, value);
                        }
                    } catch (e) {
                        console.error('Failed to parse set_variables:', e);
                    }
                }

                if (!nextSection) {
                    console.error('No next section specified');
                    return;
                }

                // Check if we're in a static rendering context (Expose, Opening, Ending)
                // In these contexts, navigation should scroll to target instead of replacing content
                const isStaticContext = ['opening', 'expose', 'ending'].includes(AppState.currentSection);

                if (isStaticContext) {
                    // Try to scroll to the target section within the current page
                    const targetId = `${AppState.currentSection}-${nextSection}`;
                    const targetElement = document.getElementById(targetId);

                    if (targetElement) {
                        console.log(`Scrolling to section: ${targetId}`);
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else {
                        console.warn(`Cannot navigate in ${AppState.currentSection} context. Target section "${targetId}" not found. Available IDs:`,
                            Array.from(document.querySelectorAll('[id]')).map(el => el.id).filter(id => id.includes(AppState.currentSection)));
                        // Still try regular navigation as fallback
                        this.navigateToSection(nextSection);
                    }
                } else {
                    // Normal navigation for dialog contexts
                    this.navigateToSection(nextSection);
                }
            },

            async navigateToSection(sectionName) {
                if (!AppState.currentDialogData) {
                    console.error('No dialog data loaded');
                    return;
                }

                const sectionData = AppState.currentDialogData[sectionName];
                if (!sectionData) {
                    console.error(`Section "${sectionName}" not found in current dialog`);
                    return;
                }

                // Check if this is a conditional section (has conditions field)
                if (sectionData.conditions && Array.isArray(sectionData.conditions)) {
                    console.log(`Conditional section detected: ${sectionName}`);

                    // Evaluate conditions and automatically navigate to matching section
                    const targetSection = this.evaluateConditions(sectionData.conditions);

                    if (targetSection) {
                        console.log(`Condition matched, navigating to: ${targetSection}`);
                        // Recursively navigate (in case target is also conditional)
                        this.navigateToSection(targetSection);
                        return;
                    } else {
                        console.error('No matching condition found in conditional section');
                        this.renderError(`Êù°‰ª∂Âà§Êñ≠Â§±Ë¥•ÔºöÊú™ÊâæÂà∞ÂåπÈÖçÁöÑÊù°‰ª∂ÂàÜÊîØ`);
                        return;
                    }
                }

                // Normal section - render it
                const sectionHtml = this.renderDialogSection(sectionData, sectionName);

                // Replace content or append? For now, replace the entire content
                this.container.innerHTML = `
                    <div class="section-container">
                        <div class="section-header">
                            <div class="section-title">Section: ${sectionName}</div>
                            <div class="section-description">${sectionData.description || ''}</div>
                        </div>
                        ${sectionHtml}
                    </div>
                `;

                // Scroll to top
                this.container.scrollTop = 0;
            },

            /**
             * Toggle collapsible section (for Flow View)
             * @param {HTMLElement} element - The collapsible section element
             */
            toggleCollapsibleSection(element) {
                element.classList.toggle('expanded');
            },

            /**
             * Toggle collapsible module (new system for Expose)
             * @param {HTMLElement} element - The collapsible module element
             */
            toggleModule(element) {
                // Âú®‰ΩìÈ™åÁâàÊ®°Âºè‰∏ãÊâçÊâßË°åÂàáÊç¢
                if (AppState.viewMode === 'flow') {
                    element.classList.toggle('expanded');
                }
            },

            /**
             * Evaluate conditions array and return the target section
             * @param {Array} conditions - Array of condition objects
             * @returns {string|null} - Target section name or null
             */
            evaluateConditions(conditions) {
                for (const condition of conditions) {
                    // Check has_evidence condition
                    if (condition.has_evidence) {
                        const hasEvidence = AppState.playerState.evidences.has(condition.has_evidence);
                        console.log(`Checking evidence ${condition.has_evidence}: ${hasEvidence}`);

                        if (hasEvidence && condition.next_section) {
                            return condition.next_section;
                        }
                    }

                    // Check has_variable condition
                    else if (condition.has_variable) {
                        const variableResult = this.evaluateVariable(condition.has_variable);
                        console.log(`Checking variable "${condition.has_variable}": ${variableResult}`);

                        if (variableResult && condition.next_section) {
                            return condition.next_section;
                        }
                    }

                    // Check default condition
                    else if (condition.default === true && condition.next_section) {
                        console.log('Using default condition');
                        return condition.next_section;
                    }
                }

                return null;
            },

            /**
             * Evaluate a variable expression
             * Supports: variable_name >= value, variable_name <= value, variable_name == value, etc.
             * @param {string} expression - Variable expression string
             * @returns {boolean} - True if condition is met
             */
            evaluateVariable(expression) {
                // Parse expression like "morrison_trust >= 50"
                const operators = ['>=', '<=', '==', '!=', '>', '<'];
                let operator = null;
                let parts = null;

                for (const op of operators) {
                    if (expression.includes(op)) {
                        operator = op;
                        parts = expression.split(op).map(s => s.trim());
                        break;
                    }
                }

                if (!operator || !parts || parts.length !== 2) {
                    console.error(`Invalid variable expression: ${expression}`);
                    return false;
                }

                const [variableName, targetValue] = parts;
                const currentValue = AppState.playerState.variables[variableName];

                // If variable doesn't exist, treat as 0 or false
                const currentNumeric = currentValue !== undefined ? parseFloat(currentValue) : 0;
                const targetNumeric = parseFloat(targetValue);

                console.log(`Evaluating: ${variableName}(${currentNumeric}) ${operator} ${targetNumeric}`);

                // Evaluate based on operator
                switch (operator) {
                    case '>=':
                        return currentNumeric >= targetNumeric;
                    case '<=':
                        return currentNumeric <= targetNumeric;
                    case '>':
                        return currentNumeric > targetNumeric;
                    case '<':
                        return currentNumeric < targetNumeric;
                    case '==':
                        return currentNumeric === targetNumeric || currentValue == targetValue;
                    case '!=':
                        return currentNumeric !== targetNumeric && currentValue != targetValue;
                    default:
                        return false;
                }
            },

            /**
             * Set or update a player state variable
             * @param {string} variableName - Variable name
             * @param {any} value - Variable value
             */
            setVariable(variableName, value) {
                AppState.playerState.variables[variableName] = value;
                console.log(`Variable set: ${variableName} = ${value}`);
            },

            /**
             * Get a player state variable
             * @param {string} variableName - Variable name
             * @returns {any} - Variable value or undefined
             */
            getVariable(variableName) {
                return AppState.playerState.variables[variableName];
            },

            renderFreePhase() {
                const freePhase = AppState.loopData.free_phase;
                if (!freePhase) {
                    this.renderError('No free phase data found');
                    return;
                }

                // ÊûÑÂª∫Âú∫ÊôØÊï∞ÊçÆ
                const scenesData = freePhase.scenes.map((scene, index) => {
                    const masterScene = AppState.masterData.scenes[scene.scene];
                    return {
                        ...scene,
                        index,
                        masterData: masterScene,
                        name: masterScene?.name || scene.scene,
                        description: masterScene?.description || ''
                    };
                });

                const typeConfig = {
                    search: { icon: 'üîç', label: 'ÊêúÁ¥¢Âú∫ÊôØ', class: 'search' },
                    npc: { icon: 'üí¨', label: 'NPCÂØπËØù', class: 'npc' },
                    story: { icon: 'üìñ', label: 'ÂâßÊÉÖÂú∫ÊôØ', class: 'story' }
                };

                // ÁîüÊàêÂú∞ÁÇπÈÄâÊã©Âç°Áâá
                let locationCardsHtml = '<div class="location-cards">';
                scenesData.forEach((scene, index) => {
                    const config = typeConfig[scene.type] || { icon: 'üìç', label: 'Âú∫ÊôØ', class: '' };
                    locationCardsHtml += `
                        <div class="location-card ${index === 0 ? 'active' : ''}"
                             onclick="Renderer.switchFreePhaseLocation(${index})"
                             data-index="${index}">
                            <div class="icon">${config.icon}</div>
                            <div class="name">${scene.name}</div>
                            <div class="type-label">${config.label}</div>
                        </div>
                    `;
                });
                locationCardsHtml += '</div>';

                // ÁîüÊàêÂú∫ÊôØËØ¶ÊÉÖÈù¢Êùø
                let detailPanelsHtml = '';
                scenesData.forEach((scene, index) => {
                    const sceneType = scene.type || 'unknown';
                    const config = typeConfig[sceneType] || { icon: 'üìç', label: sceneType, class: '' };
                    const hasEvidences = scene.evidences && scene.evidences.length > 0;
                    const hasNpc = scene.npc || (scene.npcs && scene.npcs.length > 0);
                    // NPCÁ±ªÂûãÂú∫ÊôØÈªòËÆ§ÊòæÁ§∫ÂØπËØùÔºåÂÖ∂‰ªñÁ±ªÂûãÈªòËÆ§ÊòæÁ§∫ËØÅÊçÆ
                    const isNpcScene = sceneType === 'npc';
                    const defaultTab = isNpcScene ? 'dialog' : 'evidences';

                    // ÊûÑÂª∫‰∏âÁ∫ßÂäüËÉΩÈ°µÁ≠æ
                    let functionTabsHtml = '<div class="function-tabs">';
                    let functionContentsHtml = '';
                    let dialogTabHtml = '';
                    let dialogContentHtml = '';
                    let evidenceTabHtml = '';
                    let evidenceContentHtml = '';

                    // ËØÅÊçÆÈ°µÁ≠æÔºàÂ¶ÇÊûúÊúâÔºâ
                    if (hasEvidences) {
                        const isActive = defaultTab === 'evidences';
                        evidenceTabHtml = `
                            <button class="function-tab-btn ${isActive ? 'active' : ''}" onclick="Renderer.switchFunctionTab(${index}, 'evidences')">
                                üîç ËØÅÊçÆ (${scene.evidences.length})
                            </button>
                        `;
                        evidenceContentHtml = `<div class="function-content ${isActive ? 'active' : ''}" data-func="evidences">`;
                        evidenceContentHtml += '<div style="display: grid; gap: 0.75rem;">';
                        for (const ev of scene.evidences) {
                            const evData = AppState.masterData.evidences[ev.id];
                            if (evData) {
                                evidenceContentHtml += this.renderEvidenceCard(ev.id, evData, ev.note);
                            }
                        }
                        evidenceContentHtml += '</div></div>';
                    }

                    // NPCÂØπËØùÈ°µÁ≠æÔºàÂ¶ÇÊûúÊúâÔºâ
                    if (hasNpc) {
                        const isActive = defaultTab === 'dialog' || !hasEvidences;
                        dialogTabHtml = `
                            <button class="function-tab-btn ${isActive ? 'active' : ''}" onclick="Renderer.switchFunctionTab(${index}, 'dialog')">
                                üí¨ NPCÂØπËØù
                            </button>
                        `;
                        dialogContentHtml = `<div class="function-content ${isActive ? 'active' : ''}" data-func="dialog">`;

                        let npcIndex = 0;
                        // Â§ÑÁêÜÂçï‰∏™NPC
                        if (scene.npc) {
                            const npcData = AppState.masterData.npcs[scene.npc];
                            if (npcData) {
                                const dialogId = `dialog_${index}_${npcIndex}`;
                                const npcEmoji = this.getNpcEmoji(scene.npc);
                                const npcColor = this.getNpcColor(scene.npc);
                                // ÁîüÊàêNPCËµÑÊ∫êID HTMLÔºà‰ªÖÂºÄÂèëÁâàÊòæÁ§∫Ôºâ
                                const npcAssetsHtml = scene.npc_assets && scene.npc_assets.length > 0
                                    ? `<div class="npc-assets-info">
                                        <span class="assets-label">ËµÑÊ∫êID:</span>
                                        ${scene.npc_assets.map(id => `<code onclick="Renderer.copyToClipboard(this, '${id}')">${id}</code>`).join('')}
                                       </div>`
                                    : '';
                                dialogContentHtml += `
                                    <div class="npc-dialog-btn" id="btn_${dialogId}" onclick="Renderer.toggleNpcDialog('${dialogId}', '${scene.dialog_file}', '${scene.dialog_section || ''}')">
                                        <div class="npc-avatar" style="background: ${npcColor};">${npcEmoji}</div>
                                        <div class="npc-info">
                                            <div class="npc-name" style="color: ${npcColor};">${npcData.name_cn} / ${npcData.name}</div>
                                            <div class="npc-desc">${npcData.description}</div>
                                        </div>
                                        <div class="dialog-action">üí¨ Â±ïÂºÄÂØπËØù</div>
                                    </div>
                                    ${npcAssetsHtml}
                                    <div class="npc-dialog-expand" id="${dialogId}">
                                        <div class="dialog-lines">
                                            <div style="text-align: center; color: var(--text-secondary); padding: 1rem;">Âä†ËΩΩ‰∏≠...</div>
                                        </div>
                                    </div>
                                `;
                                npcIndex++;
                            }
                        }

                        // Â§ÑÁêÜNPCÊï∞ÁªÑ
                        if (scene.npcs && scene.npcs.length > 0) {
                            for (const npcEntry of scene.npcs) {
                                const npcData = AppState.masterData.npcs[npcEntry.npc];
                                if (npcData) {
                                    const dialogId = `dialog_${index}_${npcIndex}`;
                                    const npcEmoji = this.getNpcEmoji(npcEntry.npc);
                                    const npcColor = this.getNpcColor(npcEntry.npc);
                                    // ÁîüÊàêNPCËµÑÊ∫êID HTMLÔºà‰ªÖÂºÄÂèëÁâàÊòæÁ§∫Ôºâ
                                    const npcAssetsHtml = npcEntry.npc_assets && npcEntry.npc_assets.length > 0
                                        ? `<div class="npc-assets-info">
                                            <span class="assets-label">ËµÑÊ∫êID:</span>
                                            ${npcEntry.npc_assets.map(id => `<code onclick="Renderer.copyToClipboard(this, '${id}')">${id}</code>`).join('')}
                                           </div>`
                                        : '';
                                    dialogContentHtml += `
                                        <div class="npc-dialog-btn" id="btn_${dialogId}" onclick="Renderer.toggleNpcDialog('${dialogId}', '${npcEntry.dialog_file}', '${npcEntry.dialog_section || ''}')">
                                            <div class="npc-avatar" style="background: ${npcColor};">${npcEmoji}</div>
                                            <div class="npc-info">
                                                <div class="npc-name" style="color: ${npcColor};">${npcData.name_cn} / ${npcData.name}</div>
                                                <div class="npc-desc">${npcData.description}</div>
                                            </div>
                                            <div class="dialog-action">üí¨ Â±ïÂºÄÂØπËØù</div>
                                        </div>
                                        ${npcAssetsHtml}
                                        <div class="npc-dialog-expand" id="${dialogId}">
                                            <div class="dialog-lines">
                                                <div style="text-align: center; color: var(--text-secondary); padding: 1rem;">Âä†ËΩΩ‰∏≠...</div>
                                            </div>
                                        </div>
                                    `;
                                    npcIndex++;
                                }
                            }
                        }
                        dialogContentHtml += '</div>';
                    }

                    // Ê†πÊçÆÂú∫ÊôØÁ±ªÂûãÂÜ≥ÂÆöÈ°µÁ≠æÈ°∫Â∫èÔºöNPCÂú∫ÊôØÂØπËØùÂú®ÂâçÔºåÂÖ∂‰ªñÂú∫ÊôØËØÅÊçÆÂú®Ââç
                    if (isNpcScene) {
                        functionTabsHtml += dialogTabHtml + evidenceTabHtml;
                        functionContentsHtml = dialogContentHtml + evidenceContentHtml;
                    } else {
                        functionTabsHtml += evidenceTabHtml + dialogTabHtml;
                        functionContentsHtml = evidenceContentHtml + dialogContentHtml;
                    }
                    functionTabsHtml += '</div>';

                    detailPanelsHtml += `
                        <div class="scene-detail-panel ${index === 0 ? 'active' : ''}" data-index="${index}">
                            <div class="scene-detail-header">
                                <span class="scene-type-badge ${config.class}">${config.icon} ${config.label}</span>
                                <span class="scene-detail-title">${scene.name}</span>
                                <span class="scene-id">${scene.scene}</span>
                            </div>
                            <div class="scene-detail-desc">${scene.description}</div>
                            ${functionTabsHtml}
                            ${functionContentsHtml}
                        </div>
                    `;
                });

                const html = `
                    <div class="free-phase-wrapper" id="freePhaseContainer">
                        <div class="free-phase-header">
                            <span class="free-phase-title">üéÆ Free Phase</span>
                            <span class="free-phase-desc">${freePhase.description}</span>
                        </div>
                        ${locationCardsHtml}
                        ${detailPanelsHtml}
                    </div>
                `;

                this.container.innerHTML = html;
            },

            // ÂàáÊç¢Âú∞ÁÇπ
            switchFreePhaseLocation(index) {
                const container = document.getElementById('freePhaseContainer');
                if (!container) return;

                // Êõ¥Êñ∞Âú∞ÁÇπÂç°ÁâáÁä∂ÊÄÅ
                container.querySelectorAll('.location-card').forEach((card, i) => {
                    card.classList.toggle('active', i === index);
                });

                // Êõ¥Êñ∞ËØ¶ÊÉÖÈù¢Êùø
                container.querySelectorAll('.scene-detail-panel').forEach((panel, i) => {
                    panel.classList.toggle('active', i === index);
                });
            },

            // ÂàáÊç¢ÂäüËÉΩÈ°µÁ≠æ
            switchFunctionTab(locationIndex, funcId) {
                const container = document.getElementById('freePhaseContainer');
                if (!container) return;

                const panel = container.querySelectorAll('.scene-detail-panel')[locationIndex];
                if (!panel) return;

                // Êõ¥Êñ∞ÂäüËÉΩÊåâÈíÆÁä∂ÊÄÅ
                panel.querySelectorAll('.function-tab-btn').forEach(btn => {
                    const isTarget = btn.textContent.includes(funcId === 'evidences' ? 'ËØÅÊçÆ' : 'ÂØπËØù');
                    btn.classList.toggle('active', isTarget);
                });

                // Êõ¥Êñ∞ÂäüËÉΩÂÜÖÂÆπÈù¢Êùø
                panel.querySelectorAll('.function-content').forEach(content => {
                    content.classList.toggle('active', content.dataset.func === funcId);
                });
            },

            // Â±ïÂºÄ/Êî∂Ëµ∑NPCÂØπËØù
            async toggleNpcDialog(dialogId, dialogFile, dialogSection) {
                const expandDiv = document.getElementById(dialogId);
                const btn = document.getElementById('btn_' + dialogId);
                if (!expandDiv || !btn) return;

                const isExpanded = expandDiv.classList.contains('active');

                if (isExpanded) {
                    // Êî∂Ëµ∑
                    expandDiv.classList.remove('active');
                    btn.classList.remove('expanded');
                    btn.querySelector('.dialog-action').textContent = 'üí¨ Â±ïÂºÄÂØπËØù';
                } else {
                    // Â±ïÂºÄÂπ∂Âä†ËΩΩÂØπËØù
                    expandDiv.classList.add('active');
                    btn.classList.add('expanded');
                    btn.querySelector('.dialog-action').textContent = '‚ñ≤ Êî∂Ëµ∑ÂØπËØù';

                    // Ê£ÄÊü•ÊòØÂê¶Â∑≤Âä†ËΩΩËøá
                    if (expandDiv.dataset.loaded !== 'true') {
                        try {
                            const dialogData = await DataLoader.loadDialogFile(AppState.currentUnit, dialogFile);
                            this.renderInlineDialog(expandDiv, dialogData, dialogSection);
                            expandDiv.dataset.loaded = 'true';
                        } catch (error) {
                            console.error('Âä†ËΩΩÂØπËØùÂ§±Ë¥•:', error);
                            expandDiv.querySelector('.dialog-lines').innerHTML =
                                '<div style="color: var(--accent); padding: 1rem;">Âä†ËΩΩÂØπËØùÂ§±Ë¥•: ' + error.message + '</div>';
                        }
                    }
                }
            },

            // Âú®Â±ïÂºÄÂå∫ÂüüÂÜÖÊ∏≤ÊüìÂØπËØùÔºàÊîØÊåÅÈÄêÂè•Â±ïÂºÄÔºå‰ΩøÁî®dialog-nodeÊ†ºÂºèÔºâ
            renderInlineDialog(container, dialogData, sectionName) {
                let lines = [];

                // Â¶ÇÊûúÊåáÂÆö‰∫ÜsectionÔºåËé∑ÂèñËØ•sectionÁöÑlines
                if (sectionName && dialogData[sectionName] && dialogData[sectionName].lines) {
                    lines = dialogData[sectionName].lines;
                } else {
                    // Âê¶ÂàôÈÅçÂéÜÊâÄÊúâsection
                    for (const [key, value] of Object.entries(dialogData)) {
                        if (value && value.lines && Array.isArray(value.lines)) {
                            lines = lines.concat(value.lines);
                        }
                    }
                }

                if (lines.length === 0) {
                    container.querySelector('.dialog-lines').innerHTML =
                        '<div style="color: var(--text-secondary); padding: 1rem; text-align: center;">ÊöÇÊó†ÂØπËØùÂÜÖÂÆπ</div>';
                    return;
                }

                // ÈÄêÂè•Â±ïÂºÄÊ®°ÂºèÔºå‰ΩøÁî®dialog-nodeÊ†ºÂºè
                const flowId = `inline_${Date.now()}`;
                let html = '';

                lines.forEach((line, index) => {
                    const isNarration = line.speaker === 'narration';
                    const npcData = !isNarration ? AppState.masterData.npcs[line.speaker] : null;
                    const speakerName = isNarration ? '' : (npcData ? npcData.name_cn : line.speaker);
                    const avatar = this.getNpcEmoji(line.speaker);
                    const npcColor = this.getNpcColor(line.speaker);
                    const isFirst = index === 0;
                    const isLast = index === lines.length - 1;

                    // ÊØèÂè•ÂØπËØùÂåÖË£ÖÂú®dialog-flow-node‰∏≠
                    html += `<div class="dialog-flow-node ${isFirst ? 'visible' : ''}" id="${flowId}_node_${index}">`;

                    if (isNarration) {
                        // ÊóÅÁôΩÊ†∑Âºè
                        html += `
                            <div class="dialog-node narration">
                                <div class="dialog-content">${line.text}</div>
                            </div>
                        `;
                    } else {
                        // NPCÂØπËØùÊ†∑ÂºèÔºåÂ∏¶È¢úËâ≤ÂíåemojiÂå∫ÂàÜ
                        html += `
                            <div class="dialog-node" style="border-left-color: ${npcColor};">
                                <div class="speaker-info">
                                    <div class="speaker-avatar" style="background: ${npcColor};">${avatar}</div>
                                    <span class="speaker-name" style="color: ${npcColor};">${speakerName}</span>
                                </div>
                                <div class="dialog-content">${line.text}</div>
                                ${line.action ? `<div class="dialog-action">${line.action}</div>` : ''}
                            </div>
                        `;
                    }

                    html += '</div>';

                    // Â¶ÇÊûú‰∏çÊòØÊúÄÂêé‰∏ÄÂè•ÔºåÊ∑ªÂä†"ÁªßÁª≠"ÊåâÈíÆ
                    if (!isLast) {
                        html += `
                            <button class="dialog-next-btn ${isFirst ? '' : 'hidden'}" id="${flowId}_btn_${index}"
                                    onclick="event.stopPropagation(); Renderer.showNextDialogNode('${flowId}', ${index + 1}, ${lines.length})">
                                ‚ñº ÁªßÁª≠
                            </button>
                        `;
                    }
                });

                container.querySelector('.dialog-lines').innerHTML = html;
            },

            async renderExpose() {
                const expose = AppState.loopData.expose;
                if (!expose) {
                    this.renderError('No expose data found');
                    return;
                }

                // Get target NPC info
                const targetNpc = AppState.masterData.npcs[expose.target];
                const targetName = targetNpc ? targetNpc.name_cn : expose.target_name;

                let html = `
                    <div class="section-container">
                        <div class="section-header">
                            <div class="section-title">üéØ Expose - ${expose.scene_name}</div>
                            <div class="section-description">
                                ÊåáËØÅÂØπË±°: ${targetName} |
                                ÂõûÂêàÊï∞: ${expose.total_rounds} |
                                Êó∂Èïø: ${expose.total_duration}
                            </div>
                        </div>
                `;

                // Load dialog data first
                let dialogData = null;
                if (expose.dialog_file) {
                    try {
                        dialogData = await DataLoader.loadDialogFile(
                            AppState.currentUnit,
                            expose.dialog_file
                        );

                        // Store dialog context
                        AppState.currentDialogFile = expose.dialog_file;
                        AppState.currentDialogData = dialogData;
                    } catch (error) {
                        console.error(`Error loading accusation dialog ${expose.dialog_file}:`, error);
                        html += `<div class="error">Failed to load accusation dialog: ${expose.dialog_file}</div>`;
                    }
                }

                // Render opening dialog if exists
                if (dialogData?.opening?.lines) {
                    html += `
                        <div class="collapsible-module" onclick="Renderer.toggleModule(this)" style="margin-bottom: 1rem;">
                            <div class="collapsible-module-btn">
                                <span class="module-title">üé¨ ÂºÄÂú∫ÂØπËØù</span>
                                <span class="module-icon">‚ñº</span>
                            </div>
                            <div class="collapsible-module-content type-dialog">
                                ${this.renderDialogSection(dialogData.opening, 'expose_opening')}
                            </div>
                        </div>
                    `;
                }

                // Render each round with integrated structure: Ë∞éË®Ä ‚Üí ËØÅÊçÆ ‚Üí ÊåáËØÅÂØπËØù ‚Üí ÁªìÊûú
                if (expose.rounds && expose.rounds.length > 0) {
                    for (const round of expose.rounds) {
                        const roundKey = `round${round.round}`;
                        // Find matching dialog round from accusation.yaml (rounds[].dialog structure)
                        const dialogRound = dialogData?.rounds?.find(r => r.round === round.round);
                        const roundSection = dialogRound?.dialog ? { lines: dialogRound.dialog } : null;

                        html += `
                            <div class="round-card" id="expose-${roundKey}">
                                <!-- Round Header -->
                                <div class="round-header">
                                    <div class="round-number">
                                        <span class="round-badge">${round.round}</span>
                                        <span class="round-title">${round.name}</span>
                                    </div>
                                    <span class="round-duration">‚è± ${round.duration}</span>
                                </div>

                                <div class="round-body">
                                <!-- 1. Ë∞éË®Ä -->
                                <div class="collapsible-module" onclick="Renderer.toggleModule(this)">
                                    <div class="collapsible-module-btn">
                                        <span class="module-title">üé≠ Êü•ÁúãË∞éË®Ä</span>
                                        <span class="module-icon">‚ñº</span>
                                    </div>
                                    <div class="collapsible-module-content type-lie">
                                        <div style="font-size: 0.95rem;">"${round.lie.content}"</div>
                                    </div>
                                </div>

                                <!-- 2. ÈúÄË¶ÅËØÅÊçÆ -->
                                <div class="collapsible-module" onclick="Renderer.toggleModule(this)">
                                    <div class="collapsible-module-btn">
                                        <span class="module-title">üìã ÈÄâÊã©ËØÅÊçÆ</span>
                                        <span class="module-icon">‚ñº</span>
                                    </div>
                                    <div class="collapsible-module-content type-evidence">
                                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                            ${round.required_evidences.map(evId => {
                                                const evData = AppState.masterData.evidences[evId];
                                                return `
                                                    <div style="padding: 0.5rem 1rem; background: rgba(50, 40, 25, 0.95); border: 1px solid var(--gold); border-radius: 4px; font-size: 0.9rem;">
                                                        ${evId}${evData ? `: ${evData.name}` : ''}
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                </div>

                                <!-- 3. ÊåáËØÅÂØπËØù -->
                                ${roundSection ? `
                                    <div class="collapsible-module" onclick="Renderer.toggleModule(this)">
                                        <div class="collapsible-module-btn">
                                            <span class="module-title">üí¨ ËØ¶ÁªÜÂØπËØù</span>
                                            <span class="module-icon">‚ñº</span>
                                        </div>
                                        <div class="collapsible-module-content type-dialog">
                                            ${this.renderDialogSection(roundSection, `expose_${roundKey}`)}
                                        </div>
                                    </div>
                                ` : ''}
                                </div><!-- end round-body -->
                            </div><!-- end round-card -->
                        `;
                    }
                }

                // Render truth_reveal dialog if exists
                if (dialogData?.truth_reveal?.lines) {
                    html += `
                        <div class="collapsible-module" onclick="Renderer.toggleModule(this)" style="margin-top: 1rem;">
                            <div class="collapsible-module-btn" style="background: rgba(232, 198, 120, 0.2); border-color: var(--gold);">
                                <span class="module-title" style="color: var(--gold);">‚ú® ÁúüÁõ∏Êè≠Èú≤</span>
                                <span class="module-icon">‚ñº</span>
                            </div>
                            <div class="collapsible-module-content type-dialog">
                                ${this.renderDialogSection(dialogData.truth_reveal, 'expose_truth_reveal')}
                            </div>
                        </div>
                    `;
                }

                html += `</div>`;
                this.container.innerHTML = html;
            },

            async renderEnding() {
                const ending = AppState.loopData.ending;
                if (!ending) {
                    this.renderError('No ending data found');
                    return;
                }

                let html = `
                    <div class="section-container">
                        <div class="section-header" style="background: rgba(232, 198, 120, 0.15); border-color: var(--gold);">
                            <div class="section-title" style="color: var(--gold);">üèÅ Ending - ${ending.scene_name}</div>
                            <div class="section-description">${ending.description}</div>
                        </div>
                `;

                // Load and render ending dialog
                if (ending.dialog_file) {
                    try {
                        const dialogData = await DataLoader.loadDialogFile(
                            AppState.currentUnit,
                            ending.dialog_file
                        );

                        // Store dialog context
                        AppState.currentDialogFile = ending.dialog_file;
                        AppState.currentDialogData = dialogData;

                        // Render all sections from ending dialog as collapsible sections
                        const sections = Object.entries(dialogData).filter(([key]) =>
                            key !== 'dialog_id' && key !== 'loop' && key !== 'type'
                        );

                        sections.forEach(([key, section], index) => {
                            html += `
                                <div class="collapsible-section" onclick="Renderer.toggleCollapsibleSection(this)" style="margin-bottom: 1.5rem;">
                                    <div class="collapsible-section-header" style="padding: 0.75rem; background: rgba(42, 35, 25, 0.95); border-left: 3px solid var(--gold); border-radius: 4px; position: relative;">
                                        <div style="color: var(--gold); font-weight: 600;">üìñ ${section.description || key}</div>
                                        <div class="collapsible-section-icon">‚ñº</div>
                                    </div>
                                    <div class="collapsible-section-body" style="padding: 0.75rem; padding-top: 0;">
                                        ${this.renderDialogSection(section, `ending_${key}`)}
                                    </div>
                                </div>
                            `;
                        });

                    } catch (error) {
                        console.error(`Error loading ending dialog ${ending.dialog_file}:`, error);
                        html += `<div class="error">Failed to load ending dialog: ${ending.dialog_file}</div>`;
                    }
                }

                // Render transition info
                if (ending.transition_to || ending.next_objective) {
                    html += `
                        <div class="evidence-card" style="margin-top: 2rem; border-color: var(--gold); background: rgba(42, 35, 25, 0.95);">
                            <div class="evidence-header">
                                <span class="evidence-id">Loop Transition</span>
                                <span class="evidence-type">Next</span>
                            </div>
                            ${ending.next_objective ? `<div class="evidence-name" style="color: var(--gold);">üéØ ${ending.next_objective}</div>` : ''}
                            ${ending.transition_text ? `<div class="evidence-description">${ending.transition_text}</div>` : ''}
                            ${ending.transition_to ? `<div style="margin-top: 0.75rem; font-size: 0.9rem; color: var(--highlight);">‚Üí ${ending.transition_to}</div>` : ''}
                        </div>
                    `;
                }

                html += `</div>`;
                this.container.innerHTML = html;
            },

            renderScenes() {
                let html = `
                    <div class="section-container">
                        <div class="section-header">
                            <div class="section-title">Scenes</div>
                            <div class="section-description">All scenes in ${AppState.currentUnit}</div>
                        </div>
                `;

                for (const [id, scene] of Object.entries(AppState.masterData.scenes)) {
                    html += `
                        <div class="evidence-card">
                            <div class="evidence-header">
                                <span class="evidence-id">${id}</span>
                                <span class="evidence-type">scene</span>
                            </div>
                            <div class="evidence-name">${scene.name} / ${scene.name_en}</div>
                            <div class="evidence-description">${scene.description}</div>
                            ${scene.state ? `<div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--highlight);">State: ${scene.state}</div>` : ''}
                        </div>
                    `;
                }

                html += '</div>';
                this.container.innerHTML = html;
            },

            renderNPCs() {
                let html = `
                    <div class="section-container">
                        <div class="section-header">
                            <div class="section-title">NPCs</div>
                            <div class="section-description">All NPCs in ${AppState.currentUnit}</div>
                        </div>
                `;

                for (const [id, npc] of Object.entries(AppState.masterData.npcs)) {
                    html += `
                        <div class="evidence-card">
                            <div class="evidence-header">
                                <span class="evidence-id">${id}</span>
                                <span class="evidence-type">${npc.role}</span>
                            </div>
                            <div class="evidence-name">${npc.name_cn} / ${npc.name}</div>
                            <div class="evidence-description">${npc.description}</div>
                        </div>
                    `;
                }

                html += '</div>';
                this.container.innerHTML = html;
            },

            renderEvidences() {
                let html = `
                    <div class="section-container">
                        <div class="section-header">
                            <div class="section-title">Evidences</div>
                            <div class="section-description">All evidences in ${AppState.currentUnit}</div>
                        </div>
                `;

                for (const [id, ev] of Object.entries(AppState.masterData.evidences)) {
                    // Build extra info for puzzle
                    let extraInfo = null;
                    if (ev.has_puzzle) {
                        extraInfo = `<div style="margin-top: 0.75rem; padding: 0.5rem; background: rgba(50, 40, 25, 0.95); border-left: 2px solid var(--gold); border-radius: 4px; font-size: 0.85rem; color: var(--gold);">üß© Has puzzle: ${ev.puzzle_description}</div>`;
                    }

                    html += this.renderEvidenceCard(id, ev, null, extraInfo);
                }

                html += '</div>';
                this.container.innerHTML = html;
            },

            renderPlayerState() {
                const variables = AppState.playerState.variables;
                const evidences = AppState.playerState.evidences;
                const analyzedEvidences = AppState.playerState.analyzedEvidences;

                let html = `
                    <div class="section-container">
                        <div class="section-header">
                            <div class="section-title">üõ†Ô∏è Player State (Debug Panel)</div>
                            <div class="section-description">Current player state for testing conditional sections</div>
                        </div>

                        <!-- Variables Section -->
                        <div class="evidence-card">
                            <div class="evidence-header">
                                <span class="evidence-type">Variables</span>
                            </div>
                            <div class="evidence-body" style="padding: 1rem;">
                                ${Object.keys(variables).length > 0 ? `
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="border-bottom: 1px solid var(--accent);">
                                                <th style="text-align: left; padding: 0.5rem; color: var(--gold);">Variable Name</th>
                                                <th style="text-align: right; padding: 0.5rem; color: var(--gold);">Value</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${Object.entries(variables).map(([key, value]) => `
                                                <tr style="border-bottom: 1px solid rgba(232, 198, 120, 0.1);">
                                                    <td style="padding: 0.5rem;">${key}</td>
                                                    <td style="text-align: right; padding: 0.5rem; color: var(--highlight);">${value}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                ` : `
                                    <div style="text-align: center; color: var(--text-secondary); padding: 1rem;">
                                        No variables set yet
                                    </div>
                                `}

                                <div style="margin-top: 1rem;">
                                    <input type="text" id="varName" placeholder="Variable name"
                                           style="padding: 0.5rem; background: var(--primary); border: 1px solid var(--accent); color: var(--text-primary); margin-right: 0.5rem; border-radius: 4px;">
                                    <input type="text" id="varValue" placeholder="Value"
                                           style="padding: 0.5rem; background: var(--primary); border: 1px solid var(--accent); color: var(--text-primary); margin-right: 0.5rem; border-radius: 4px;">
                                    <button onclick="Renderer.setVariable(document.getElementById('varName').value, document.getElementById('varValue').value); Renderer.renderPlayerState();"
                                            style="padding: 0.5rem 1rem; background: var(--accent); border: 1px solid var(--gold); color: var(--text-primary); cursor: pointer; border-radius: 4px;">
                                        Set Variable
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Evidences Section -->
                        <div class="evidence-card" style="margin-top: 1.5rem;">
                            <div class="evidence-header">
                                <span class="evidence-type">Evidence Inventory</span>
                            </div>
                            <div class="evidence-body" style="padding: 1rem;">
                                ${evidences.size > 0 ? `
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                        ${Array.from(evidences).map(evId => `
                                            <div style="padding: 0.5rem 1rem; background: rgba(50, 40, 25, 0.95); border: 1px solid var(--gold); border-radius: 4px; display: inline-block;">
                                                ${evId}
                                                ${analyzedEvidences.has(evId) ? '<span style="color: var(--gold);"> ‚úì</span>' : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <div style="text-align: center; color: var(--text-secondary); padding: 1rem;">
                                        No evidence collected yet
                                    </div>
                                `}

                                <div style="margin-top: 1rem;">
                                    <input type="text" id="evId" placeholder="Evidence ID (e.g., EV1115)"
                                           style="padding: 0.5rem; background: var(--primary); border: 1px solid var(--accent); color: var(--text-primary); margin-right: 0.5rem; border-radius: 4px;">
                                    <button onclick="AppState.playerState.evidences.add(document.getElementById('evId').value); Renderer.renderPlayerState();"
                                            style="padding: 0.5rem 1rem; background: var(--accent); border: 1px solid var(--gold); color: var(--text-primary); cursor: pointer; border-radius: 4px; margin-right: 0.5rem;">
                                        Add Evidence
                                    </button>
                                    <button onclick="AppState.playerState.evidences.clear(); AppState.playerState.analyzedEvidences.clear(); Renderer.renderPlayerState();"
                                            style="padding: 0.5rem 1rem; background: rgba(231, 76, 60, 0.2); border: 1px solid #e74c3c; color: #e74c3c; cursor: pointer; border-radius: 4px;">
                                        Clear All
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Instructions -->
                        <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(232, 198, 120, 0.05); border-left: 3px solid var(--gold); border-radius: 4px;">
                            <div style="color: var(--gold); font-weight: 600; margin-bottom: 0.5rem;">üí° How to Test Conditional Sections</div>
                            <ol style="margin-left: 1.5rem; line-height: 1.8;">
                                <li>Set variables (e.g., <code>rosa_trust = 30</code>) using the form above</li>
                                <li>Add evidence to inventory (e.g., <code>EV1115</code>)</li>
                                <li>Navigate to "Test Conditional" section to try the demo dialog</li>
                                <li>Your choices will set variables, and conditional sections will auto-route based on conditions</li>
                            </ol>
                        </div>
                    </div>
                `;

                this.container.innerHTML = html;
            },

            async renderTestConditional() {
                // Load the test conditional dialog
                try {
                    const dialogData = await DataLoader.loadDialogFile(
                        AppState.currentUnit,
                        'loop1/test_conditional.yaml'
                    );

                    // Store dialog context
                    AppState.currentDialogFile = 'loop1/test_conditional.yaml';
                    AppState.currentDialogData = dialogData;

                    const npc = AppState.masterData.npcs[dialogData.npc];

                    let html = `
                        <div class="section-container">
                            <div class="section-header">
                                <div class="section-title">üß™ Test Conditional Sections</div>
                                <div class="section-description">
                                    Demo dialog showing conditional section system in action<br>
                                    <small style="color: var(--text-secondary);">Dialog with: ${npc ? npc.name_cn : 'Unknown'}</small>
                                </div>
                            </div>

                            <div style="padding: 1rem; background: rgba(232, 198, 120, 0.05); border-left: 3px solid var(--gold); border-radius: 4px; margin-bottom: 1.5rem;">
                                <div style="color: var(--gold); font-weight: 600; margin-bottom: 0.5rem;">üìñ Test Scenario</div>
                                <p>This dialog demonstrates:</p>
                                <ul style="margin-left: 1.5rem; line-height: 1.8;">
                                    <li><strong>Player Choices with Variables:</strong> Your choices set <code>rosa_trust</code> variable</li>
                                    <li><strong>Conditional Routing:</strong> The <code>trust_check</code> section is a conditional section that automatically routes based on <code>rosa_trust</code> value</li>
                                    <li><strong>Multiple Outcomes:</strong> Three different endings based on trust level (high ‚â•25, medium ‚â•0, low <0)</li>
                                </ul>
                            </div>

                            ${this.renderDialogSection(dialogData.start, 'start')}
                        </div>
                    `;

                    this.container.innerHTML = html;

                } catch (error) {
                    console.error('Error loading test dialog:', error);
                    this.renderError('Failed to load test conditional dialog');
                }
            }
        };

        // ===== UI Controller =====
        const UIController = {
            init() {
                // Sidebar navigation
                document.querySelectorAll('.sidebar-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
                        e.target.classList.add('active');
                        Renderer.renderSection(e.target.dataset.section);
                    });
                });

                // View mode toggle
                document.getElementById('viewModeBtn').addEventListener('click', () => {
                    AppState.viewMode = AppState.viewMode === 'flow' ? 'full' : 'flow';
                    const btn = document.getElementById('viewModeBtn');
                    btn.textContent = AppState.viewMode === 'flow' ? '‰ΩìÈ™åÁâà' : 'ÂºÄÂèëÁâà';
                    btn.classList.toggle('active', AppState.viewMode === 'full');

                    // Apply view mode class to content area
                    this.updateViewModeClass();

                    // Re-render current section to apply view mode
                    Renderer.renderSection(AppState.currentSection);
                });

                // Loop selector
                document.getElementById('loopSelect').addEventListener('change', async (e) => {
                    AppState.currentLoop = e.target.value;
                    await DataLoader.loadLoopData(AppState.currentUnit, AppState.currentLoop);
                    Renderer.renderSection(AppState.currentSection);
                });

                // Edit mode toggle
                document.getElementById('editModeBtn').addEventListener('click', () => {
                    AppState.editMode = !AppState.editMode;
                    const btn = document.getElementById('editModeBtn');
                    btn.classList.toggle('active', AppState.editMode);
                    console.log('Edit mode:', AppState.editMode);
                    // TODO: Implement edit mode functionality
                });

                // Export button
                document.getElementById('exportBtn').addEventListener('click', () => {
                    this.exportData();
                });

                // Initialize view mode class
                this.updateViewModeClass();
            },

            exportData() {
                try {
                    const exportData = {
                        unit: AppState.currentUnit,
                        loop: AppState.currentLoop,
                        exportTime: new Date().toISOString(),
                        masterData: AppState.masterData,
                        loopData: AppState.loopData
                    };

                    const dataStr = JSON.stringify(exportData, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);

                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${AppState.currentUnit}_${AppState.currentLoop}_export.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);

                    console.log('Data exported successfully');
                    alert('Êï∞ÊçÆÂ∑≤ÊàêÂäüÂØºÂá∫ÔºÅ');
                } catch (error) {
                    console.error('Export failed:', error);
                    alert('ÂØºÂá∫Â§±Ë¥•: ' + error.message);
                }
            },

            updateViewModeClass() {
                const contentArea = document.querySelector('.content-area');
                contentArea.classList.remove('flow-view', 'full-view');
                contentArea.classList.add(`${AppState.viewMode}-view`);
            }
        };

        // ===== App Initialization =====
        async function initApp() {
            Renderer.init();
            UIController.init();

            const success = await DataLoader.loadAllData();

            if (success) {
                Renderer.renderSection('opening');
            } else {
                Renderer.renderError('Failed to load data. Check console for details.');
            }
        }

        // Start the app when DOM is ready
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
