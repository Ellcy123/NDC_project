# 案情回顾系统 - 策划案

**文档版本**: v1.2
**创建日期**: 2025-12-01
**更新日期**: 2025-12-01
**系统名称**: Case Review System

---

## 一、系统概述

### 1.1 系统定位

案情回顾系统是NDC的核心辅助系统，提供玩家回顾案件进展、管理存档、回溯至指定章节的功能。

### 1.2 核心设计理念

> **「章节即存档点」**
> 每个章节的结束不仅是叙事节点，更是玩家进度的永久记录。玩家可以随时回顾已完成的章节，并从任意章节起点重新开始游戏。

> **⚠️ 重要：玩家无感知「循环」概念**
> 「循环」(Loop) 是策划内部术语，玩家界面中**不显示任何Loop相关文字**。玩家看到的是章节主题名称（如"残酷的身份确认"），而非"Loop 1"。

### 1.3 系统目标

| 目标 | 说明 |
|:---|:---|
| **进度管理** | 自动保存每个章节结束时的完整游戏状态 |
| **案情回顾** | 让玩家随时回顾已发现的线索、证据和真相 |
| **回溯机制** | 支持从任意已完成章节的起点重新开始 |
| **成就追踪** | 记录玩家在每个章节的表现数据 |

---

## 二、章节选择界面 (CHAPTER SELECT)

### 2.1 界面定位

章节选择界面是**二级界面**，用于查看所有章节和进行跨章节回溯。

> **⚠️ 重要入口规则**
> - **点击OVERVIEW按钮** → 直接进入**当前章节**的案情进展界面（Progress）
> - **点击← CHAPTER SELECT按钮** → 从案情进展界面返回章节选择界面
> - 章节选择界面也用于章节开始/结束时的过渡

### 2.2 触发时机

| 时机 | 入口 | 目标界面 |
|:---|:---|:---|
| **游戏中查看进度** | 点击OVERVIEW按钮 | 直接进入当前章节的案情进展界面 |
| **跨章节回溯** | 在案情进展界面点击← CHAPTER SELECT | 进入章节选择界面 |
| **章节开始** | 自动弹出 | 章节选择界面（选择开始章节） |
| **章节结束** | 自动弹出 | 章节选择界面（显示下一章节入口） |

### 2.3 界面布局

```
┌────────────────────────────────────────────────────────────────────────────┐
│                            CHAPTER SELECT                                   │
│                                                                            │
│  ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐          │
│  │  ┌───────────┐  │   │  ╭───────────╮  │   │  ╭───────────╮  │          │
│  │  │ Chicago   │  │   │  │           │  │   │  │           │  │          │
│  │  │ Daily     │  │   │  │  [照片]   │  │   │  │    ???    │  │          │
│  │  │ Tribune  │  │   │  │           │  │   │  │           │  │          │
│  │  │───────────│  │   │  ╰───────────╯  │   │  ╰───────────╯  │          │
│  │  │ BLUE MOON │  │   │  Chicago        │   │                 │          │
│  │  │ ACCIDENT  │  │   │  Nov 14, 1925   │   │                 │          │
│  │  └───────────┘  │   └─────────────────┘   └─────────────────┘          │
│  │                 │                                                       │
│  │ ▓▓▓▓▓▓▓▓▓▓▓▓▓▓ │   ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓    ░░░░░░░░░░░░░░░░░░           │
│  │ NO.1 蓝月事件  │   NO.2 TWILIGHT ELEGY    NO.3 ???                     │
│  │   ✓ 已完成     │      ● 进行中              即将到来                    │
│  └─────────────────┘                                                       │
│                                                                            │
│                          城市天际线剪影背景                                 │
└────────────────────────────────────────────────────────────────────────────┘
```

### 2.4 卡片样式

| 状态 | 卡片样式 | 视觉元素 | 交互 |
|:---|:---|:---|:---|
| **已完成** | 报纸风格 | 泛黄纸张、新闻标题、事件插图 | 可点击查看详情/回溯 |
| **进行中** | 拍立得照片 | 场景照片、手写日期、胶带装饰 | 可点击继续游戏 |
| **未解锁** | 拍立得照片(模糊) | 图片显示"???"、无日期 | 不可点击 |

### 2.5 卡片底部信息条

```
┌─────────────────────────────────────┐
│ ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓ │  ← 红色/灰色底条
│ NO.2  TWILIGHT ELEGY                │  ← 章节编号 + 章节名称
│       COMING SOON                   │  ← 状态文字
└─────────────────────────────────────┘
```

| 状态 | 底条颜色 | 状态文字 |
|:---|:---|:---|
| 已完成 | 深红色 | ✓ COMPLETED |
| 进行中 | 红色 | ● IN PROGRESS |
| 未解锁 | 灰色 | COMING SOON |

### 2.6 点击交互

**点击已完成章节卡片** → 进入该章节的详情页面（案情回顾）

**点击进行中章节卡片** → 继续当前游戏进度

**点击详情页"回溯至此"按钮** → 触发回溯确认流程

---

## 三、存档规则

### 3.1 存档触发时机

| 触发条件 | 存档类型 | 说明 |
|:---|:---|:---|
| 章节结束（指证成功） | 章节存档 | **自动触发，不可跳过** |
| 单元结束 | 单元存档 | 特殊标记，包含完整单元数据 |
| 玩家退出游戏 | 临时存档 | 仅保存当前进度，不计入章节存档 |

### 3.2 重要限制

> **⚠️ 不支持中途存档**
> 玩家无法在章节进行中手动保存。这是设计意图，确保每次游玩都是完整的章节体验。

### 3.3 存档数据字段说明

| 字段 | 类型 | 说明 |
|:---|:---|:---|
| `chapter_id` | int | 章节编号（内部使用，对应Loop 1-6） |
| `chapter_name` | string | 章节名称（玩家可见） |
| `target` | string | 指证对象（进行中章节不显示） |
| `status` | enum | 状态：completed / in_progress |
| `complete_time` | datetime | 完成时间戳 |
| `player_data.evidence_ids` | array | 已获得证据ID列表 |
| `player_data.unlocked_scenes` | array | 已解锁场景ID列表 |
| `player_data.completed_dialogues` | array | 已完成对话ID列表 |
| `player_data.flags` | object | 剧情标记字典 |
| `accusation_data.rounds` | int | 指证轮次 |
| `accusation_data.evidence_used` | array | 每轮使用的证据 |
| `accusation_data.mistakes` | int | 指证失误次数 |

---

## 四、回溯机制

### 4.1 回溯流程

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│点击OVERVIEW │ → │ 案情进展界面 │ → │点击CHAPTER  │ → │ 章节选择界面 │ → │点击目标章节 │ → │点击「回溯至此」│
│             │    │ (当前章节)   │    │   SELECT    │    │              │    │  查看详情   │    │  加载起点   │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

### 4.2 回溯规则

| 数据类型 | 回溯时处理 | 说明 |
|:---|:---|:---|
| 证据 | **重置**为该章节开始时状态 | 只保留前序章节获得的证据 |
| 场景解锁 | **重置**为该章节开始时状态 | 后续解锁的场景不保留 |
| 对话进度 | **重置**为该章节开始时状态 | 后续完成的对话重置 |
| 剧情标记 | **重置**为该章节开始时状态 | 后续触发的标记清除 |
| 成就/统计 | **保留** | 永久记录，不会因回溯丢失 |

### 4.3 回溯确认提示

```
┌────────────────────────────────────────────┐
│        确认回溯至「残酷的身份确认」？         │
├────────────────────────────────────────────┤
│                                            │
│  您将从该章节的起点重新开始。                │
│                                            │
│  以下数据将被重置：                         │
│  • 证据收集进度                            │
│  • 场景解锁状态                            │
│  • 对话完成进度                            │
│  • 剧情标记                                │
│                                            │
│  以下数据将保留：                          │
│  • 成就记录                                │
│  • 游玩统计                                │
│                                            │
│         [取消]        [确认回溯]           │
└────────────────────────────────────────────┘
```

### 4.4 设计意图

回溯机制允许玩家「回到过去」探索不同选择，但不会影响永久性成就。这样既保证了探索自由度，又维护了成就的价值感。

---

## 五、UI界面设计

### 5.1 两层UI架构

案情回顾系统采用**两层UI设计**：

| 层级 | 名称 | 功能 |
|:---|:---|:---|
| 第一层 | 主界面 | 展示章节摘要卡片，点击进入详情 |
| 第二层 | 详情弹窗 | 展示完整事件时间线，提供视频回放和回溯操作 |

### 5.2 主界面布局

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│  ┌────────────┐  ┌──────────────────────────────────────┐  ┌────────────┐  │
│  │            │  │                                      │  │            │  │
│  │   左侧面板  │  │            中间面板                  │  │   右侧面板  │  │
│  │            │  │                                      │  │            │  │
│  │  章节卡片   │  │         垂直时间线（摘要）            │  │   操作区   │  │
│  │   列表     │  │         （上下滚动）                  │  │            │  │
│  │            │  │                                      │  │            │  │
│  │  ✓ 残酷的  │  │  ┌──────────────────────────────┐    │  │            │  │
│  │   身份确认 │  │  │ ✓ 残酷的身份确认              │    │  │  [策划案] │  │
│  │            │  │  │   完成多项调查，揭露Morrison   │    │  │            │  │
│  │  ✓ 威胁链条│  │  │         （点击查看详情）       │    │  │            │  │
│  │   与连号钞票│  │  └──────────────────────────────┘    │  │            │  │
│  │            │  │              ↓                       │  │            │  │
│  │  ✓ 掠夺性  │  │  ┌──────────────────────────────┐    │  │            │  │
│  │   贷款揭露 │  │  │ ✓ 威胁链条与连号钞票          │    │  │            │  │
│  │            │  │  │   追踪威胁信件...             │    │  │            │  │
│  │  ● 当前章节│  │  └──────────────────────────────┘    │  │            │  │
│  │            │  │              ↓                       │  │            │  │
│  │            │  │  ┌──────────────────────────────┐    │  │            │  │
│  │            │  │  │ ● 当前章节（进行中）           │    │  │            │  │
│  │            │  │  │   探索中...                   │    │  │            │  │
│  │            │  │  └──────────────────────────────┘    │  │            │  │
│  │            │  │                                      │  │            │  │
│  └────────────┘  └──────────────────────────────────────┘  └────────────┘  │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 左侧面板 - 章节卡片列表

**功能**：展示已解锁章节的状态和基本信息

**卡片状态**：

| 状态 | 视觉表现 | 交互 |
|:---|:---|:---|
| 已完成 | ✓ 绿色对勾 | 可查看 |
| 进行中 | ● 黄色圆点 | 不可查看 |

**重要规则**：
- **不显示"LOOP"字样**：卡片标题直接使用章节名称

**卡片信息**：
- 状态标记（✓ 或 ●）
- 章节名称（如"残酷的身份确认"）
- 指证对象（**进行中章节显示"???"**）

> **⚠️ 重要设计说明**
> 玩家在章节进行中不知道指证对象是谁，因此进行中章节的指证对象必须显示为"???"，只有完成章节后才揭示真正的指证对象。

### 5.4 中间面板 - 垂直时间线（摘要视图）

**功能**：以摘要形式展示各章节进展

**布局方向**：从上到下，支持上下滚动浏览

**节点显示**：
- 每个章节显示为**一个摘要卡片**
- 摘要包含：章节名称 + 简短描述
- 提示"点击查看详情"

**交互**：
- 上下滚动浏览整个时间线
- **点击摘要卡片 → 打开详情弹窗**

### 5.5 右侧面板 - 操作区

**功能**：提供系统操作按钮

**按钮**：
- **策划案**（查看设计文档，仅调试/开发用）

> **⚠️ 注意**
> 主界面右侧**不包含**"重玩"或"回溯"按钮。回溯操作在详情弹窗中进行。

### 5.6 详情弹窗

**功能**：展示选中章节的完整事件时间线，提供视频回放和回溯操作

**弹窗布局**：

```
┌──────────────────────────────────────────────────────────────┐
│                                                              │
│  残酷的身份确认                                    [返回]    │
│  指证对象：Morrison                                          │
│                                                              │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ 🔴 火灾现场                                            │  │
│  │    Jimmy带领玩家来到火灾废墟                           │  │
│  └────────────────────────────────────────────────────────┘  │
│                      ↓                                       │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ ⚪ 调查阶段                                            │  │
│  │    收集证据，询问证人                                  │  │
│  └────────────────────────────────────────────────────────┘  │
│                      ↓                                       │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ ⚪ 指证阶段                                            │  │
│  │    与Morrison对峙                                      │  │
│  └────────────────────────────────────────────────────────┘  │
│                      ↓                                       │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ 🟣 Morrison指证                              [视频回放] │  │
│  │    戳穿Morrison的谎言                                  │  │
│  └────────────────────────────────────────────────────────┘  │
│                                                              │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│                    [⏪ 回溯至此]                             │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

**弹窗元素**：

| 元素 | 说明 |
|:---|:---|
| 标题 | 章节名称 |
| 指证对象 | 该章节的指证目标 |
| 返回按钮 | 关闭弹窗，返回主界面 |
| 事件时间线 | 完整的事件节点列表 |
| 视频回放按钮 | 仅视频类节点可用 |
| 回溯至此按钮 | 从该章节起点重新开始（仅已完成章节可用） |

**节点类型**：

| 类型 | 颜色 | 说明 |
|:---|:---|:---|
| 故事节点 | 🔴 红色 | 关键剧情点 |
| 普通节点 | ⚪ 白色 | 一般进度节点 |
| 视频节点 | 🟣 紫色 | 支持回放的演出/指证 |

**关闭方式**：
- 点击"返回"按钮
- **不使用×关闭按钮**（与返回按钮功能重复）

---

## 六、数据流转

### 6.1 章节结束时数据保存流程

```
指证成功 → 显示「谎言戳穿」 → 【系统自动存档】 → 显示案件记录 → 进入下一章节
                                    ↓
                              保存以下数据：
                              • 已获得证据ID
                              • 已解锁场景ID
                              • 已完成对话ID
                              • 剧情标记
                              • 指证表现数据
```

### 6.2 回溯时数据加载流程

```
点击章节摘要 → 进入详情弹窗 → 点击「回溯至此」→ 确认提示 → 加载章节起点
                                      ↓
                              读取【前序章节】存档数据
                              重置玩家状态
                              开始游玩
```

### 6.3 示例：回溯至「掠夺性贷款揭露」

1. 玩家点击OVERVIEW，进入当前章节的案情进展界面
2. 玩家点击← CHAPTER SELECT，进入章节选择界面
3. 玩家点击"掠夺性贷款揭露"章节卡片
4. 系统显示该章节详情弹窗，展示完整事件时间线
5. 玩家点击"回溯至此"按钮
6. 系统显示确认提示
7. 玩家确认后，系统读取该章节存档数据
8. 重置玩家状态至该章节起点
9. 加载章节开篇场景

---

## 七、Unit 2 章节配置

### 7.1 章节列表（策划内部对照表）

| 内部编号 | 章节名称 | 指证对象 | 指证轮次 |
|:---|:---|:---|:---|
| Loop 1 | 残酷的身份确认 | Morrison | 2轮 |
| Loop 2 | 威胁链条与连号钞票 | Leonard Ross | 3轮 |
| Loop 3 | 掠夺性贷款揭露 | Harold Moore | 3轮 |
| Loop 4 | Rose深情告白 | Danny Kowalski | 3轮 |
| Loop 5 | Vinnie纵火认罪 | Vinnie Moretti | 1轮 |
| Loop 6 | Leonard终极指证 | Leonard Russo | 4轮 |

> **⚠️ 注意**
> 上表中的"Loop X"仅供策划内部使用，玩家界面中不显示。

### 7.2 各章节存档节点

| 存档点 | 触发条件 |
|:---|:---|
| 残酷的身份确认 结束 | Morrison指证成功 |
| 威胁链条与连号钞票 结束 | Leonard Ross指证成功 |
| 掠夺性贷款揭露 结束 | Harold Moore指证成功 |
| Rose深情告白 结束 | Danny Kowalski指证成功 |
| Vinnie纵火认罪 结束 | Vinnie认罪 |
| Leonard终极指证 结束 | Leonard Russo终极指证成功 |

---

## 八、技术实现要点

### 8.1 存档系统

```
SaveManager
├── CreateChapterSave(chapterId)   // 创建章节存档
├── LoadChapterSave(chapterId)     // 加载章节存档
├── GetAllChapterSaves()           // 获取所有章节存档
├── DeleteChapterSave(chapterId)   // 删除章节存档（仅调试）
└── ValidateSaveData(data)         // 验证存档数据完整性
```

### 8.2 UI系统

```
CaseReviewUI
├── MainView                       // 主界面
│   ├── LeftPanel
│   │   └── ChapterCardList        // 章节卡片列表（ScrollView）
│   ├── CenterPanel
│   │   └── SummaryTimeline        // 摘要时间线（ScrollView）
│   └── RightPanel
│       └── ActionButtons          // 操作按钮（仅策划案）
│
└── DetailModal                    // 详情弹窗
    ├── Header
    │   ├── Title                  // 章节名称
    │   ├── TargetInfo             // 指证对象
    │   └── BackButton             // 返回按钮
    ├── EventTimeline              // 完整事件时间线
    │   └── EventNodes             // 事件节点（含视频回放按钮）
    └── Footer
        └── ReplayButton           // 回溯至此按钮
```

### 8.3 性能优化

- 章节卡片使用**对象池**复用
- 时间线节点**懒加载**，仅渲染可见区域
- 存档数据**压缩存储**，减少IO开销
- UI更新使用**脏标记**机制，避免不必要的重绘

---

## 九、扩展功能（可选）

### 9.1 统计面板

- 各章节完成状态
- 证据收集完成度
- 指证失误统计

### 9.2 成就系统集成

- 「完美指证」：单章节0失误完成
- 「收藏家」：收集所有证据
- 「重温经典」：回溯任意章节

### 9.3 回放功能

- 支持回放指证演出
- 支持回放关键剧情
- 可跳过/快进

---

## 十、相关文档

- [循环过渡演示](../循环过渡演示/loop_transition_demo.html)
- [案情回顾系统HTML演示](./case_review_system.html)
- [Unit2_场景清单_详细版](../Unit2_场景清单_详细版.md)
- [Unit2_循环1_Morrison指证设计定稿](../Unit2_循环1_Morrison指证设计定稿.md)

---

**文档状态**: ✅ v1.2 更新完成
**更新内容**:
- 移除玩家界面中的"LOOP"相关显示，改用章节主题名称
- 采用两层UI架构：主界面（摘要）→ 详情弹窗（完整时间线）
- "重玩"改为"回溯"，按钮文字为「回溯至此」
- 主界面右侧仅保留"策划案"按钮
- 不显示未解锁章节
- 详情弹窗取消×关闭按钮，仅保留"返回"按钮
- 视频回放功能移至详情弹窗内
- 更新UI布局图和流程图

**下一步**: 与程序团队确认技术实现方案
