<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NDC ÂâßÊÉÖÈ¢ÑËßàÂô®</title>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* È°∂ÈÉ®ÊéßÂà∂Ê†è */
        .header {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            color: #ffd700;
            margin-bottom: 15px;
            font-size: 24px;
        }

        .controls {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            color: #aaa;
            font-size: 14px;
        }

        select {
            padding: 8px 15px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: #2a2a3e;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
        }

        select:hover {
            border-color: #ffd700;
        }

        select option {
            background: #2a2a3e;
            color: #fff;
            padding: 8px;
        }

        select option:hover,
        select option:checked {
            background: #3a3a5e;
        }

        .view-toggle {
            display: flex;
            gap: 5px;
            margin-left: auto;
        }

        .view-btn {
            padding: 8px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: transparent;
            color: #aaa;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .view-btn.active {
            background: #ffd700;
            color: #1a1a2e;
            border-color: #ffd700;
        }

        .view-btn:hover:not(.active) {
            border-color: #ffd700;
            color: #ffd700;
        }

        /* ÁºñËæëÊ®°ÂºèÊ†∑Âºè */
        .edit-mode .dialog-line {
            cursor: pointer;
            transition: all 0.3s;
        }

        .edit-mode .dialog-line:hover {
            background: rgba(255, 215, 0, 0.1);
            border-left: 3px solid #ffd700;
            padding-left: 17px;
        }

        .dialog-line.edited {
            border-left: 3px solid #2ecc71;
        }

        /* ÁºñËæëÂºπÁ™ó */
        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .edit-modal.active {
            display: flex;
        }

        .edit-modal-content {
            background: #2a2a3e;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .edit-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .edit-modal-header h3 {
            color: #ffd700;
            font-size: 18px;
            margin: 0;
        }

        .edit-close-btn {
            background: none;
            border: none;
            color: #aaa;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 1;
            transition: all 0.3s;
        }

        .edit-close-btn:hover {
            color: #fff;
            transform: rotate(90deg);
        }

        .edit-field {
            margin-bottom: 20px;
        }

        .edit-field label {
            display: block;
            color: #aaa;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .edit-field input,
        .edit-field textarea {
            width: 100%;
            padding: 10px;
            background: #1a1a2e;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #fff;
            font-family: 'Microsoft YaHei', sans-serif;
            font-size: 14px;
            transition: all 0.3s;
        }

        .edit-field input:focus,
        .edit-field textarea:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
        }

        .edit-field textarea {
            min-height: 120px;
            resize: vertical;
            line-height: 1.6;
        }

        .edit-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        .edit-save-btn,
        .edit-cancel-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .edit-save-btn {
            background: #2ecc71;
            color: #fff;
        }

        .edit-save-btn:hover {
            background: #27ae60;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
        }

        .edit-cancel-btn {
            background: rgba(255, 255, 255, 0.1);
            color: #aaa;
        }

        .edit-cancel-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }

        /* Âæ™ÁéØ‰ø°ÊÅØ */
        .loop-info {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .loop-info h2 {
            color: #ffd700;
            font-size: 18px;
            margin-bottom: 8px;
        }

        .loop-info p {
            color: #ccc;
            font-size: 14px;
        }

        /* Èò∂ÊÆµÊ†áÁ≠æ */
        .phase-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .phase-tab {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #aaa;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .phase-tab:hover {
            border-color: #ffd700;
            color: #ffd700;
        }

        .phase-tab.active {
            background: rgba(255, 215, 0, 0.2);
            border-color: #ffd700;
            color: #ffd700;
        }

        /* Ê†áÁ≠æÂàÜÈöîÁ¨¶ */
        .tab-divider {
            width: 1px;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            margin: 0 10px;
        }

        /* ÂèÇËÄÉËµÑÊñôÊ†áÁ≠æÔºàNPCÊ°£Ê°àÁ≠âÔºâ */
        .phase-tab.reference-tab {
            background: rgba(52, 152, 219, 0.1);
            border-color: rgba(52, 152, 219, 0.3);
            color: #3498db;
        }

        .phase-tab.reference-tab:hover {
            border-color: #3498db;
            color: #3498db;
        }

        .phase-tab.reference-tab.active {
            background: rgba(52, 152, 219, 0.2);
            border-color: #3498db;
            color: #3498db;
        }

        /* ‰∏ªÂÜÖÂÆπÂå∫ */
        .main-content {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 500px;
        }

        /* ÂºÄÁØá/ÁªìÂ∞æÂØπËØùÊ†∑Âºè */
        .dialog-section {
            margin-bottom: 30px;
        }

        .scene-header {
            background: rgba(255, 215, 0, 0.1);
            padding: 12px 18px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #ffd700;
        }

        .scene-header h3 {
            color: #ffd700;
            font-size: 16px;
        }

        .scene-header p {
            color: #999;
            font-size: 13px;
            margin-top: 5px;
        }

        .dialog-node {
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 8px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dialog-node.narration {
            background: rgba(100, 100, 100, 0.2);
            color: #aaa;
            font-style: italic;
            text-align: center;
        }

        .dialog-node.speaker {
            background: rgba(255, 255, 255, 0.08);
        }

        .dialog-node .speaker-name {
            color: #4ecdc4;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }

        /* ÊåâËßíËâ≤Âêç */
        .dialog-node .speaker-name.zack { color: #5dade2; }
        .dialog-node .speaker-name.emma { color: #f39c12; }
        .dialog-node .speaker-name.rosa { color: #e74c3c; }
        .dialog-node .speaker-name.tommy { color: #27ae60; }
        .dialog-node .speaker-name.morrison { color: #8e44ad; }
        /* ÊåâNPC ID - Á¨¨1Á´† */
        .dialog-node .speaker-name.npc101 { color: #5dade2; }  /* Zack ÊâéÂÖã */
        .dialog-node .speaker-name.npc102 { color: #f39c12; }  /* Emma ËâæÁéõ */
        .dialog-node .speaker-name.npc103 { color: #e74c3c; }  /* Rosa ÁΩóËéé */
        .dialog-node .speaker-name.npc104 { color: #8e44ad; }  /* Morrison Ëé´ÈáåÊ£Æ */
        .dialog-node .speaker-name.npc105 { color: #27ae60; }  /* Tommy Ê±§Á±≥ */
        .dialog-node .speaker-name.npc106 { color: #e67e22; }  /* Jimmy ÂêâÁ±≥ */
        .dialog-node .speaker-name.npc107 { color: #1abc9c; }  /* Coleman ÁßëÂ∞îÊõº */
        .dialog-node .speaker-name.npc108 { color: #9b59b6; }  /* Vivian ËñáËñáÂÆâ */
        .dialog-node .speaker-name.npc109 { color: #3498db; }  /* Webb Èü¶‰ºØ */
        .dialog-node .speaker-name.npc110 { color: #e91e63; }  /* MorrisonÂ§™Â§™ */

        .dialog-node .emotion {
            color: #888;
            font-size: 12px;
            margin-left: 8px;
        }

        .dialog-node .text {
            color: #e0e0e0;
            line-height: 1.6;
        }

        .dialog-node .action {
            color: #888;
            font-size: 13px;
            margin-top: 5px;
            font-style: italic;
        }

        .dialog-node.branch {
            background: transparent;
            border: none;
        }

        .branch-option {
            padding: 8px 12px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            color: #ccc;
            border-left: 3px solid #888;
        }

        .branch-option.important {
            border-left-color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        /* ÂàÜÊîØÈÄâÈ°πÊåâÈíÆÊ†∑Âºè */
        .branch-option-btn {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 12px 16px;
            margin: 6px 0;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-left: 3px solid #3498db;
            border-radius: 6px;
            color: #ccc;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            font-size: 14px;
        }

        .branch-option-btn:hover {
            background: rgba(52, 152, 219, 0.15);
            border-color: #3498db;
            color: #fff;
            transform: translateX(5px);
        }

        .branch-option-btn.important {
            border-left-color: #e74c3c;
            background: rgba(231, 76, 60, 0.08);
        }

        .branch-option-btn.important:hover {
            background: rgba(231, 76, 60, 0.2);
            border-color: #e74c3c;
        }

        .branch-option-btn.active {
            background: rgba(52, 152, 219, 0.2);
            border-color: #3498db;
            color: #3498db;
        }

        .branch-option-btn .branch-arrow {
            color: #666;
            transition: all 0.3s;
        }

        .branch-option-btn:hover .branch-arrow {
            color: #3498db;
            transform: translateX(3px);
        }

        /* ÂàÜÊîØÂ±ïÂºÄÂÜÖÂÆπ */
        .branch-content {
            margin: 10px 0 10px 15px;
            padding: 12px 15px;
            background: transparent;
            border-left: 2px solid rgba(52, 152, 219, 0.4);
            border-radius: 0;
            animation: fadeSlideIn 0.3s ease;
        }

        .branch-content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px dashed rgba(52, 152, 219, 0.3);
        }

        .branch-path-label {
            color: #3498db;
            font-size: 12px;
            font-weight: normal;
            opacity: 0.8;
        }

        .branch-content-nodes {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .branch-content-nodes .dialog-node {
            margin: 0;
        }

        /* ÂµåÂ•óÂàÜÊîØÁöÑÊ†∑ÂºèË∞ÉÊï¥ */
        .branch-content .dialog-node.branch {
            background: transparent;
            border: none;
        }

        /* Ëá™Áî±ÁéØËäÇÊ†∑Âºè */
        .free-phase-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Âú∫ÊôØÊåâÈíÆÂàóË°® */
        .scene-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .scene-btn {
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #ccc;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .scene-btn:hover {
            border-color: #ffd700;
            color: #ffd700;
            transform: translateY(-2px);
        }

        .scene-btn.active {
            background: rgba(255, 215, 0, 0.15);
            border-color: #ffd700;
            color: #ffd700;
        }

        .scene-btn .scene-icon {
            font-size: 16px;
        }

        .scene-btn .scene-name {
            font-weight: bold;
        }

        .scene-btn .scene-badge {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 5px;
        }

        .scene-btn .scene-badge.search {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .scene-btn .scene-badge.npc {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }

        .scene-btn.locked {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: rgba(231, 76, 60, 0.3);
        }

        .scene-btn.locked:hover {
            background: rgba(255, 255, 255, 0.03);
            transform: none;
        }

        .scene-btn .scene-badge.locked {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        /* Âú∫ÊôØÂç°ÁâáÁΩëÊ†ºÂ∏ÉÂ±Ä */
        .scene-cards-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Âú∫ÊôØÂç°Áâá */
        .scene-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }

        .scene-card:hover {
            border-color: rgba(255, 215, 0, 0.4);
        }

        .scene-card.highlight {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            animation: cardHighlight 1.5s ease;
        }

        @keyframes cardHighlight {
            0% { box-shadow: 0 0 0 rgba(255, 215, 0, 0); }
            30% { box-shadow: 0 0 25px rgba(255, 215, 0, 0.5); }
            100% { box-shadow: 0 0 0 rgba(255, 215, 0, 0); }
        }

        .scene-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .scene-card-icon {
            font-size: 24px;
        }

        .scene-card-title {
            flex: 1;
        }

        .scene-card-title h4 {
            color: #ffd700;
            font-size: 16px;
            margin-bottom: 3px;
        }

        .scene-card-id {
            color: #666;
            font-size: 12px;
        }

        .scene-card-note {
            color: #888;
            font-size: 13px;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
        }

        /* Âú∫ÊôØËØ¶ÊÉÖÈù¢ÊùøÔºàÊµÅÁ®ãÁâàÁÇπÂáªÂêéÊòæÁ§∫Ôºâ */
        .scene-detail-panel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .scene-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .scene-detail-header h3 {
            color: #ffd700;
            font-size: 18px;
        }

        .scene-detail-header .scene-type-badge {
            padding: 5px 12px;
            border-radius: 5px;
            font-size: 12px;
        }

        .scene-type-badge.search {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .scene-type-badge.npc {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }

        .scene-npc-info {
            background: rgba(52, 152, 219, 0.1);
            border-left: 3px solid #3498db;
            padding: 12px 15px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 20px;
            color: #3498db;
        }

        /* ËØÅÊçÆÂàóË°® - ÂèØÁÇπÂáªÂ±ïÂºÄ */
        .evidence-list {
            margin-top: 15px;
        }

        .evidence-list.hidden {
            display: none;
        }

        .evidence-list.fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .evidence-list-header {
            color: #4ecdc4;
            font-size: 14px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .evidence-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin: 8px 0;
            overflow: hidden;
            transition: all 0.3s;
        }

        .evidence-card:hover {
            border-color: #4ecdc4;
        }

        .evidence-card-header {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            gap: 12px;
        }

        .evidence-card-header .ev-icon {
            width: 32px;
            height: 32px;
            background: rgba(78, 205, 196, 0.2);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4ecdc4;
            font-size: 14px;
            flex-shrink: 0;
        }

        .evidence-card-header .ev-info {
            flex: 1;
        }

        .evidence-card-header .ev-name {
            color: #e0e0e0;
            font-size: 14px;
            font-weight: bold;
        }

        .evidence-card-header .ev-id {
            color: #666;
            font-size: 11px;
        }

        .evidence-card-header .ev-type {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 500;
        }

        .evidence-card-header .ev-type.item {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .evidence-card-header .ev-type.clue {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }

        .evidence-card-header .ev-type.envir {
            background: rgba(243, 156, 18, 0.2);
            color: #f39c12;
        }

        .evidence-card-header .ev-expand {
            color: #666;
            font-size: 12px;
            transition: transform 0.3s;
        }

        .evidence-card.expanded .ev-expand {
            transform: rotate(180deg);
        }

        .evidence-card-body {
            display: none;
            padding: 0 15px 15px 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .evidence-card.expanded .evidence-card-body {
            display: block;
        }

        .ev-description {
            background: rgba(78, 205, 196, 0.1);
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
        }

        .ev-description .desc-label {
            color: #4ecdc4;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .ev-description .desc-text {
            color: #ccc;
            font-size: 13px;
            line-height: 1.6;
        }

        .ev-hint {
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
        }

        .ev-hint.puzzle {
            background: rgba(243, 156, 18, 0.1);
            color: #f39c12;
        }

        .ev-hint.requires {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }

        .ev-hint.location {
            background: rgba(52, 152, 219, 0.1);
            color: #3498db;
        }

        /* ÂàÜÊûêÊåâÈíÆ */
        .analyze-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed rgba(255, 255, 255, 0.1);
        }

        .analyze-btn {
            padding: 8px 16px;
            background: rgba(155, 89, 182, 0.2);
            border: 1px solid rgba(155, 89, 182, 0.4);
            border-radius: 5px;
            color: #9b59b6;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .analyze-btn:hover {
            background: rgba(155, 89, 182, 0.3);
            border-color: #9b59b6;
        }

        .analyze-btn.analyzed {
            background: rgba(46, 204, 113, 0.2);
            border-color: rgba(46, 204, 113, 0.4);
            color: #2ecc71;
        }

        .analyzed-result {
            display: none;
            margin-top: 12px;
            background: rgba(155, 89, 182, 0.1);
            border-radius: 6px;
            padding: 12px;
            animation: fadeIn 0.3s ease;
        }

        .analyzed-result.visible {
            display: block;
        }

        .analyzed-result .result-label {
            color: #9b59b6;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .analyzed-result .result-text {
            color: #ccc;
            font-size: 13px;
            line-height: 1.6;
        }

        /* ÂØπËØùÂ±ïÂºÄÂå∫Âüü */
        .scene-dialog-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dialog-toggle-btn {
            padding: 10px 20px;
            background: rgba(52, 152, 219, 0.15);
            border: 1px solid rgba(52, 152, 219, 0.3);
            border-radius: 6px;
            color: #3498db;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            width: 100%;
            text-align: center;
        }

        .dialog-toggle-btn:hover {
            background: rgba(52, 152, 219, 0.25);
            border-color: #3498db;
        }

        .scene-dialog-content {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
        }

        .scene-dialog-content.visible {
            display: block;
        }

        /* ÊµÅÁ®ãÁâàÂØπËØùÈÄêÊù°Â±ïÂºÄÊ†∑Âºè */
        .dialog-flow-container {
            padding: 15px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
        }

        .dialog-flow-node {
            display: none;
        }

        .dialog-flow-node.visible {
            display: block;
            animation: fadeSlideIn 0.3s ease;
        }

        @keyframes fadeSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dialog-next-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: rgba(52, 152, 219, 0.1);
            border: 1px dashed rgba(52, 152, 219, 0.4);
            border-radius: 6px;
            color: #3498db;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            text-align: center;
        }

        .dialog-next-btn:hover {
            background: rgba(52, 152, 219, 0.2);
            border-style: solid;
            border-color: #3498db;
        }

        .dialog-next-btn.hidden {
            display: none;
        }

        /* Êó†Âú∫ÊôØÈÄâ‰∏≠ÊèêÁ§∫ */
        .no-scene-hint {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .no-scene-hint .hint-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .no-scene-hint p {
            font-size: 14px;
        }

        /* ÊåáËØÅÁéØËäÇÊ†∑Âºè */
        .expose-section {
            margin-bottom: 25px;
        }

        .expose-header {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .expose-header h3 {
            color: #e74c3c;
            margin-bottom: 10px;
        }

        .expose-header .target-info {
            color: #ccc;
            font-size: 14px;
        }

        .expose-round {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .round-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .round-number {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .round-title {
            color: #e74c3c;
            font-size: 16px;
        }

        .round-duration {
            color: #888;
            font-size: 12px;
            margin-left: auto;
        }

        .lie-box {
            background: rgba(231, 76, 60, 0.1);
            border-left: 4px solid #e74c3c;
            padding: 12px 15px;
            margin-bottom: 15px;
            border-radius: 0 6px 6px 0;
        }

        .lie-box .label {
            color: #e74c3c;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .lie-box .content {
            color: #e0e0e0;
            font-size: 14px;
            line-height: 1.5;
        }

        .evidence-box {
            background: rgba(78, 205, 196, 0.1);
            border-left: 4px solid #4ecdc4;
            padding: 12px 15px;
            margin-bottom: 15px;
            border-radius: 0 6px 6px 0;
        }

        .evidence-box .label {
            color: #4ecdc4;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .evidence-box .content {
            color: #e0e0e0;
            font-size: 14px;
        }

        .dialog-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .dialog-box .speaker-tag {
            color: #5dade2;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .dialog-box .speaker-tag.rosa {
            color: #e74c3c;
        }

        .dialog-box .dialog-text {
            color: #e0e0e0;
            line-height: 1.7;
            white-space: pre-line;
        }

        .dialog-box .emotion-tag {
            display: inline-block;
            padding: 2px 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            font-size: 12px;
            color: #888;
            margin-left: 10px;
        }

        .result-box {
            background: rgba(46, 204, 113, 0.1);
            border-left: 4px solid #2ecc71;
            padding: 12px 15px;
            border-radius: 0 6px 6px 0;
        }

        .result-box .label {
            color: #2ecc71;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .result-box .content {
            color: #e0e0e0;
            font-size: 14px;
        }

        /* Âä†ËΩΩÁä∂ÊÄÅ */
        .loading {
            text-align: center;
            padding: 50px;
            color: #888;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ffd700;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ÈîôËØØÊèêÁ§∫ */
        .error-box {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .error-box h3 {
            color: #e74c3c;
            margin-bottom: 10px;
        }

        .error-box p {
            color: #ccc;
        }

        /* Áº∫Â§±ÂÜÖÂÆπÊèêÁ§∫Ê°Ü */
        .missing-content-box {
            background: rgba(255, 152, 0, 0.1);
            border: 2px dashed rgba(255, 152, 0, 0.4);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
        }

        .missing-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .missing-content-box h3 {
            color: #ff9800;
            margin: 10px 0;
            font-size: 18px;
        }

        .missing-reason {
            color: #ccc;
            font-size: 14px;
            line-height: 1.6;
            margin: 15px 0;
        }

        .inherited-info {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 152, 0, 0.05);
            border-radius: 6px;
            font-size: 13px;
        }

        .inherited-label {
            color: #ff9800;
            font-weight: bold;
        }

        .inherited-source {
            color: #ffd54f;
            font-family: 'Courier New', monospace;
            margin-left: 5px;
        }

        /* ‰∏ã‰∏ÄÂæ™ÁéØÊèêÁ§∫Ê°Ü */
        .next-loop-hint {
            margin-top: 20px;
            padding: 15px 20px;
            background: rgba(33, 150, 243, 0.1);
            border-left: 4px solid #2196f3;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .hint-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .hint-content {
            color: #ccc;
            font-size: 14px;
            line-height: 1.5;
        }

        .hint-content strong {
            color: #64b5f6;
        }

        /* Âú∫ÊôØÂØπËØùÂ±ïÂºÄ */
        .scene-dialog-content {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .collapse-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            color: #aaa;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s;
        }

        .collapse-btn:hover {
            border-color: #ffd700;
            color: #ffd700;
        }

        /* NPC‰ø°ÊÅØÊ†∑Âºè */
        .npc-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .npc-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
        }

        .npc-card:hover {
            border-color: #3498db;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .npc-card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .npc-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            font-weight: bold;
        }

        .npc-card-title h4 {
            color: #3498db;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .npc-card-title .npc-role {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        .npc-role.suspect {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        .npc-role.witness {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .npc-role.protagonist {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }

        .npc-role.partner {
            background: rgba(243, 156, 18, 0.2);
            color: #f39c12;
        }

        .npc-role.victim {
            background: rgba(155, 89, 182, 0.2);
            color: #9b59b6;
        }

        .npc-info-section {
            margin-bottom: 15px;
        }

        .npc-info-section h5 {
            color: #ffd700;
            font-size: 13px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .npc-info-section h5::before {
            content: '';
            width: 3px;
            height: 14px;
            background: #ffd700;
            border-radius: 2px;
        }

        .info-table {
            width: 100%;
        }

        .info-row {
            display: flex;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #888;
            font-size: 13px;
            min-width: 100px;
            flex-shrink: 0;
        }

        .info-value {
            color: #e0e0e0;
            font-size: 13px;
            line-height: 1.5;
        }

        .info-value.highlight {
            color: #4ecdc4;
        }

        .info-value.warning {
            color: #e74c3c;
        }

        .testimony-list {
            margin-top: 10px;
        }

        .testimony-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 10px 12px;
            border-radius: 6px;
            margin: 6px 0;
            border-left: 3px solid #e74c3c;
            color: #ccc;
            font-size: 13px;
            line-height: 1.5;
        }

        .testimony-item::before {
            content: '"';
            color: #e74c3c;
            font-size: 18px;
            margin-right: 5px;
        }

        .testimony-item::after {
            content: '"';
            color: #e74c3c;
            font-size: 18px;
            margin-left: 5px;
        }

        .no-info-hint {
            color: #666;
            font-size: 13px;
            font-style: italic;
            padding: 10px;
            text-align: center;
        }

        /* ÊµÅÁ®ãÁâàÂºÄÁØá/ÁªìÂ∞æÊ†∑Âºè */
        .opening-scene-buttons,
        .ending-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .opening-scene-btn,
        .ending-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            color: #ffd700;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .opening-scene-btn:hover,
        .ending-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            border-color: #ffd700;
        }

        .opening-scene-btn.active,
        .ending-btn.active {
            background: rgba(255, 215, 0, 0.25);
            border-color: #ffd700;
        }

        .opening-scene-btn .scene-arrow,
        .ending-btn .ending-arrow {
            transition: transform 0.3s;
            margin-left: auto;
        }

        .opening-scene-btn.active .scene-arrow,
        .ending-btn.active .ending-arrow {
            transform: rotate(180deg);
        }

        .opening-scene-content,
        .ending-dialog-content {
            animation: slideIn 0.3s ease;
        }

        /* ÊµÅÁ®ãÁâàÊåáËØÅÊ†∑Âºè */
        .expose-rounds-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .expose-round-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
            border-radius: 8px;
            color: #e74c3c;
            cursor: pointer;
            transition: all 0.3s;
        }

        .expose-round-btn:hover {
            background: rgba(231, 76, 60, 0.2);
            border-color: #e74c3c;
        }

        .expose-round-btn.active {
            background: rgba(231, 76, 60, 0.25);
            border-color: #e74c3c;
        }

        .expose-round-btn .round-num {
            width: 28px;
            height: 28px;
            background: #e74c3c;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .expose-round-btn .round-arrow {
            transition: transform 0.3s;
        }

        .expose-round-btn.active .round-arrow {
            transform: rotate(180deg);
        }

        .expose-round-flow {
            animation: slideIn 0.3s ease;
        }

        .flow-step {
            margin: 10px 0;
        }

        .flow-step-btn {
            width: 100%;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px dashed rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #aaa;
            cursor: pointer;
            text-align: left;
            font-size: 14px;
            transition: all 0.3s;
        }

        .flow-step-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.4);
            color: #fff;
        }

        .flow-step-content {
            animation: fadeIn 0.3s ease;
        }

        /* Âú∫ÊôØÊÄªËßàÊ†∑Âºè */
        .scenes-overview-container {
            padding: 20px;
        }

        .scenes-overview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .scenes-overview-header h3 {
            color: #ffd700;
            font-size: 20px;
        }

        .scenes-stats {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .stat-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .stat-badge.accessible {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        .stat-badge.locked {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .stat-badge.story {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }

        .stat-badge.hidden {
            background: rgba(149, 165, 166, 0.2);
            color: #95a5a6;
            border: 1px solid rgba(149, 165, 166, 0.3);
        }

        .scenes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .scene-overview-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .scene-overview-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .scene-overview-card.accessible {
            border-left: 3px solid #2ecc71;
        }

        .scene-overview-card.locked {
            border-left: 3px solid #e74c3c;
            opacity: 0.8;
        }

        .scene-overview-card.hidden {
            border-left: 3px solid #95a5a6;
            opacity: 0.6;
        }

        .scene-overview-card.story_only {
            border-left: 3px solid #3498db;
        }

        .scene-overview-header {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 10px;
        }

        .scene-status-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .scene-overview-title {
            flex: 1;
        }

        .scene-overview-title h4 {
            color: #fff;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .scene-overview-title .scene-id {
            color: #888;
            font-size: 11px;
            font-family: monospace;
        }

        .scene-type-icon {
            font-size: 16px;
            opacity: 0.7;
        }

        .scene-overview-body {
            margin-bottom: 12px;
        }

        .scene-overview-body .scene-desc {
            color: #aaa;
            font-size: 12px;
            line-height: 1.5;
            margin-bottom: 5px;
        }

        .scene-overview-body .scene-note {
            color: #4ecdc4;
            font-size: 11px;
            font-style: italic;
        }

        .scene-overview-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-label {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 4px;
        }

        .status-label.accessible {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .status-label.locked {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        .status-label.hidden {
            background: rgba(149, 165, 166, 0.2);
            color: #95a5a6;
        }

        .status-label.story_only {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }

        .type-label {
            font-size: 11px;
            color: #888;
        }

        /* ÂìçÂ∫îÂºè */
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .view-toggle {
                margin-left: 0;
                margin-top: 10px;
            }

            .free-phase-grid {
                grid-template-columns: 1fr;
            }

            .scenes-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>NDC ÂâßÊÉÖÈ¢ÑËßàÂô®</h1>
            <div class="controls">
                <div class="control-group">
                    <label>Á´†ËäÇ:</label>
                    <select id="unitSelect">
                        <option value="">Âä†ËΩΩ‰∏≠...</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Âæ™ÁéØ:</label>
                    <select id="loopSelect">
                        <option value="">ËØ∑ÂÖàÈÄâÊã©Á´†ËäÇ</option>
                    </select>
                </div>
                <div class="view-toggle">
                    <button class="view-btn active" data-view="full">ÂºÄÂèëÁâà</button>
                    <button class="view-btn" data-view="flow">‰ΩìÈ™åÁâà</button>
                    <button class="view-btn" id="editModeBtn" style="background: rgba(52, 152, 219, 0.2); color: #3498db; margin-left: 15px;">‚úèÔ∏è ÁºñËæë</button>
                    <button class="view-btn" id="exportBtn" style="background: rgba(46, 204, 113, 0.2); color: #2ecc71;">üì• ÂØºÂá∫</button>
                </div>
            </div>
        </div>

        <div class="loop-info" id="loopInfo" style="display: none;">
            <h2 id="loopTitle"></h2>
            <p id="loopObjective"></p>
        </div>

        <div class="phase-tabs" id="phaseTabs">
            <button class="phase-tab active" data-phase="opening">ÂºÄÁØá</button>
            <button class="phase-tab" data-phase="free">Ëá™Áî±ÁéØËäÇ</button>
            <button class="phase-tab" data-phase="expose">ÊåáËØÅ</button>
            <button class="phase-tab" data-phase="ending">ÁªìÂ∞æ</button>
            <span class="tab-divider"></span>
            <button class="phase-tab reference-tab" data-phase="scenes">Âú∫ÊôØÊÄªËßà</button>
            <button class="phase-tab reference-tab" data-phase="npcinfo">NPCÊ°£Ê°à</button>
        </div>

        <div class="main-content" id="mainContent">
            <div class="loading">ËØ∑ÈÄâÊã©Á´†ËäÇÂíåÂæ™ÁéØ</div>
        </div>

    </div>

    <script>
        // ÂÖ®Â±ÄÁä∂ÊÄÅ
        const state = {
            index: null,
            currentUnit: null,
            currentLoop: null,
            loopData: null,
            dialogs: {},
            masterData: {
                scenes: null,
                npcs: null,
                evidences: null
            },
            currentPhase: 'opening',
            viewMode: 'full', // 'full' or 'flow'
            flowIndex: 0,
            flowNodes: [],
            currentDialogData: null // ÂΩìÂâçÊ≠£Âú®Êü•ÁúãÁöÑÂØπËØùÊï∞ÊçÆÔºà‰æõÂàÜÊîØÂ±ïÂºÄ‰ΩøÁî®Ôºâ
        };

        // Âü∫Á°ÄË∑ØÂæÑ
        const BASE_PATH = 'Êï∞ÊçÆÊ∫ê/';

        // Âä†ËΩΩYAMLÊñá‰ª∂
        async function loadYaml(path) {
            try {
                const response = await fetch(BASE_PATH + path);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const text = await response.text();
                return jsyaml.load(text);
            } catch (error) {
                console.error(`Âä†ËΩΩ ${path} Â§±Ë¥•:`, error);
                return null;
            }
        }

        // Ëé∑ÂèñNPCÊòæÁ§∫ÂêçÁß∞
        function getNpcDisplayName(npcId) {
            if (!npcId) return '???';

            // ÁâπÊÆäÁ±ªÂûãÂ§ÑÁêÜ
            if (npcId === 'narration' || npcId === 'narrator') return 'ÊóÅÁôΩ';
            if (npcId === 'unknown_voice') return 'Á•ûÁßòÂ£∞Èü≥';

            // ‰ªémasterData‰∏≠Êü•ÊâæNPC
            const npc = state.masterData.npcs?.[npcId];
            if (npc) {
                // ‰ºòÂÖà‰ΩøÁî®‰∏≠ÊñáÂêçÔºåÊ≤°ÊúâÂàôÁî®Ëã±ÊñáÂêç
                return npc.name_cn || npc.name || npcId;
            }

            // Â¶ÇÊûúÊâæ‰∏çÂà∞ÔºåËøîÂõûÂéüÂßãID
            return npcId;
        }

        // ‰ªéÂØπËØùÊï∞ÊçÆ‰∏≠ÊèêÂèñËäÇÁÇπÔºàÂÖºÂÆπÂ§öÁßçÊ†ºÂºèÔºâ
        // ÊîØÊåÅÁöÑÊ†ºÂºèÔºö
        // 1. { nodes: [...] } - ÊóßÊ†ºÂºè
        // 2. { sections: { section_name: { lines: [...] } } } - Êñ∞Ê†ºÂºè
        // 3. { dialog: [...] } - NPCÂØπËØùÊ†ºÂºè
        // 4. { opening: { lines: [...] } } - ÊåáËØÅÂºÄÁØáÊ†ºÂºè
        // 5. { rounds: [...] } - ÊåáËØÅÂõûÂêàÊ†ºÂºè
        function getDialogNodes(dialogData, sectionName = null) {
            if (!dialogData) return [];

            // 1. Â¶ÇÊûúÊåáÂÆö‰∫ÜsectionÔºå‰ºòÂÖà‰ªésections‰∏≠Ëé∑Âèñ
            if (sectionName && dialogData.sections && dialogData.sections[sectionName]) {
                const section = dialogData.sections[sectionName];
                return convertLinesToNodes(section.lines || section.nodes || []);
            }

            // 2. Â∞ùËØïÁõ¥Êé•Ëé∑Âèñnodes
            if (dialogData.nodes) {
                return dialogData.nodes;
            }

            // 3. Â¶ÇÊûúÊåáÂÆö‰∫Üsection‰ΩÜÊ≤°ÊúâÂú®sections‰∏≠ÔºåÂ∞ùËØïÁõ¥Êé•‰Ωú‰∏∫Â±ûÊÄß
            if (sectionName && dialogData[sectionName]) {
                const section = dialogData[sectionName];
                return convertLinesToNodes(section.lines || section.nodes || []);
            }

            // 4. NPCÂØπËØùÊ†ºÂºè
            if (dialogData.dialog && Array.isArray(dialogData.dialog)) {
                return convertLinesToNodes(dialogData.dialog);
            }

            // 5. ÊåáËØÅÊ†ºÂºè - opening
            if (dialogData.opening && dialogData.opening.lines) {
                return convertLinesToNodes(dialogData.opening.lines);
            }

            // 6. ÊåáËØÅÊ†ºÂºè - roundsÔºàËøîÂõûÊâÄÊúâÂõûÂêàÁöÑÂØπËØùÔºâ
            if (dialogData.rounds && Array.isArray(dialogData.rounds)) {
                let allNodes = [];
                // Â¶ÇÊûúÊúâopeningÔºåÂÖàÊ∑ªÂä†
                if (dialogData.opening && dialogData.opening.lines) {
                    allNodes = allNodes.concat(convertLinesToNodes(dialogData.opening.lines));
                }
                // Ê∑ªÂä†ÊØèËΩÆÂØπËØù
                dialogData.rounds.forEach(round => {
                    if (round.dialog) {
                        allNodes = allNodes.concat(convertLinesToNodes(round.dialog));
                    }
                });
                // Â¶ÇÊûúÊúâtruth_revealÔºåÊ∑ªÂä†
                if (dialogData.truth_reveal && dialogData.truth_reveal.lines) {
                    allNodes = allNodes.concat(convertLinesToNodes(dialogData.truth_reveal.lines));
                }
                return allNodes;
            }

            // 7. Â¶ÇÊûúÊúâsectionsÔºåÂêàÂπ∂ÊâÄÊúâsectionÁöÑlines
            if (dialogData.sections) {
                let allNodes = [];
                Object.values(dialogData.sections).forEach(section => {
                    if (section.lines) {
                        allNodes = allNodes.concat(convertLinesToNodes(section.lines));
                    }
                });
                return allNodes;
            }

            return [];
        }

        // Â∞ÜlinesÊ†ºÂºèËΩ¨Êç¢‰∏∫nodesÊ†ºÂºè
        function convertLinesToNodes(lines) {
            if (!lines || !Array.isArray(lines)) return [];

            return lines.map((line, index) => {
                // Â¶ÇÊûúÊòØnarrationÁ±ªÂûã
                if (line.speaker === 'narration' || line.speaker === 'narrator') {
                    return {
                        id: `line_${index}`,
                        type: 'narration',
                        text: line.text || ''
                    };
                }

                // Â¶ÇÊûúÊòØunknown_voiceÔºàÁ•ûÁßòÂ£∞Èü≥Ôºâ
                if (line.speaker === 'unknown_voice') {
                    return {
                        id: `line_${index}`,
                        type: 'dialog',
                        speaker: 'Á•ûÁßòÂ£∞Èü≥',
                        text: line.text || '',
                        emotion: line.emotion || '',
                        action: line.action || ''
                    };
                }

                // ÊôÆÈÄöÂØπËØù
                return {
                    id: `line_${index}`,
                    type: 'dialog',
                    speaker: line.speaker || '???',
                    text: line.text || '',
                    emotion: line.emotion || '',
                    action: line.action || ''
                };
            });
        }

        // ÂàùÂßãÂåñ
        async function init() {
            // Âä†ËΩΩÁ¥¢ÂºïÊñá‰ª∂
            state.index = await loadYaml('_index.yaml');
            if (!state.index) {
                showError('Êó†Ê≥ïÂä†ËΩΩÁ¥¢ÂºïÊñá‰ª∂ _index.yaml');
                return;
            }

            // Âä†ËΩΩ‰∏ªÊï∞ÊçÆ
            const [scenes, npcs, evidences] = await Promise.all([
                loadYaml('master/scenes.yaml'),
                loadYaml('master/npcs.yaml'),
                loadYaml('master/evidences.yaml')
            ]);

            state.masterData.scenes = scenes?.scenes || {};
            state.masterData.npcs = npcs?.npcs || {};
            state.masterData.evidences = evidences?.evidences || {};

            // Ë∞ÉËØïÔºöËæìÂá∫Âä†ËΩΩÁöÑÊï∞ÊçÆÊï∞Èáè
            console.log('Âä†ËΩΩÁöÑNPCÊï∞Èáè:', Object.keys(state.masterData.npcs).length);
            console.log('NPCÁ§∫‰æã:', Object.keys(state.masterData.npcs).slice(0, 5));
            console.log('Âä†ËΩΩÁöÑËØÅÊçÆÊï∞Èáè:', Object.keys(state.masterData.evidences).length);
            console.log('ËØÅÊçÆÁ§∫‰æã:', Object.keys(state.masterData.evidences).slice(0, 5));

            // Â°´ÂÖÖÁ´†ËäÇÈÄâÊã©Âô®
            const unitSelect = document.getElementById('unitSelect');
            unitSelect.innerHTML = '<option value="">ËØ∑ÈÄâÊã©Á´†ËäÇ</option>';

            state.index.units.forEach(unit => {
                if (unit.status === 'active' || unit.status === 'draft') {
                    const option = document.createElement('option');
                    option.value = unit.id;
                    option.textContent = `${unit.name} ${unit.status === 'draft' ? '(ËçâÁ®ø)' : ''}`;
                    unitSelect.appendChild(option);
                }
            });

            // ÁªëÂÆö‰∫ã‰ª∂
            bindEvents();
        }

        // ÁªëÂÆö‰∫ã‰ª∂
        function bindEvents() {
            // Á´†ËäÇÈÄâÊã©
            document.getElementById('unitSelect').addEventListener('change', async (e) => {
                const unitId = e.target.value;
                if (!unitId) return;

                state.currentUnit = unitId;
                await loadUnitLoops(unitId);
            });

            // Âæ™ÁéØÈÄâÊã©
            document.getElementById('loopSelect').addEventListener('change', async (e) => {
                const loopFile = e.target.value;
                if (!loopFile) return;

                await loadLoop(loopFile);
            });

            // Èò∂ÊÆµÂàáÊç¢
            document.querySelectorAll('.phase-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.phase-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    state.currentPhase = tab.dataset.phase;
                    renderPhase();
                });
            });

            // ËßÜÂõæÂàáÊç¢
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.viewMode = btn.dataset.view;
                    renderPhase();
                });
            });
        }

        // Âä†ËΩΩÁ´†ËäÇÂæ™ÁéØÂàóË°®
        async function loadUnitLoops(unitId) {
            const loopSelect = document.getElementById('loopSelect');
            loopSelect.innerHTML = '<option value="">Âä†ËΩΩ‰∏≠...</option>';

            // Ëé∑ÂèñÂæ™ÁéØÊñá‰ª∂ÂàóË°® (Áî±‰∫éÊòØÈùôÊÄÅÊñá‰ª∂ÔºåÊàë‰ª¨Â∞ùËØïÂä†ËΩΩloop1-6)
            const loops = [];
            for (let i = 1; i <= 6; i++) {
                const loopData = await loadYaml(`${unitId}/loops/loop${i}.yaml`);
                if (loopData) {
                    loops.push({
                        file: `${unitId}/loops/loop${i}.yaml`,
                        number: i,
                        name: loopData.name || `Âæ™ÁéØ ${i}`
                    });
                }
            }

            loopSelect.innerHTML = '<option value="">ËØ∑ÈÄâÊã©Âæ™ÁéØ</option>';
            loops.forEach(loop => {
                const option = document.createElement('option');
                option.value = loop.file;
                option.textContent = `Loop ${loop.number}: ${loop.name}`;
                loopSelect.appendChild(option);
            });
        }

        // Âä†ËΩΩÂæ™ÁéØÊï∞ÊçÆ
        async function loadLoop(loopFile) {
            const content = document.getElementById('mainContent');
            content.innerHTML = '<div class="loading">Âä†ËΩΩÂæ™ÁéØÊï∞ÊçÆ</div>';

            state.loopData = await loadYaml(loopFile);
            if (!state.loopData) {
                showError('Êó†Ê≥ïÂä†ËΩΩÂæ™ÁéØÊñá‰ª∂');
                return;
            }

            // Âä†ËΩΩÂØπËØùÊñá‰ª∂
            state.dialogs = {};
            const dialogFiles = new Set();

            // Êî∂ÈõÜÊâÄÊúâÂØπËØùÊñá‰ª∂
            if (state.loopData.opening?.scenes) {
                state.loopData.opening.scenes.forEach(s => {
                    if (s.dialog_file) dialogFiles.add(s.dialog_file);
                });
            }
            if (state.loopData.free_phase?.scenes) {
                state.loopData.free_phase.scenes.forEach(s => {
                    if (s.dialog_file) dialogFiles.add(s.dialog_file);
                });
            }
            if (state.loopData.ending?.dialog_file) {
                dialogFiles.add(state.loopData.ending.dialog_file);
            }

            // Âπ∂Ë°åÂä†ËΩΩÂØπËØù
            const dialogPromises = Array.from(dialogFiles).map(async file => {
                const data = await loadYaml(`${state.currentUnit}/dialogs/${file}`);
                if (data) state.dialogs[file] = data;
            });
            await Promise.all(dialogPromises);

            // ÊòæÁ§∫Âæ™ÁéØ‰ø°ÊÅØ
            document.getElementById('loopInfo').style.display = 'block';
            document.getElementById('loopTitle').textContent =
                `${state.loopData.title || state.loopData.name || 'Êú™ÂëΩÂêçÂæ™ÁéØ'} (${state.loopData.loop_id})`;
            document.getElementById('loopObjective').textContent =
                `ÁõÆÊ†á: ${state.loopData.investigation_target || state.loopData.objective || 'Êó†'}`;

            // Ê∏≤ÊüìÂΩìÂâçÈò∂ÊÆµ
            state.currentPhase = 'opening';
            document.querySelectorAll('.phase-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.phase-tab[data-phase="opening"]').classList.add('active');
            renderPhase();
        }

        // Ê∏≤ÊüìÂΩìÂâçÈò∂ÊÆµ
        function renderPhase() {
            const content = document.getElementById('mainContent');

            switch (state.currentPhase) {
                case 'scenes':
                    renderScenesOverview(content);
                    break;
                case 'opening':
                    renderOpening(content);
                    break;
                case 'free':
                    renderFreePhase(content);
                    break;
                case 'npcinfo':
                    renderNpcInfo(content);
                    break;
                case 'expose':
                    renderExpose(content);
                    break;
                case 'ending':
                    renderEnding(content);
                    break;
            }
        }

        // Ê∏≤ÊüìÂú∫ÊôØÊÄªËßà
        function renderScenesOverview(container) {
            const scenesOverview = state.loopData?.scenes_overview;

            if (!scenesOverview || scenesOverview.length === 0) {
                container.innerHTML = '<div class="error-box"><h3>Êó†Âú∫ÊôØÊÄªËßàÊï∞ÊçÆ</h3><p>ËØ∑Âú®loopÊñá‰ª∂‰∏≠Ê∑ªÂä† scenes_overview Â≠óÊÆµ</p></div>';
                return;
            }

            // ÁªüËÆ°ÂêÑÁä∂ÊÄÅÊï∞Èáè
            const stats = {
                accessible: scenesOverview.filter(s => s.status === 'accessible').length,
                locked: scenesOverview.filter(s => s.status === 'locked').length,
                hidden: scenesOverview.filter(s => s.status === 'hidden').length,
                story_only: scenesOverview.filter(s => s.status === 'story_only').length
            };

            let html = `
                <div class="scenes-overview-container">
                    <div class="scenes-overview-header">
                        <h3>Êú¨Âæ™ÁéØÂú∫ÊôØÊÄªËßà</h3>
                        <div class="scenes-stats">
                            <span class="stat-badge accessible">ÂèØËøõÂÖ• ${stats.accessible}</span>
                            <span class="stat-badge locked">ÈîÅÂÆö ${stats.locked}</span>
                            ${stats.story_only > 0 ? `<span class="stat-badge story">ÂâßÊÉÖ ${stats.story_only}</span>` : ''}
                            ${stats.hidden > 0 ? `<span class="stat-badge hidden">ÈöêËóè ${stats.hidden}</span>` : ''}
                        </div>
                    </div>
                    <div class="scenes-grid">
            `;

            scenesOverview.forEach(scene => {
                const masterScene = state.masterData.scenes[scene.scene] || {};
                const statusIcon = {
                    'accessible': '‚úÖ',
                    'locked': 'üîí',
                    'hidden': 'üëÅÔ∏è‚Äçüó®Ô∏è',
                    'story_only': 'üé¨'
                }[scene.status] || '‚ùì';

                const typeIcon = {
                    'search': 'üîç',
                    'npc': 'üí¨',
                    'story': 'üìñ'
                }[scene.type] || 'üìç';

                html += `
                    <div class="scene-overview-card ${scene.status}">
                        <div class="scene-overview-header">
                            <span class="scene-status-icon">${statusIcon}</span>
                            <div class="scene-overview-title">
                                <h4>${scene.name || masterScene.name || 'Êú™Áü•Âú∫ÊôØ'}</h4>
                                <span class="scene-id">${scene.scene}</span>
                            </div>
                            <span class="scene-type-icon" title="${scene.type}">${typeIcon}</span>
                        </div>
                        <div class="scene-overview-body">
                            ${masterScene.description ? `<p class="scene-desc">${masterScene.description}</p>` : ''}
                            ${scene.note ? `<p class="scene-note">${scene.note}</p>` : ''}
                        </div>
                        <div class="scene-overview-footer">
                            <span class="status-label ${scene.status}">${
                                scene.status === 'accessible' ? 'ÂèØËøõÂÖ•' :
                                scene.status === 'locked' ? 'ÈîÅÂÆö' :
                                scene.status === 'hidden' ? 'ÈöêËóè' :
                                scene.status === 'story_only' ? '‰ªÖÂâßÊÉÖ' : scene.status
                            }</span>
                            <span class="type-label">${
                                scene.type === 'search' ? 'Êé¢Á¥¢' :
                                scene.type === 'npc' ? 'NPCÂØπËØù' :
                                scene.type === 'story' ? 'ÂâßÊÉÖ' : scene.type
                            }</span>
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // Ê∏≤ÊüìÂºÄÁØá
        function renderOpening(container) {
            if (!state.loopData?.opening) {
                container.innerHTML = '<div class="error-box"><h3>Êó†ÂºÄÁØáÊï∞ÊçÆ</h3></div>';
                return;
            }

            const opening = state.loopData.opening;

            // Â§ÑÁêÜ missing ÊÉÖÂÜµ
            if (opening.missing === true) {
                container.innerHTML = `
                    <div class="missing-content-box">
                        <div class="missing-icon">‚ö†Ô∏è</div>
                        <h3>ÂºÄÁØáÂØπËØùÁº∫Â§±</h3>
                        <p class="missing-reason">${opening.reason || 'Êú™Êèê‰æõÂéüÂõ†'}</p>
                        ${opening.inherited_from ? `
                            <div class="inherited-info">
                                <span class="inherited-label">ÂÜÖÂÆπÁªßÊâøËá™Ôºö</span>
                                <span class="inherited-source">${opening.inherited_from}</span>
                            </div>
                        ` : ''}
                    </div>
                `;
                return;
            }

            const isFlowMode = state.viewMode === 'flow';
            let html = '';

            if (isFlowMode) {
                // ÊµÅÁ®ãÁâàÔºöÊòæÁ§∫Âú∫ÊôØÊåâÈíÆÔºåÁÇπÂáªÂ±ïÂºÄ
                html += '<div class="opening-scene-buttons">';
                opening.scenes?.forEach((scene, index) => {
                    html += `
                        <button class="opening-scene-btn" onclick="toggleOpeningScene(${index})">
                            <span class="scene-icon">üé¨</span>
                            <span>${scene.name}</span>
                            <span class="scene-arrow">‚ñº</span>
                        </button>
                    `;
                });
                html += '</div>';

                // Âú∫ÊôØÂÜÖÂÆπÔºàÂàùÂßãÈöêËóèÔºå‰ΩøÁî®ÈÄêÊù°Â±ïÂºÄÔºâ
                opening.scenes?.forEach((scene, index) => {
                    const dialogData = state.dialogs[scene.dialog_file];
                    const section = scene.dialog_section;
                    // ‰ΩøÁî®Êñ∞ÁöÑÂÖºÂÆπÂáΩÊï∞Ëé∑ÂèñËäÇÁÇπ
                    const nodes = getDialogNodes(dialogData, section);

                    html += `
                        <div class="dialog-section opening-scene-content" id="openingScene_${index}" style="display:none;">
                            <div class="scene-header">
                                <h3>${scene.name}</h3>
                                <p>${scene.description || ''}</p>
                            </div>
                            <div class="dialog-flow-container" id="openingDialogFlow_${index}">
                                ${renderOpeningDialogFlow(nodes, index)}
                            </div>
                        </div>
                    `;
                });
            } else {
                // ÂÆåÊï¥ÁâàÔºöÁõ¥Êé•ÊòæÁ§∫ÊâÄÊúâÂÜÖÂÆπ
                opening.scenes?.forEach(scene => {
                    html += `
                        <div class="dialog-section">
                            <div class="scene-header">
                                <h3>${scene.name}</h3>
                                <p>${scene.description || ''}</p>
                            </div>
                            <div class="dialog-nodes">
                    `;

                    const dialogData = state.dialogs[scene.dialog_file];
                    const section = scene.dialog_section;
                    // ‰ΩøÁî®Êñ∞ÁöÑÂÖºÂÆπÂáΩÊï∞Ëé∑ÂèñËäÇÁÇπ
                    const nodes = getDialogNodes(dialogData, section);

                    // Â≠òÂÇ®ÂΩìÂâçÂØπËØùÊï∞ÊçÆ‰ª•‰æõÂàÜÊîØÂ±ïÂºÄ‰ΩøÁî®
                    state.currentDialogData = { nodes: nodes };

                    nodes.forEach(node => {
                        html += renderDialogNode(node);
                    });

                    html += '</div></div>';
                });
            }

            container.innerHTML = html || '<div class="error-box"><h3>Êó†ÂØπËØùÊï∞ÊçÆ</h3></div>';
        }

        // ÂàáÊç¢ÂºÄÁØáÂú∫ÊôØÊòæÁ§∫
        window.toggleOpeningScene = function(index) {
            const scene = document.getElementById(`openingScene_${index}`);
            const btn = document.querySelectorAll('.opening-scene-btn')[index];

            if (scene) {
                const isVisible = scene.style.display !== 'none';
                scene.style.display = isVisible ? 'none' : 'block';
                btn.classList.toggle('active', !isVisible);

                // Êõ¥Êñ∞ÂΩìÂâçÂØπËØùÊï∞ÊçÆ‰ª•‰æõÂàÜÊîØÂ±ïÂºÄ‰ΩøÁî®
                if (!isVisible && state.loopData?.opening?.scenes) {
                    const openingScene = state.loopData.opening.scenes[index];
                    if (openingScene?.dialog_file) {
                        const dialogData = state.dialogs[openingScene.dialog_file];
                        const section = openingScene.dialog_section;
                        // ‰ΩøÁî®ÂÖºÂÆπÂáΩÊï∞Ëé∑ÂèñËäÇÁÇπ
                        const nodes = getDialogNodes(dialogData, section);
                        state.currentDialogData = { nodes: nodes };
                    }
                }
            }
        };

        // Ê∏≤ÊüìÂºÄÁØáÂØπËØùÔºàÊµÅÁ®ãÁâàÔºöÈÄêÊù°Â±ïÂºÄÔºâ
        function renderOpeningDialogFlow(nodes, sceneIndex) {
            if (!nodes || nodes.length === 0) return '<div style="color:#888;">Êó†ÂØπËØùÊï∞ÊçÆ</div>';

            let html = '';

            // Á¨¨‰∏ÄÊù°ÂØπËØùÁõ¥Êé•ÊòæÁ§∫ÔºåÂêéÁª≠ÈúÄË¶ÅÁÇπÂáª
            nodes.forEach((node, nodeIndex) => {
                const nodeId = `openingNode_${sceneIndex}_${nodeIndex}`;
                const isFirst = nodeIndex === 0;

                if (isFirst) {
                    // Á¨¨‰∏ÄÊù°Áõ¥Êé•ÊòæÁ§∫
                    html += `
                        <div class="dialog-flow-node visible" id="${nodeId}">
                            ${renderDialogNode(node)}
                        </div>
                    `;
                    // Â¶ÇÊûúËøòÊúâ‰∏ã‰∏ÄÊù°ÔºåÊòæÁ§∫"ÁªßÁª≠"ÊåâÈíÆ
                    if (nodes.length > 1) {
                        html += `
                            <button class="dialog-next-btn" id="openingNextBtn_${sceneIndex}_${nodeIndex}" onclick="showNextOpeningNode(${sceneIndex}, ${nodeIndex + 1}, ${nodes.length})">
                                ‚ñº ÁªßÁª≠
                            </button>
                        `;
                    }
                } else {
                    // ÂêéÁª≠ÂØπËØùÂàùÂßãÈöêËóè
                    html += `
                        <div class="dialog-flow-node" id="${nodeId}">
                            ${renderDialogNode(node)}
                        </div>
                    `;
                    // Â¶ÇÊûúËøòÊúâ‰∏ã‰∏ÄÊù°ÔºåÊòæÁ§∫"ÁªßÁª≠"ÊåâÈíÆÔºàÂàùÂßãÈöêËóèÔºâ
                    if (nodeIndex < nodes.length - 1) {
                        html += `
                            <button class="dialog-next-btn hidden" id="openingNextBtn_${sceneIndex}_${nodeIndex}" onclick="showNextOpeningNode(${sceneIndex}, ${nodeIndex + 1}, ${nodes.length})">
                                ‚ñº ÁªßÁª≠
                            </button>
                        `;
                    }
                }
            });

            return html;
        }

        // ÊòæÁ§∫‰∏ã‰∏ÄÊù°ÂºÄÁØáÂØπËØùËäÇÁÇπ
        window.showNextOpeningNode = function(sceneIndex, nodeIndex, totalNodes) {
            // ÈöêËóèÂΩìÂâçÁöÑ"ÁªßÁª≠"ÊåâÈíÆ
            const prevBtn = document.getElementById(`openingNextBtn_${sceneIndex}_${nodeIndex - 1}`);
            if (prevBtn) prevBtn.classList.add('hidden');

            // ÊòæÁ§∫‰∏ã‰∏ÄÊù°ÂØπËØù
            const nextNode = document.getElementById(`openingNode_${sceneIndex}_${nodeIndex}`);
            if (nextNode) {
                nextNode.classList.add('visible');
            }

            // Â¶ÇÊûúËøòÊúâÊõ¥Â§öÔºåÊòæÁ§∫‰∏ã‰∏Ä‰∏™"ÁªßÁª≠"ÊåâÈíÆÂπ∂ÊªöÂä®Âà∞ÂÆÉ
            if (nodeIndex < totalNodes - 1) {
                const nextBtn = document.getElementById(`openingNextBtn_${sceneIndex}_${nodeIndex}`);
                if (nextBtn) {
                    nextBtn.classList.remove('hidden');
                    // Âª∂ËøüÊªöÂä®ÔºåÁ≠âÂæÖDOMÊõ¥Êñ∞
                    setTimeout(() => {
                        nextBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 50);
                }
            } else {
                // ÊúÄÂêé‰∏ÄÊù°ÔºåÊªöÂä®Âà∞ËØ•ËäÇÁÇπ
                if (nextNode) {
                    setTimeout(() => {
                        nextNode.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 50);
                }
            }
        };

        // Ê∏≤ÊüìÂØπËØùËäÇÁÇπ
        // dialogFile: ÂèØÈÄâÔºåÁî®‰∫éÂàÜÊîØÈÄâÈ°πË∑≥ËΩ¨
        // branchId: ÂèØÈÄâÔºåÂΩìÂâçÂàÜÊîØÁöÑÂîØ‰∏ÄÊ†áËØÜ
        function renderDialogNode(node, dialogFile = null, branchId = null) {
            if (node.type === 'narration') {
                return `<div class="dialog-node narration">${node.text}</div>`;
            }

            if (node.type === 'branch') {
                const uniqueId = branchId || `branch_${Math.random().toString(36).substr(2, 9)}`;
                let optionsHtml = node.options.map((opt, optIndex) => `
                    <button class="branch-option-btn ${opt.important ? 'important' : ''}"
                            onclick="expandBranchOption('${uniqueId}', ${optIndex}, '${opt.next || 'END'}', '${dialogFile || ''}')">
                        ${opt.text}
                        <span class="branch-arrow">‚Üí</span>
                    </button>
                `).join('');

                // Ê∑ªÂä†Â±ïÂºÄÂêéÁöÑÂÜÖÂÆπÂå∫Âüü
                let branchContentsHtml = node.options.map((opt, optIndex) => `
                    <div class="branch-content" id="${uniqueId}_content_${optIndex}" style="display:none;">
                        <div class="branch-content-header">
                            <span class="branch-path-label">ÈÄâÊã©: ${opt.text}</span>
                        </div>
                        <div class="branch-content-nodes" id="${uniqueId}_nodes_${optIndex}">
                            <!-- ÂàÜÊîØÂÜÖÂÆπÂ∞ÜÂú®ÁÇπÂáªÊó∂Âä†ËΩΩ -->
                        </div>
                    </div>
                `).join('');

                return `
                    <div class="dialog-node branch" id="${uniqueId}">
                        <div class="speaker-name">ÈÄâÈ°π</div>
                        <div class="branch-options">${optionsHtml}</div>
                        <div class="branch-contents">${branchContentsHtml}</div>
                    </div>
                `;
            }

            if (node.type === 'scene_end' || node.type === 'phase_end' || node.type === 'dialog_end' || node.type === 'loop_end') {
                return `<div class="dialog-node narration">[${node.message || 'Âú∫ÊôØÁªìÊùü'}]</div>`;
            }

            if (node.type === 'evidence_gain') {
                return `
                    <div class="dialog-node" style="background: rgba(78, 205, 196, 0.15); border-left: 3px solid #4ecdc4;">
                        <div class="speaker-name" style="color: #4ecdc4;">Ëé∑ÂæóËØÅÊçÆ</div>
                        <div class="text">${node.evidence_name} (${node.evidence_id})</div>
                        <div class="action">${node.description || ''}</div>
                    </div>
                `;
            }

            // ÊôÆÈÄöÂØπËØù
            const speakerId = node.speaker || '';
            const speakerName = getNpcDisplayName(speakerId);
            const speakerClass = speakerId.toLowerCase();
            return `
                <div class="dialog-node speaker">
                    <div class="speaker-name ${speakerClass}">
                        ${speakerName}
                        ${node.emotion ? `<span class="emotion">[${node.emotion}]</span>` : ''}
                    </div>
                    <div class="text">${node.text || ''}</div>
                    ${node.action ? `<div class="action">${node.action}</div>` : ''}
                </div>
            `;
        }

        // Â±ïÂºÄÂàÜÊîØÈÄâÈ°πÂÜÖÂÆπ
        window.expandBranchOption = function(branchId, optIndex, nextNodeId, dialogFilePath) {
            const contentDiv = document.getElementById(`${branchId}_content_${optIndex}`);
            const nodesDiv = document.getElementById(`${branchId}_nodes_${optIndex}`);
            const btn = document.querySelector(`#${branchId} .branch-options .branch-option-btn:nth-child(${optIndex + 1})`);

            if (!contentDiv || !nodesDiv) return;

            // Â¶ÇÊûúÂ∑≤ÁªèÊòæÁ§∫ÔºåÂàôÈöêËóèÔºàÂàáÊç¢Ë°å‰∏∫Ôºâ
            if (contentDiv.style.display !== 'none') {
                contentDiv.style.display = 'none';
                if (btn) btn.classList.remove('active');
                return;
            }

            // ÈöêËóèÂêåÂàÜÊîØÁöÑÂÖ∂‰ªñÂ±ïÂºÄÂÜÖÂÆπ
            const allContents = document.querySelectorAll(`#${branchId} .branch-content`);
            allContents.forEach(c => c.style.display = 'none');

            // ÁßªÈô§ÊâÄÊúâÊåâÈíÆÁöÑactiveÁä∂ÊÄÅ
            const allBtns = document.querySelectorAll(`#${branchId} .branch-options .branch-option-btn`);
            allBtns.forEach(b => b.classList.remove('active'));

            // ÊòæÁ§∫ÂΩìÂâçÈÄâÈ°πÁöÑÂÜÖÂÆπ
            contentDiv.style.display = 'block';
            if (btn) btn.classList.add('active');

            // Â¶ÇÊûúÂ∑≤ÁªèÂä†ËΩΩËøáÂÜÖÂÆπÔºàÊéíÈô§ÂàùÂßãÁöÑÊ≥®ÈáäÂíåÂä†ËΩΩ‰∏≠Áä∂ÊÄÅÔºâÔºåÁõ¥Êé•ÊªöÂä®
            const currentContent = nodesDiv.innerHTML.trim();
            const isLoaded = currentContent !== '' &&
                             !currentContent.includes('Âä†ËΩΩ‰∏≠') &&
                             !currentContent.includes('<!--') &&
                             !currentContent.includes('ÂàÜÊîØÂÜÖÂÆπÂ∞ÜÂú®ÁÇπÂáªÊó∂Âä†ËΩΩ');
            if (isLoaded) {
                setTimeout(() => {
                    contentDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 50);
                return;
            }

            // Âä†ËΩΩÂàÜÊîØÂÜÖÂÆπ
            nodesDiv.innerHTML = '<div style="color:#888;padding:10px;">Âä†ËΩΩ‰∏≠...</div>';

            // ‰ªéstate‰∏≠Ëé∑ÂèñÂΩìÂâçÂØπËØùÊï∞ÊçÆ
            let dialogNodes = null;

            // ‰ºòÂÖà‰ªédialogFilePathËé∑ÂèñÔºàÂ¶ÇÊûú‰º†ÂÖ•‰∫ÜÁöÑËØùÔºâ
            if (dialogFilePath && state.dialogs[dialogFilePath]) {
                dialogNodes = state.dialogs[dialogFilePath].nodes;
            }
            // Âê¶ÂàôÂ∞ùËØï‰ªéÂΩìÂâçÁä∂ÊÄÅËé∑ÂèñÂØπËØùËäÇÁÇπ
            else if (state.currentDialogData && state.currentDialogData.nodes) {
                dialogNodes = state.currentDialogData.nodes;
            }

            if (!dialogNodes) {
                console.log('expandBranchOption debug:', {
                    dialogFilePath,
                    hasDialogs: !!state.dialogs,
                    dialogKeys: Object.keys(state.dialogs || {}),
                    currentDialogData: state.currentDialogData
                });
                nodesDiv.innerHTML = '<div style="color:#e74c3c;padding:10px;">Êó†Ê≥ïÂä†ËΩΩÂàÜÊîØÂÜÖÂÆπÔºàËØ∑Á°Æ‰øùÂ∑≤ÈÄâÊã©Âú∫ÊôØÔºâ</div>';
                return;
            }

            console.log('ÊâæÂà∞ÂØπËØùÊï∞ÊçÆÔºåËäÇÁÇπÊï∞Èáè:', dialogNodes.length, 'ÂºÄÂßãËäÇÁÇπ:', nextNodeId);

            // ‰ªénextNodeIdÂºÄÂßãÔºåÊî∂ÈõÜÂêéÁª≠ËäÇÁÇπÁõ¥Âà∞ÈÅáÂà∞ÂõûÂà∞ÂàÜÊîØËäÇÁÇπÊàñÁªìÊùü
            const branchPath = [];
            let currentId = nextNodeId;
            const visitedIds = new Set();
            const maxSteps = 50; // Èò≤Ê≠¢Êó†ÈôêÂæ™ÁéØ

            while (currentId && currentId !== 'END' && branchPath.length < maxSteps) {
                if (visitedIds.has(currentId)) break; // Ê£ÄÊµãÂæ™ÁéØ
                visitedIds.add(currentId);

                const node = dialogNodes.find(n => n.id === currentId);
                if (!node) break;

                branchPath.push(node);

                // Â¶ÇÊûúÊòØÂàÜÊîØËäÇÁÇπÊàñÁªìÊùüËäÇÁÇπÔºåÂÅúÊ≠¢
                if (node.type === 'branch' || node.type === 'dialog_end' ||
                    node.type === 'scene_end' || node.type === 'phase_end' ||
                    node.type === 'loop_end') {
                    break;
                }

                currentId = node.next;
            }

            console.log('Êî∂ÈõÜÂà∞ÂàÜÊîØË∑ØÂæÑËäÇÁÇπÊï∞:', branchPath.length, branchPath.map(n => n.id));

            // Ê∏≤ÊüìÂàÜÊîØË∑ØÂæÑÔºàÈÄêÊù°Â±ïÂºÄÊ®°ÂºèÔºâ
            if (branchPath.length > 0) {
                const fileToUse = dialogFilePath || null;
                const branchFlowId = `${branchId}_flow_${optIndex}`;

                let html = '';
                branchPath.forEach((node, nodeIndex) => {
                    const nodeId = `${branchFlowId}_node_${nodeIndex}`;
                    const isFirst = nodeIndex === 0;

                    if (isFirst) {
                        // Á¨¨‰∏ÄÊù°Áõ¥Êé•ÊòæÁ§∫
                        html += `
                            <div class="dialog-flow-node visible" id="${nodeId}">
                                ${renderDialogNode(node, fileToUse, `${branchId}_sub`)}
                            </div>
                        `;
                        // Â¶ÇÊûúËøòÊúâ‰∏ã‰∏ÄÊù°ÔºåÊòæÁ§∫"ÁªßÁª≠"ÊåâÈíÆ
                        if (branchPath.length > 1) {
                            html += `
                                <button class="dialog-next-btn" id="${branchFlowId}_btn_${nodeIndex}"
                                        onclick="showNextBranchNode('${branchFlowId}', ${nodeIndex + 1}, ${branchPath.length})">
                                    ‚ñº ÁªßÁª≠
                                </button>
                            `;
                        }
                    } else {
                        // ÂêéÁª≠ÂØπËØùÂàùÂßãÈöêËóè
                        html += `
                            <div class="dialog-flow-node" id="${nodeId}">
                                ${renderDialogNode(node, fileToUse, `${branchId}_sub`)}
                            </div>
                        `;
                        // Â¶ÇÊûúËøòÊúâ‰∏ã‰∏ÄÊù°ÔºåÊòæÁ§∫"ÁªßÁª≠"ÊåâÈíÆÔºàÂàùÂßãÈöêËóèÔºâ
                        if (nodeIndex < branchPath.length - 1) {
                            html += `
                                <button class="dialog-next-btn hidden" id="${branchFlowId}_btn_${nodeIndex}"
                                        onclick="showNextBranchNode('${branchFlowId}', ${nodeIndex + 1}, ${branchPath.length})">
                                    ‚ñº ÁªßÁª≠
                                </button>
                            `;
                        }
                    }
                });

                nodesDiv.innerHTML = html;
            } else {
                nodesDiv.innerHTML = '<div style="color:#888;padding:10px;">[Ê≠§ÈÄâÈ°πÁõ¥Êé•ÁªìÊùüÂØπËØùÊàñËøîÂõû‰∏ªÂàÜÊîØ]</div>';
            }

            // ÊªöÂä®Âà∞Â±ïÂºÄÁöÑÂÜÖÂÆπ
            setTimeout(() => {
                contentDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 50);
        };

        // ÊòæÁ§∫‰∏ã‰∏ÄÊù°ÂàÜÊîØÂØπËØùËäÇÁÇπ
        window.showNextBranchNode = function(branchFlowId, nodeIndex, totalNodes) {
            // ÈöêËóèÂΩìÂâçÁöÑ"ÁªßÁª≠"ÊåâÈíÆ
            const prevBtn = document.getElementById(`${branchFlowId}_btn_${nodeIndex - 1}`);
            if (prevBtn) prevBtn.classList.add('hidden');

            // ÊòæÁ§∫‰∏ã‰∏ÄÊù°ÂØπËØù
            const nextNode = document.getElementById(`${branchFlowId}_node_${nodeIndex}`);
            if (nextNode) {
                nextNode.classList.add('visible');
            }

            // Â¶ÇÊûúËøòÊúâÊõ¥Â§öÔºåÊòæÁ§∫‰∏ã‰∏Ä‰∏™"ÁªßÁª≠"ÊåâÈíÆÂπ∂ÊªöÂä®Âà∞ÂÆÉ
            if (nodeIndex < totalNodes - 1) {
                const nextBtn = document.getElementById(`${branchFlowId}_btn_${nodeIndex}`);
                if (nextBtn) {
                    nextBtn.classList.remove('hidden');
                    setTimeout(() => {
                        nextBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 50);
                }
            } else {
                // ÊúÄÂêé‰∏ÄÊù°ÔºåÊªöÂä®Âà∞ËØ•ËäÇÁÇπ
                if (nextNode) {
                    setTimeout(() => {
                        nextNode.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 50);
                }
            }
        };

        // Ê∏≤ÊüìNPC‰ø°ÊÅØ
        function renderNpcInfo(container) {
            if (!state.loopData) {
                container.innerHTML = '<div class="error-box"><h3>ËØ∑ÂÖàÈÄâÊã©Âæ™ÁéØ</h3></div>';
                return;
            }

            // Ëé∑ÂèñÂΩìÂâçÂæ™ÁéØÂè∑
            const loopNumber = state.loopData.loop_number || 1;
            const loopKey = `loop${loopNumber}`;

            // Êî∂ÈõÜÊú¨Âæ™ÁéØÂá∫Áé∞ÁöÑNPC
            const npcsInLoop = new Set();

            // ‰ªéËá™Áî±ÁéØËäÇÊî∂ÈõÜ
            state.loopData.free_phase?.scenes?.forEach(scene => {
                if (scene.npc) npcsInLoop.add(scene.npc);
            });

            // ‰ªéÊåáËØÅÊî∂ÈõÜ
            if (state.loopData.expose?.target) {
                npcsInLoop.add(state.loopData.expose.target);
            }

            // ËßíËâ≤Á±ªÂûã‰∏≠ÊñáÊò†Â∞Ñ
            const roleMap = {
                'protagonist': '‰∏ªËßí',
                'partner': 'Êê≠Ê°£',
                'suspect': 'Â´åÁñë‰∫∫',
                'witness': 'ËØÅ‰∫∫',
                'victim': 'ÂèóÂÆ≥ËÄÖ'
            };

            let html = `
                <div class="scene-header">
                    <h3>NPC ‰ø°ÊÅØÊ°£Ê°à - ${state.loopData.title || state.loopData.name || 'ÂΩìÂâçÂæ™ÁéØ'}</h3>
                    <p>Áé©ÂÆ∂Âú®Êú¨Âæ™ÁéØ‰∏≠ÂèØ‰ª•‰∫ÜËß£Âà∞ÁöÑNPC‰ø°ÊÅØ</p>
                </div>
                <div class="npc-info-grid">
            `;

            // ÈÅçÂéÜÊú¨Âæ™ÁéØÁöÑNPC
            npcsInLoop.forEach(npcId => {
                const npc = state.masterData.npcs[npcId];
                if (!npc) return;

                const info = npc.info?.[loopKey] || {};
                const testimonies = npc.testimonies?.[loopKey] || [];
                const hasInfo = Object.keys(info).length > 0 || testimonies.length > 0;

                // Ëé∑ÂèñÂêçÂ≠óÈ¶ñÂ≠óÊØç‰Ωú‰∏∫Â§¥ÂÉè
                const initial = (npc.name_cn || npc.name || '?')[0];

                html += `
                    <div class="npc-card">
                        <div class="npc-card-header">
                            <div class="npc-avatar">${initial}</div>
                            <div class="npc-card-title">
                                <h4>${npc.name_cn || npc.name} <span style="color:#666;font-size:12px;">(${npcId})</span></h4>
                                <span class="npc-role ${npc.role}">${roleMap[npc.role] || npc.role}</span>
                            </div>
                        </div>
                `;

                if (hasInfo) {
                    // Ê∏≤ÊüìinfoÂ≠óÊÆµ
                    if (Object.keys(info).length > 0) {
                        html += `
                            <div class="npc-info-section">
                                <h5>Âü∫Êú¨‰ø°ÊÅØ</h5>
                                <div class="info-table">
                        `;

                        for (const [key, value] of Object.entries(info)) {
                            // Ê†πÊçÆÂÖ≥ÈîÆËØçÊ∑ªÂä†È´ò‰∫ÆÊ†∑Âºè
                            let valueClass = '';
                            if (key.includes('Á∫øÁ¥¢') || key.includes('ÂÖ≥ÈîÆ')) {
                                valueClass = 'highlight';
                            } else if (key.includes('ÂºÇÂ∏∏') || key.includes('Ë∞é')) {
                                valueClass = 'warning';
                            }

                            html += `
                                <div class="info-row">
                                    <span class="info-label">${key}</span>
                                    <span class="info-value ${valueClass}">${value}</span>
                                </div>
                            `;
                        }

                        html += '</div></div>';
                    }

                    // Ê∏≤ÊüìËØÅËØç
                    if (testimonies.length > 0) {
                        html += `
                            <div class="npc-info-section">
                                <h5>ËØÅËØçËÆ∞ÂΩï</h5>
                                <div class="testimony-list">
                        `;

                        testimonies.forEach(testimony => {
                            html += `<div class="testimony-item">${testimony}</div>`;
                        });

                        html += '</div></div>';
                    }
                } else {
                    html += `<div class="no-info-hint">Êú¨Âæ™ÁéØÊöÇÊó†ËØ•NPCÁöÑËØ¶ÁªÜ‰ø°ÊÅØÈÖçÁΩÆ</div>`;
                }

                html += '</div>';
            });

            // Â¶ÇÊûúÊ≤°ÊúâNPC
            if (npcsInLoop.size === 0) {
                html += '<div class="no-info-hint">Êú¨Âæ™ÁéØÊ≤°ÊúâÂèØ‰∫§‰∫íÁöÑNPC</div>';
            }

            html += '</div>';
            container.innerHTML = html;
        }

        // Ê∏≤ÊüìËá™Áî±ÁéØËäÇ
        function renderFreePhase(container) {
            if (!state.loopData?.free_phase?.scenes) {
                container.innerHTML = '<div class="error-box"><h3>Êó†Ëá™Áî±ÁéØËäÇÊï∞ÊçÆ</h3></div>';
                return;
            }

            const freeScenes = state.loopData.free_phase.scenes;
            const scenesOverview = state.loopData.scenes_overview || [];
            const isFlowMode = state.viewMode === 'flow';

            // Ëé∑Âèñfree_phase‰∏≠Â∑≤ÊúâÁöÑÂú∫ÊôØID
            const freeScenesIds = new Set(freeScenes.map(s => s.scene));

            // ‰ªéscenes_overview‰∏≠Ëé∑ÂèñÈîÅÂÆöÂú∫ÊôØÔºàÊéíÈô§story_onlyÁ±ªÂûãÔºåÂõ†‰∏∫ÈÇ£ÊòØÁ∫ØÂâßÊÉÖÂú∫ÊôØÔºâ
            const lockedScenes = scenesOverview.filter(s =>
                s.status === 'locked' &&
                !freeScenesIds.has(s.scene)
            );

            // ÁîüÊàêÂú∫ÊôØÊåâÈíÆÔºà‰∏§ÁßçÊ®°ÂºèÈÉΩÊòæÁ§∫ÔºåÈÉΩÊòØÂàáÊç¢Ë°å‰∏∫Ôºâ
            let buttonsHtml = '<div class="scene-buttons">';

            // ÂèØËÆøÈóÆÂú∫ÊôØ
            freeScenes.forEach((scene, index) => {
                const sceneInfo = state.masterData.scenes[scene.scene] || {};
                const icon = scene.type === 'search' ? 'üîç' : 'üí¨';

                buttonsHtml += `
                    <button class="scene-btn" data-index="${index}" onclick="selectScene(${index})">
                        <span class="scene-icon">${icon}</span>
                        <span class="scene-name">${scene.name || sceneInfo.name || 'Êú™Áü•Âú∫ÊôØ'}</span>
                        <span class="scene-badge ${scene.type}">${scene.type === 'search' ? 'Êé¢Á¥¢' : 'NPC'}</span>
                        ${scene.evidences?.length ? `<span style="color:#4ecdc4;font-size:11px;">(${scene.evidences.length})</span>` : ''}
                    </button>
                `;
            });

            // ÈîÅÂÆöÂú∫ÊôØ
            lockedScenes.forEach((scene) => {
                const sceneInfo = state.masterData.scenes[scene.scene] || {};

                buttonsHtml += `
                    <button class="scene-btn locked" disabled>
                        <span class="scene-icon">üîí</span>
                        <span class="scene-name">${scene.name || sceneInfo.name || 'Êú™Áü•Âú∫ÊôØ'}</span>
                        <span class="scene-badge locked">ÈîÅÂÆö</span>
                    </button>
                `;
            });

            buttonsHtml += '</div>';

            // ‰∏§ÁßçÊ®°ÂºèÈÉΩÊòØÁÇπÂáªÂàáÊç¢ÔºåÂàùÂßãÊòæÁ§∫ÊèêÁ§∫
            let contentHtml = `
                <div id="sceneDetailArea">
                    <div class="no-scene-hint">
                        <div class="hint-icon">üëÜ</div>
                        <p>ÁÇπÂáª‰∏äÊñπÂú∫ÊôØÊåâÈíÆÊü•ÁúãËØ¶ÊÉÖ</p>
                    </div>
                </div>
            `;

            const totalScenes = freeScenes.length + lockedScenes.length;
            const lockedText = lockedScenes.length > 0 ? `Ôºå${lockedScenes.length} ‰∏™ÈîÅÂÆö` : '';

            container.innerHTML = `
                <div class="free-phase-container">
                    <div class="scene-header">
                        <h3>Ëá™Áî±Êé¢Á¥¢ - ${state.loopData.free_phase.description || ''}</h3>
                        <p>ÂÖ± ${freeScenes.length} ‰∏™ÂèØÊé¢Á¥¢Âú∫ÊôØ${lockedText}</p>
                    </div>
                    ${buttonsHtml}
                    ${contentHtml}
                </div>
            `;
        }

        // ÂÆåÊï¥ÁâàÂú∫ÊôØÂç°ÁâáÊ∏≤ÊüìÔºàÊâÄÊúâÂÜÖÂÆπÁõ¥Êé•Â±ïÁ§∫Ôºâ
        function renderSceneCardFull(scene, index) {
            const sceneInfo = state.masterData.scenes[scene.scene] || {};
            const npcInfo = scene.npc ? state.masterData.npcs[scene.npc] : null;
            const icon = scene.type === 'search' ? 'üîç' : 'üí¨';

            let html = `
                <div class="scene-card" id="sceneCard_${index}">
                    <div class="scene-card-header">
                        <span class="scene-card-icon">${icon}</span>
                        <div class="scene-card-title">
                            <h4>${scene.name || sceneInfo.name || 'Êú™Áü•Âú∫ÊôØ'}</h4>
                            <span class="scene-card-id">${scene.scene}</span>
                        </div>
                        <span class="scene-type-badge ${scene.type}">${scene.type === 'search' ? 'Êé¢Á¥¢' : 'NPC'}</span>
                    </div>
                    ${scene.note ? `<div class="scene-card-note">${scene.note}</div>` : ''}
            `;

            // NPC‰ø°ÊÅØ
            if (npcInfo) {
                html += `
                    <div class="scene-npc-info">
                        <strong>NPC:</strong> ${npcInfo.name_cn || npcInfo.name} (${scene.npc})
                    </div>
                `;
            }

            // ËØÅÊçÆÂàóË°®ÔºàÂÆåÊï¥ÁâàÔºöÂÖ®ÈÉ®Â±ïÂºÄÔºâ
            if (scene.evidences && scene.evidences.length > 0) {
                html += `
                    <div class="evidence-list">
                        <div class="evidence-list-header">
                            <span>üì¶</span> ÂèØËé∑ÂèñËØÅÊçÆ (${scene.evidences.length})
                        </div>
                `;

                scene.evidences.forEach((ev, evIndex) => {
                    html += renderEvidenceCardFull(ev, index, evIndex);
                });

                html += '</div>';
            }

            // ÂØπËØùÂÜÖÂÆπÔºàÂÆåÊï¥ÁâàÔºöÁõ¥Êé•ÊòæÁ§∫Ôºâ
            if (scene.dialog_file) {
                html += `
                    <div class="scene-dialog-section">
                        <div style="color:#3498db;font-size:14px;margin-bottom:10px;">üí¨ ÂØπËØùÂÜÖÂÆπ</div>
                        <div class="scene-dialog-content visible">
                            ${renderSceneDialog(scene.dialog_file)}
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            return html;
        }

        // ÂÆåÊï¥ÁâàËØÅÊçÆÂç°ÁâáÊ∏≤ÊüìÔºàÁõ¥Êé•Â±ïÂºÄÔºåÂàÜÊûêÁªìÊûúÁõ¥Êé•ÊòæÁ§∫Ôºâ
        function renderEvidenceCardFull(ev, sceneIndex, evIndex) {
            const evInfo = state.masterData.evidences[ev.id] || {};
            const cardId = `ev_full_${sceneIndex}_${evIndex}`;
            const hasAnalysis = evInfo.requires_analysis || evInfo.description?.analyzed;
            const typeText = {
                'item': 'Áâ©ÂìÅ',
                'clue': 'Á∫øÁ¥¢',
                'envir': 'ÁéØÂ¢É'
            }[evInfo.type] || evInfo.type || 'Á∫øÁ¥¢';

            const typeClass = evInfo.type || 'clue';

            let html = `
                <div class="evidence-card expanded">
                    <div class="evidence-card-header">
                        <div class="ev-icon">üìã</div>
                        <div class="ev-info">
                            <div class="ev-name">${ev.name || evInfo.name || 'Êú™Áü•ËØÅÊçÆ'}</div>
                            <div class="ev-id">${ev.id}</div>
                        </div>
                        <span class="ev-type ${typeClass}">${typeText}</span>
                    </div>
                    <div class="evidence-card-body" style="display:block;">
            `;

            // ÂàùÂßãÊèèËø∞
            if (evInfo.description?.initial) {
                html += `
                    <div class="ev-description">
                        <div class="desc-label">ÊèèËø∞</div>
                        <div class="desc-text">${evInfo.description.initial}</div>
                    </div>
                `;
            }

            // ‰ΩçÁΩÆ‰ø°ÊÅØ
            if (ev.location) {
                html += `<div class="ev-hint location">üìç ‰ΩçÁΩÆ: ${ev.location}</div>`;
            }

            // Ë∞úÈ¢òÊèêÁ§∫
            if (ev.puzzle_hint) {
                html += `<div class="ev-hint puzzle">üí° ÊèêÁ§∫: ${ev.puzzle_hint}</div>`;
            }

            // ÂâçÁΩÆÊù°‰ª∂
            if (ev.requires) {
                html += `<div class="ev-hint requires">üîí ÈúÄË¶Å: ${ev.requires}</div>`;
            }

            // ÂàÜÊûêÁªìÊûúÔºàÂÆåÊï¥ÁâàÔºöÁõ¥Êé•ÊòæÁ§∫Ôºâ
            if (hasAnalysis && evInfo.description?.analyzed) {
                html += `
                    <div class="analyze-section">
                        <div style="color:#9b59b6;font-size:12px;margin-bottom:8px;">üî¨ ${evInfo.analysis_action || 'ÂàÜÊûêËØÅÊçÆ'}</div>
                        <div class="analyzed-result visible">
                            <div class="result-label">ÂàÜÊûêÁªìÊûú</div>
                            <div class="result-text">${evInfo.description.analyzed}</div>
                        </div>
                    </div>
                `;
            }

            html += '</div></div>';
            return html;
        }

        // ÈÄâÊã©Âú∫ÊôØÔºà‰∏§ÁßçÊ®°ÂºèÂÖ±Áî®Ôºâ
        window.selectScene = function(index) {
            const scenes = state.loopData.free_phase.scenes;
            const scene = scenes[index];
            if (!scene) return;

            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.scene-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });

            // Ê†πÊçÆËßÜÂõæÊ®°ÂºèÊ∏≤Êüì‰∏çÂêåÁöÑÂú∫ÊôØÂç°Áâá
            const detailArea = document.getElementById('sceneDetailArea');
            if (state.viewMode === 'full') {
                detailArea.innerHTML = renderSceneCardFull(scene, index);
            } else {
                detailArea.innerHTML = renderSceneCardFlow(scene, index);
            }
        };

        // ÊµÅÁ®ãÁâàÂú∫ÊôØÂç°ÁâáÊ∏≤ÊüìÔºàÈúÄË¶ÅÁÇπÂáªÂ±ïÂºÄÔºâ
        function renderSceneCardFlow(scene, index) {
            const sceneInfo = state.masterData.scenes[scene.scene] || {};
            const npcInfo = scene.npc ? state.masterData.npcs[scene.npc] : null;
            const icon = scene.type === 'search' ? 'üîç' : 'üí¨';

            let html = `
                <div class="scene-card">
                    <div class="scene-card-header">
                        <span class="scene-card-icon">${icon}</span>
                        <div class="scene-card-title">
                            <h4>${scene.name || sceneInfo.name || 'Êú™Áü•Âú∫ÊôØ'}</h4>
                            <span class="scene-card-id">${scene.scene}</span>
                        </div>
                        <span class="scene-type-badge ${scene.type}">${scene.type === 'search' ? 'Êé¢Á¥¢' : 'NPC'}</span>
                    </div>
                    ${scene.note ? `<div class="scene-card-note">${scene.note}</div>` : ''}
            `;

            // NPC‰ø°ÊÅØ
            if (npcInfo) {
                html += `
                    <div class="scene-npc-info">
                        <strong>NPC:</strong> ${npcInfo.name_cn || npcInfo.name} (${scene.npc})
                    </div>
                `;
            }

            // ËØÅÊçÆÂàóË°®Ôºà‰ΩìÈ™åÁâàÔºöNPCÂØπËØùÂú∫ÊôØÂàùÂßãÈöêËóèÔºåÂØπËØùÂÆåÊàêÂêéÊòæÁ§∫Ôºâ
            if (scene.evidences && scene.evidences.length > 0) {
                // NPCÂú∫ÊôØÊúâÂØπËØùÊó∂ÔºåËØÅÊçÆÂàùÂßãÈöêËóè
                const hasDialog = scene.dialog_file && scene.type === 'npc';
                const hiddenClass = hasDialog ? 'hidden' : '';

                html += `
                    <div class="evidence-list ${hiddenClass}" id="evidenceList_${index}">
                        <div class="evidence-list-header">
                            <span>üì¶</span> ÂèØËé∑ÂèñËØÅÊçÆ (${scene.evidences.length})
                        </div>
                `;

                scene.evidences.forEach((ev, evIndex) => {
                    html += renderEvidenceCard(ev, index, evIndex);
                });

                html += '</div>';
            }

            // ÂØπËØùÂÜÖÂÆπÔºàÊµÅÁ®ãÁâàÔºöÈÄêÊù°ÁÇπÂáªÂ±ïÂºÄÔºâ
            if (scene.dialog_file) {
                html += `
                    <div class="scene-dialog-section">
                        <div style="color:#3498db;font-size:14px;margin-bottom:10px;">üí¨ ÂØπËØùÂÜÖÂÆπ</div>
                        <div class="dialog-flow-container" id="dialogFlow_${index}">
                            ${renderSceneDialogFlow(scene.dialog_file, index)}
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            return html;
        }

        // Ê∏≤ÊüìËØÅÊçÆÂç°ÁâáÔºà‰ΩìÈ™åÁâàÔºöÂèØÂ±ïÂºÄÔºâ
        function renderEvidenceCard(ev, sceneIndex, evIndex) {
            const evInfo = state.masterData.evidences[ev.id] || {};
            const cardId = `ev_${sceneIndex}_${evIndex}`;
            const hasAnalysis = evInfo.requires_analysis || evInfo.description?.analyzed;
            const typeText = {
                'item': 'Áâ©ÂìÅ',
                'clue': 'Á∫øÁ¥¢',
                'envir': 'ÁéØÂ¢É'
            }[evInfo.type] || evInfo.type || 'Á∫øÁ¥¢';
            const typeClass = evInfo.type || 'clue';

            let html = `
                <div class="evidence-card" id="${cardId}">
                    <div class="evidence-card-header" onclick="toggleEvidence('${cardId}')">
                        <div class="ev-icon">üìã</div>
                        <div class="ev-info">
                            <div class="ev-name">${ev.name || evInfo.name || 'Êú™Áü•ËØÅÊçÆ'}</div>
                            <div class="ev-id">${ev.id}</div>
                        </div>
                        <span class="ev-type ${typeClass}">${typeText}</span>
                        <span class="ev-expand">‚ñº</span>
                    </div>
                    <div class="evidence-card-body">
            `;

            // ÂàùÂßãÊèèËø∞
            if (evInfo.description?.initial) {
                html += `
                    <div class="ev-description">
                        <div class="desc-label">ÊèèËø∞</div>
                        <div class="desc-text">${evInfo.description.initial}</div>
                    </div>
                `;
            }

            // ‰ΩçÁΩÆ‰ø°ÊÅØ
            if (ev.location) {
                html += `<div class="ev-hint location">üìç ‰ΩçÁΩÆ: ${ev.location}</div>`;
            }

            // Ë∞úÈ¢òÊèêÁ§∫
            if (ev.puzzle_hint) {
                html += `<div class="ev-hint puzzle">üí° ÊèêÁ§∫: ${ev.puzzle_hint}</div>`;
            }

            // ÂâçÁΩÆÊù°‰ª∂
            if (ev.requires) {
                html += `<div class="ev-hint requires">üîí ÈúÄË¶Å: ${ev.requires}</div>`;
            }

            // ÂàÜÊûêÂäüËÉΩ
            if (hasAnalysis && evInfo.description?.analyzed) {
                const analyzeId = `analyze_${cardId}`;
                html += `
                    <div class="analyze-section">
                        <button class="analyze-btn" id="btn_${analyzeId}" onclick="analyzeEvidence('${analyzeId}')">
                            üî¨ ${evInfo.analysis_action || 'ÂàÜÊûêËØÅÊçÆ'}
                        </button>
                        <div class="analyzed-result" id="result_${analyzeId}">
                            <div class="result-label">ÂàÜÊûêÁªìÊûú</div>
                            <div class="result-text">${evInfo.description.analyzed}</div>
                        </div>
                    </div>
                `;
            }

            html += '</div></div>';
            return html;
        }

        // Â±ïÂºÄ/Êî∂Ëµ∑ËØÅÊçÆ
        window.toggleEvidence = function(cardId) {
            const card = document.getElementById(cardId);
            if (card) {
                card.classList.toggle('expanded');
            }
        };

        // ÂàÜÊûêËØÅÊçÆ
        window.analyzeEvidence = function(analyzeId) {
            const btn = document.getElementById(`btn_${analyzeId}`);
            const result = document.getElementById(`result_${analyzeId}`);

            if (btn && result) {
                btn.classList.add('analyzed');
                btn.textContent = '‚úì Â∑≤ÂàÜÊûê';
                result.classList.add('visible');
            }
        };

        // ÂàáÊç¢ÂØπËØùÊòæÁ§∫
        window.toggleDialog = function(index) {
            const content = document.getElementById(`dialogContent_${index}`);
            if (content) {
                content.classList.toggle('visible');
                const btn = content.previousElementSibling;
                if (content.classList.contains('visible')) {
                    btn.textContent = 'üìñ Êî∂Ëµ∑ÂØπËØùÂÜÖÂÆπ';
                } else {
                    btn.textContent = 'üí¨ Êü•ÁúãÂØπËØùÂÜÖÂÆπ';
                }
            }
        };

        // Ê∏≤ÊüìÂú∫ÊôØÂØπËØùÔºàÂÆåÊï¥ÁâàÔºâ
        function renderSceneDialog(dialogFile, sectionName = null) {
            const dialogData = state.dialogs[dialogFile];
            const nodes = getDialogNodes(dialogData, sectionName);
            if (!nodes || nodes.length === 0) return '<div style="color:#888;">Êó†ÂØπËØùÊï∞ÊçÆ</div>';

            // Â≠òÂÇ®ÂΩìÂâçÂØπËØùÊï∞ÊçÆ‰ª•‰æõÂàÜÊîØÂ±ïÂºÄ‰ΩøÁî®
            state.currentDialogData = dialogData;

            return nodes.map(node => renderDialogNode(node, dialogFile)).join('');
        }

        // Ê∏≤ÊüìÂú∫ÊôØÂØπËØùÔºàÊµÅÁ®ãÁâàÔºöÈÄêÊù°Â±ïÂºÄÔºâ
        function renderSceneDialogFlow(dialogFile, sceneIndex, sectionName = null) {
            const dialogData = state.dialogs[dialogFile];
            const nodes = getDialogNodes(dialogData, sectionName);
            if (!nodes || nodes.length === 0) return '<div style="color:#888;">Êó†ÂØπËØùÊï∞ÊçÆ</div>';

            // Â≠òÂÇ®ÂΩìÂâçÂØπËØùÊï∞ÊçÆ‰ª•‰æõÂàÜÊîØÂ±ïÂºÄ‰ΩøÁî®
            state.currentDialogData = dialogData;
            let html = '';

            // Á¨¨‰∏ÄÊù°ÂØπËØùÁõ¥Êé•ÊòæÁ§∫ÔºåÂêéÁª≠ÈúÄË¶ÅÁÇπÂáª
            nodes.forEach((node, nodeIndex) => {
                const nodeId = `dialogNode_${sceneIndex}_${nodeIndex}`;
                const isFirst = nodeIndex === 0;

                if (isFirst) {
                    // Á¨¨‰∏ÄÊù°Áõ¥Êé•ÊòæÁ§∫
                    html += `
                        <div class="dialog-flow-node visible" id="${nodeId}">
                            ${renderDialogNode(node, dialogFile)}
                        </div>
                    `;
                    // Â¶ÇÊûúËøòÊúâ‰∏ã‰∏ÄÊù°ÔºåÊòæÁ§∫"ÁªßÁª≠"ÊåâÈíÆ
                    if (nodes.length > 1) {
                        html += `
                            <button class="dialog-next-btn" id="nextBtn_${sceneIndex}_${nodeIndex}" onclick="showNextDialogNode(${sceneIndex}, ${nodeIndex + 1}, ${nodes.length})">
                                ‚ñº ÁªßÁª≠
                            </button>
                        `;
                    }
                } else {
                    // ÂêéÁª≠ÂØπËØùÂàùÂßãÈöêËóèÔºàÈÄöËøáCSSÊéßÂà∂ÔºåÊ≤°ÊúâvisibleÁ±ªÂ∞±ÈöêËóèÔºâ
                    html += `
                        <div class="dialog-flow-node" id="${nodeId}">
                            ${renderDialogNode(node, dialogFile)}
                        </div>
                    `;
                    // Â¶ÇÊûúËøòÊúâ‰∏ã‰∏ÄÊù°ÔºåÊòæÁ§∫"ÁªßÁª≠"ÊåâÈíÆÔºàÂàùÂßãÈöêËóèÔºâ
                    if (nodeIndex < nodes.length - 1) {
                        html += `
                            <button class="dialog-next-btn hidden" id="nextBtn_${sceneIndex}_${nodeIndex}" onclick="showNextDialogNode(${sceneIndex}, ${nodeIndex + 1}, ${nodes.length})">
                                ‚ñº ÁªßÁª≠
                            </button>
                        `;
                    }
                }
            });

            return html;
        }

        // ÊòæÁ§∫‰∏ã‰∏ÄÊù°ÂØπËØùËäÇÁÇπ
        window.showNextDialogNode = function(sceneIndex, nodeIndex, totalNodes) {
            // ÈöêËóèÂΩìÂâçÁöÑ"ÁªßÁª≠"ÊåâÈíÆ
            const prevBtn = document.getElementById(`nextBtn_${sceneIndex}_${nodeIndex - 1}`);
            if (prevBtn) prevBtn.classList.add('hidden');

            // ÊòæÁ§∫‰∏ã‰∏ÄÊù°ÂØπËØù
            const nextNode = document.getElementById(`dialogNode_${sceneIndex}_${nodeIndex}`);
            if (nextNode) {
                nextNode.classList.add('visible');
            }

            // Â¶ÇÊûúËøòÊúâÊõ¥Â§öÔºåÊòæÁ§∫‰∏ã‰∏Ä‰∏™"ÁªßÁª≠"ÊåâÈíÆÂπ∂ÊªöÂä®Âà∞ÂÆÉ
            if (nodeIndex < totalNodes - 1) {
                const nextBtn = document.getElementById(`nextBtn_${sceneIndex}_${nodeIndex}`);
                if (nextBtn) {
                    nextBtn.classList.remove('hidden');
                    setTimeout(() => {
                        nextBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 50);
                }
            } else {
                // ÊúÄÂêé‰∏ÄÊù°ÂØπËØùÔºåÊòæÁ§∫ËØÅÊçÆÂàóË°®ÔºàÂ¶ÇÊûúÊúâÁöÑËØùÔºâ
                const evidenceList = document.getElementById(`evidenceList_${sceneIndex}`);
                if (evidenceList) {
                    evidenceList.classList.remove('hidden');
                    evidenceList.classList.add('fade-in');
                    setTimeout(() => {
                        evidenceList.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                }
                // ÊªöÂä®Âà∞ÊúÄÂêé‰∏ÄÊù°ÂØπËØù
                if (nextNode) {
                    setTimeout(() => {
                        nextNode.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 50);
                }
            }
        };

        // ÂàáÊç¢Âú∫ÊôØÂØπËØùÊòæÁ§∫ÔºàÊóßÁâàÂÖºÂÆπÔºâ
        window.toggleSceneDialog = function(btn, index) {
            const card = btn.closest('.scene-card');
            const content = card.querySelector('.scene-dialog-content');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = 'Êî∂Ëµ∑ÂØπËØù';
            } else {
                content.style.display = 'none';
                btn.textContent = 'Â±ïÂºÄÂØπËØù';
            }
        };

        // Ê∏≤ÊüìÊåáËØÅÁéØËäÇ
        function renderExpose(container) {
            if (!state.loopData?.expose) {
                container.innerHTML = '<div class="error-box"><h3>Êó†ÊåáËØÅÊï∞ÊçÆ</h3></div>';
                return;
            }

            const expose = state.loopData.expose;
            const targetNpc = state.masterData.npcs[expose.target] || {};
            const isFlowMode = state.viewMode === 'flow';

            let html = `
                <div class="expose-section">
                    <div class="expose-header">
                        <h3>ÊåáËØÅÁéØËäÇ</h3>
                        <div class="target-info">
                            <strong>ÊåáËØÅÂØπË±°:</strong> ${expose.target_name || targetNpc.name_cn || expose.target}<br>
                            <strong>Âú∫ÊôØ:</strong> ${expose.scene_name || expose.scene}<br>
                            <strong>ËÆæËÆ°ÁêÜÂøµ:</strong> ${expose.design_concept || ''}
                        </div>
                    </div>
            `;

            if (isFlowMode) {
                // ÊµÅÁ®ãÁâàÔºöÊòæÁ§∫ËΩÆÊ¨°ÊåâÈíÆÂàóË°®ÔºåÁÇπÂáªÂ±ïÂºÄ
                html += '<div class="expose-rounds-buttons">';
                expose.rounds?.forEach((round, index) => {
                    html += `
                        <button class="expose-round-btn" onclick="toggleExposeRound(${index})">
                            <span class="round-num">${round.round}</span>
                            <span class="round-name">${round.name || `Á¨¨${round.round}ËΩÆ`}</span>
                            <span class="round-arrow">‚ñº</span>
                        </button>
                    `;
                });
                html += '</div>';

                // ÊµÅÁ®ãÁâàËΩÆÊ¨°ËØ¶ÊÉÖÔºàÂàùÂßãÈöêËóèÔºâ
                expose.rounds?.forEach((round, index) => {
                    html += renderExposeRoundFlow(round, index);
                });
            } else {
                // ÂÆåÊï¥ÁâàÔºöÁõ¥Êé•ÊòæÁ§∫ÊâÄÊúâËΩÆÊ¨°
                expose.rounds?.forEach(round => {
                    html += renderExposeRoundFull(round);
                });
            }

            html += '</div>';
            container.innerHTML = html;
        }

        // ÂÆåÊï¥ÁâàÊåáËØÅËΩÆÊ¨°Ê∏≤Êüì
        function renderExposeRoundFull(round) {
            const evidenceNames = round.evidence_names ||
                (round.evidences ? round.evidences.map(id => state.masterData.evidences[id]?.name || id) :
                [state.masterData.evidences[round.evidence]?.name || round.evidence]);

            return `
                <div class="expose-round">
                    <div class="round-header">
                        <div class="round-number">${round.round}</div>
                        <div class="round-title">${round.name || `Á¨¨${round.round}ËΩÆ`}</div>
                        ${round.duration ? `<div class="round-duration">${round.duration}</div>` : ''}
                    </div>

                    <div class="lie-box">
                        <div class="label">Ë∞éË®Ä</div>
                        <div class="content">${round.lie?.content || round.lie || ''}</div>
                        ${round.lie?.source ? `<div style="color:#888;font-size:12px;margin-top:5px;">Êù•Ê∫ê: ${round.lie.source}</div>` : ''}
                    </div>

                    <div class="evidence-box">
                        <div class="label">‰∏æËØÅ</div>
                        <div class="content">
                            ${round.evidence || round.evidences?.join(', ') || ''}:
                            ${evidenceNames.join(', ')}
                        </div>
                    </div>

                    ${round.zack_dialog ? `
                        <div class="dialog-box">
                            <div class="speaker-tag">Zack Ë¥®ÈóÆ</div>
                            <div class="dialog-text">${round.zack_dialog}</div>
                        </div>
                    ` : ''}

                    ${round.rosa_reaction ? `
                        <div class="dialog-box">
                            <div class="speaker-tag rosa">
                                Rosa ÂèçÂ∫î
                                <span class="emotion-tag">${round.rosa_reaction.emotion || ''}</span>
                            </div>
                            <div class="dialog-text">${round.rosa_reaction.dialog || ''}</div>
                        </div>
                    ` : ''}

                    <div class="result-box">
                        <div class="label">ÁªìÊûú</div>
                        <div class="content">${round.result || ''}</div>
                    </div>
                </div>
            `;
        }

        // ÊµÅÁ®ãÁâàÊåáËØÅËΩÆÊ¨°Ê∏≤ÊüìÔºàÂèØÂ±ïÂºÄÔºâ
        function renderExposeRoundFlow(round, index) {
            const evidenceNames = round.evidence_names ||
                (round.evidences ? round.evidences.map(id => state.masterData.evidences[id]?.name || id) :
                [state.masterData.evidences[round.evidence]?.name || round.evidence]);

            return `
                <div class="expose-round expose-round-flow" id="exposeRound_${index}" style="display:none;">
                    <div class="round-header">
                        <div class="round-number">${round.round}</div>
                        <div class="round-title">${round.name || `Á¨¨${round.round}ËΩÆ`}</div>
                        ${round.duration ? `<div class="round-duration">${round.duration}</div>` : ''}
                    </div>

                    <div class="flow-step" data-step="lie">
                        <button class="flow-step-btn" onclick="revealExposeStep(${index}, 'lie')">
                            üé≠ Êü•ÁúãË∞éË®Ä
                        </button>
                        <div class="flow-step-content lie-box" style="display:none;">
                            <div class="label">Ë∞éË®Ä</div>
                            <div class="content">${round.lie?.content || round.lie || ''}</div>
                            ${round.lie?.source ? `<div style="color:#888;font-size:12px;margin-top:5px;">Êù•Ê∫ê: ${round.lie.source}</div>` : ''}
                        </div>
                    </div>

                    <div class="flow-step" data-step="evidence">
                        <button class="flow-step-btn" onclick="revealExposeStep(${index}, 'evidence')">
                            üìã ÈÄâÊã©ËØÅÊçÆ
                        </button>
                        <div class="flow-step-content evidence-box" style="display:none;">
                            <div class="label">‰∏æËØÅ</div>
                            <div class="content">
                                ${round.evidence || round.evidences?.join(', ') || ''}:
                                ${evidenceNames.join(', ')}
                            </div>
                        </div>
                    </div>

                    ${round.zack_dialog ? `
                        <div class="flow-step" data-step="zack">
                            <button class="flow-step-btn" onclick="revealExposeStep(${index}, 'zack')">
                                üí¨ Zack Ë¥®ÈóÆ
                            </button>
                            <div class="flow-step-content dialog-box" style="display:none;">
                                <div class="speaker-tag">Zack Ë¥®ÈóÆ</div>
                                <div class="dialog-text">${round.zack_dialog}</div>
                            </div>
                        </div>
                    ` : ''}

                    ${round.rosa_reaction ? `
                        <div class="flow-step" data-step="reaction">
                            <button class="flow-step-btn" onclick="revealExposeStep(${index}, 'reaction')">
                                üò∞ ÂØπÊñπÂèçÂ∫î
                            </button>
                            <div class="flow-step-content dialog-box" style="display:none;">
                                <div class="speaker-tag rosa">
                                    Rosa ÂèçÂ∫î
                                    <span class="emotion-tag">${round.rosa_reaction.emotion || ''}</span>
                                </div>
                                <div class="dialog-text">${round.rosa_reaction.dialog || ''}</div>
                            </div>
                        </div>
                    ` : ''}

                    <div class="flow-step" data-step="result">
                        <button class="flow-step-btn" onclick="revealExposeStep(${index}, 'result')">
                            ‚úÖ Êü•ÁúãÁªìÊûú
                        </button>
                        <div class="flow-step-content result-box" style="display:none;">
                            <div class="label">ÁªìÊûú</div>
                            <div class="content">${round.result || ''}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ÂàáÊç¢ÊåáËØÅËΩÆÊ¨°ÊòæÁ§∫
        window.toggleExposeRound = function(index) {
            const round = document.getElementById(`exposeRound_${index}`);
            const btn = document.querySelectorAll('.expose-round-btn')[index];

            if (round) {
                const isVisible = round.style.display !== 'none';
                round.style.display = isVisible ? 'none' : 'block';
                btn.classList.toggle('active', !isVisible);

                // Â±ïÂºÄÊó∂ÔºåÊªöÂä®Âà∞Á¨¨‰∏Ä‰∏™Ê≠•È™§ÊåâÈíÆ
                if (!isVisible) {
                    const firstStepBtn = round.querySelector('.flow-step-btn');
                    if (firstStepBtn) {
                        setTimeout(() => {
                            firstStepBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 50);
                    }
                }
            }
        };

        // Â±ïÁ§∫ÊåáËØÅÊ≠•È™§
        window.revealExposeStep = function(roundIndex, step) {
            const round = document.getElementById(`exposeRound_${roundIndex}`);
            const stepDiv = round.querySelector(`.flow-step[data-step="${step}"]`);

            if (stepDiv) {
                const btn = stepDiv.querySelector('.flow-step-btn');
                const content = stepDiv.querySelector('.flow-step-content');

                if (btn && content) {
                    btn.style.display = 'none';
                    content.style.display = 'block';

                    // ÊâæÂà∞‰∏ã‰∏Ä‰∏™Êú™Â±ïÂºÄÁöÑÊ≠•È™§ÊåâÈíÆÔºåÊªöÂä®Âà∞ÂÆÉ
                    const nextStepBtn = round.querySelector('.flow-step-btn:not([style*="display: none"])');
                    if (nextStepBtn) {
                        setTimeout(() => {
                            nextStepBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 50);
                    } else {
                        // Â¶ÇÊûúÊ≤°Êúâ‰∏ã‰∏Ä‰∏™ÊåâÈíÆÔºàÊâÄÊúâÊ≠•È™§ÈÉΩÂ±ïÂºÄ‰∫ÜÔºâÔºåÊªöÂä®Âà∞ÂΩìÂâçÂÜÖÂÆπ
                        setTimeout(() => {
                            content.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 50);
                    }
                }
            }
        };

        // Ê∏≤ÊüìÊ≠£Â∏∏ÁªìÂ∞æÁöÑËæÖÂä©ÂáΩÊï∞
        function renderNormalEnding(ending, dialogData, isFlowMode) {
            let html = '';

            if (isFlowMode) {
                // ÊµÅÁ®ãÁâàÔºöÊòæÁ§∫ÊåâÈíÆÔºåÁÇπÂáªÂ±ïÂºÄÔºåÂØπËØùÈÄêÊù°ÊòæÁ§∫
                const nodes = getDialogNodes(dialogData, 'ending_scene');

                html += `
                    <div class="ending-buttons">
                        <button class="ending-btn" onclick="toggleEndingDialog()">
                            <span>üé¨</span> Êü•ÁúãÁªìÂ∞æÂØπËØù
                            <span class="ending-arrow">‚ñº</span>
                        </button>
                        <button class="ending-btn transition-btn" onclick="toggleEndingTransition()">
                            <span>‚û°Ô∏è</span> Êü•ÁúãËøáÊ∏°‰ø°ÊÅØ
                            <span class="ending-arrow">‚ñº</span>
                        </button>
                    </div>

                    <div class="dialog-section ending-dialog-content" id="endingDialog" style="display:none;">
                        <div class="scene-header">
                            <h3>Âæ™ÁéØÁªìÂ∞æ</h3>
                            <p>${ending.description || ''}</p>
                        </div>
                        <div class="dialog-flow-container" id="endingDialogFlow">
                            ${renderEndingDialogFlow(nodes)}
                        </div>
                    </div>

                    <div class="ending-transition-content" id="endingTransition" style="display:none; margin-top:20px; padding:15px; background:rgba(255,215,0,0.1); border-radius:8px;">
                        <div style="color:#ffd700; margin-bottom:10px;">ËøáÊ∏°‰ø°ÊÅØ</div>
                        <div style="color:#ccc;">
                            <strong>‰∏ã‰∏ÄÂæ™ÁéØ:</strong> ${ending.transition_to || 'Êó†'}<br>
                            <strong>‰∏ã‰∏ÄÁõÆÊ†á:</strong> ${ending.next_objective || 'Êó†'}
                        </div>
                    </div>
                `;
            } else {
                // ÂÆåÊï¥ÁâàÔºöÁõ¥Êé•ÊòæÁ§∫ÊâÄÊúâÂÜÖÂÆπ
                // Â≠òÂÇ®ÂΩìÂâçÂØπËØùÊï∞ÊçÆ‰ª•‰æõÂàÜÊîØÂ±ïÂºÄ‰ΩøÁî®
                if (dialogData) {
                    state.currentDialogData = dialogData;
                }

                html = `
                    <div class="dialog-section">
                        <div class="scene-header">
                            <h3>Âæ™ÁéØÁªìÂ∞æ</h3>
                            <p>${ending.description || ''}</p>
                        </div>
                        <div class="dialog-nodes">
                `;

                const endingNodes = getDialogNodes(dialogData, 'ending_scene');
                if (endingNodes && endingNodes.length > 0) {
                    endingNodes.forEach(node => {
                        html += renderDialogNode(node);
                    });
                }

                html += `
                        </div>
                    </div>
                    <div style="margin-top:20px; padding:15px; background:rgba(255,215,0,0.1); border-radius:8px;">
                        <div style="color:#ffd700; margin-bottom:10px;">ËøáÊ∏°‰ø°ÊÅØ</div>
                        <div style="color:#ccc;">
                            <strong>‰∏ã‰∏ÄÂæ™ÁéØ:</strong> ${ending.transition_to || 'Êó†'}<br>
                            <strong>‰∏ã‰∏ÄÁõÆÊ†á:</strong> ${ending.next_objective || 'Êó†'}
                        </div>
                    </div>
                `;
            }

            return html;
        }

        // Ê∏≤ÊüìÁªìÂ∞æ
        function renderEnding(container) {
            if (!state.loopData?.ending) {
                container.innerHTML = '<div class="error-box"><h3>Êó†ÁªìÂ∞æÊï∞ÊçÆ</h3></div>';
                return;
            }

            const ending = state.loopData.ending;

            // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´‰∏ã‰∏ÄÂæ™ÁéØopeningÔºà‰∏çÊòæÁ§∫missingÊèêÁ§∫Ôºâ
            if (ending.includes_next_loop_opening === true) {
                const dialogData = state.dialogs[ending.dialog_file];
                const isFlowMode = state.viewMode === 'flow';

                // Ê≠£Â∏∏ÊòæÁ§∫endingÔºå‰ΩÜÊ∑ªÂä†ÊèêÁ§∫‰ø°ÊÅØ
                let html = renderNormalEnding(ending, dialogData, isFlowMode);

                // Ê∑ªÂä†ÊèêÁ§∫ÔºöÂåÖÂê´‰∏ã‰∏ÄÂæ™ÁéØopening
                html += `
                    <div class="next-loop-hint">
                        <div class="hint-icon">‚ÑπÔ∏è</div>
                        <div class="hint-content">
                            <strong>ÊèêÁ§∫Ôºö</strong>Ê≠§ÁªìÂ∞æÂØπËØùÂ∑≤ÂåÖÂê´‰∏ã‰∏ÄÂæ™ÁéØÁöÑÂºÄÁØáÂÜÖÂÆπ
                        </div>
                    </div>
                `;

                container.innerHTML = html;
                return;
            }

            // Ê≠£Â∏∏Ê∏≤ÊüìÁªìÂ∞æ
            const dialogData = state.dialogs[ending.dialog_file];
            const isFlowMode = state.viewMode === 'flow';
            container.innerHTML = renderNormalEnding(ending, dialogData, isFlowMode);
        }

        // ÂàáÊç¢ÁªìÂ∞æÂØπËØùÊòæÁ§∫
        window.toggleEndingDialog = function() {
            const dialog = document.getElementById('endingDialog');
            const btn = document.querySelector('.ending-btn:not(.transition-btn)');

            if (dialog) {
                const isVisible = dialog.style.display !== 'none';
                dialog.style.display = isVisible ? 'none' : 'block';
                btn.classList.toggle('active', !isVisible);

                // Êõ¥Êñ∞ÂΩìÂâçÂØπËØùÊï∞ÊçÆ‰ª•‰æõÂàÜÊîØÂ±ïÂºÄ‰ΩøÁî®
                if (!isVisible && state.loopData?.ending?.dialog_file) {
                    state.currentDialogData = state.dialogs[state.loopData.ending.dialog_file];
                }
            }
        };

        // ÂàáÊç¢ËøáÊ∏°‰ø°ÊÅØÊòæÁ§∫
        window.toggleEndingTransition = function() {
            const transition = document.getElementById('endingTransition');
            const btn = document.querySelector('.ending-btn.transition-btn');

            if (transition) {
                const isVisible = transition.style.display !== 'none';
                transition.style.display = isVisible ? 'none' : 'block';
                btn.classList.toggle('active', !isVisible);
            }
        };

        // Ê∏≤ÊüìÁªìÂ∞æÂØπËØùÔºàÊµÅÁ®ãÁâàÔºöÈÄêÊù°Â±ïÂºÄÔºâ
        function renderEndingDialogFlow(nodes) {
            if (!nodes || nodes.length === 0) return '<div style="color:#888;">Êó†ÂØπËØùÊï∞ÊçÆ</div>';

            let html = '';

            nodes.forEach((node, nodeIndex) => {
                const nodeId = `endingNode_${nodeIndex}`;
                const isFirst = nodeIndex === 0;

                if (isFirst) {
                    html += `
                        <div class="dialog-flow-node visible" id="${nodeId}">
                            ${renderDialogNode(node)}
                        </div>
                    `;
                    if (nodes.length > 1) {
                        html += `
                            <button class="dialog-next-btn" id="endingNextBtn_${nodeIndex}" onclick="showNextEndingNode(${nodeIndex + 1}, ${nodes.length})">
                                ‚ñº ÁªßÁª≠
                            </button>
                        `;
                    }
                } else {
                    html += `
                        <div class="dialog-flow-node" id="${nodeId}">
                            ${renderDialogNode(node)}
                        </div>
                    `;
                    if (nodeIndex < nodes.length - 1) {
                        html += `
                            <button class="dialog-next-btn hidden" id="endingNextBtn_${nodeIndex}" onclick="showNextEndingNode(${nodeIndex + 1}, ${nodes.length})">
                                ‚ñº ÁªßÁª≠
                            </button>
                        `;
                    }
                }
            });

            return html;
        }

        // ÊòæÁ§∫‰∏ã‰∏ÄÊù°ÁªìÂ∞æÂØπËØùËäÇÁÇπ
        window.showNextEndingNode = function(nodeIndex, totalNodes) {
            const prevBtn = document.getElementById(`endingNextBtn_${nodeIndex - 1}`);
            if (prevBtn) prevBtn.classList.add('hidden');

            const nextNode = document.getElementById(`endingNode_${nodeIndex}`);
            if (nextNode) {
                nextNode.classList.add('visible');
            }

            if (nodeIndex < totalNodes - 1) {
                const nextBtn = document.getElementById(`endingNextBtn_${nodeIndex}`);
                if (nextBtn) {
                    nextBtn.classList.remove('hidden');
                    setTimeout(() => {
                        nextBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 50);
                }
            } else {
                if (nextNode) {
                    setTimeout(() => {
                        nextNode.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 50);
                }
            }
        };

        // ÊòæÁ§∫ÈîôËØØ
        function showError(message) {
            document.getElementById('mainContent').innerHTML = `
                <div class="error-box">
                    <h3>Âä†ËΩΩÂ§±Ë¥•</h3>
                    <p>${message}</p>
                    <p style="margin-top:10px;font-size:12px;color:#888;">
                        ËØ∑Á°Æ‰øùÊï∞ÊçÆÊñá‰ª∂Â≠òÂú®‰∏îÊ†ºÂºèÊ≠£Á°Æ„ÄÇ<br>
                        Â¶ÇÊûú‰ΩøÁî®Êú¨Âú∞Êñá‰ª∂ÔºåÈúÄË¶ÅÈÄöËøáHTTPÊúçÂä°Âô®ËÆøÈóÆ„ÄÇ
                    </p>
                </div>
            `;
        }

        // ÂêØÂä®
        init();

        // ========== ÁºñËæëÂäüËÉΩ ==========
        let isEditMode = false;
        let currentEditingNode = null;

        // ÂàáÊç¢ÁºñËæëÊ®°Âºè
        document.getElementById('editModeBtn').addEventListener('click', function() {
            isEditMode = !isEditMode;
            this.classList.toggle('active', isEditMode);

            if (isEditMode) {
                this.style.background = 'rgba(255, 215, 0, 0.3)';
                this.style.color = '#ffd700';
                this.style.borderColor = '#ffd700';
                document.getElementById('mainContent').classList.add('edit-mode');
                enableEditListeners();
                alert('‚úèÔ∏è ÁºñËæëÊ®°ÂºèÂ∑≤ÂºÄÂêØ\\n\\nÁÇπÂáª‰ªªÊÑèÂØπËØùË°åÂç≥ÂèØÁºñËæë„ÄÇ\\nÁºñËæëÂêéÁÇπÂáª"üì• ÂØºÂá∫"ÂèØ‰∏ãËΩΩYAMLÊñá‰ª∂„ÄÇ');
            } else {
                this.style.background = 'rgba(52, 152, 219, 0.2)';
                this.style.color = '#3498db';
                this.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                document.getElementById('mainContent').classList.remove('edit-mode');
                disableEditListeners();
            }
        });

        // ÂêØÁî®ÁºñËæëÁõëÂê¨
        function enableEditListeners() {
            document.querySelectorAll('.dialog-line').forEach((line, index) => {
                line.dataset.editIndex = index;
                line.addEventListener('click', handleDialogClick);
            });
        }

        // Á¶ÅÁî®ÁºñËæëÁõëÂê¨
        function disableEditListeners() {
            document.querySelectorAll('.dialog-line').forEach(line => {
                line.removeEventListener('click', handleDialogClick);
            });
        }

        // Â§ÑÁêÜÂØπËØùÁÇπÂáª
        function handleDialogClick(e) {
            if (!isEditMode) return;
            e.stopPropagation();

            const line = e.currentTarget;
            currentEditingNode = line;

            const speaker = line.querySelector('.speaker')?.textContent || '';
            const text = line.querySelector('.text')?.textContent || '';
            const emotion = line.querySelector('.emotion-badge')?.textContent || '';
            const action = line.querySelector('.action')?.textContent || '';

            document.getElementById('editSpeaker').value = speaker;
            document.getElementById('editText').value = text;
            document.getElementById('editEmotion').value = emotion;
            document.getElementById('editAction').value = action;

            document.getElementById('editModal').classList.add('active');
        }

        // ÂÖ≥Èó≠ÁºñËæëÂºπÁ™ó
        window.closeEditModal = function() {
            document.getElementById('editModal').classList.remove('active');
            currentEditingNode = null;
        }

        // ‰øùÂ≠òÁºñËæë
        window.saveEdit = function() {
            const newSpeaker = document.getElementById('editSpeaker').value.trim();
            const newText = document.getElementById('editText').value.trim();
            const newEmotion = document.getElementById('editEmotion').value.trim();
            const newAction = document.getElementById('editAction').value.trim();

            if (!newText && !newAction) {
                alert('ÂØπËØùÂÜÖÂÆπÂíåÂä®‰ΩúÊèèËø∞Ëá≥Â∞ëÂ°´ÂÜô‰∏ÄÈ°π!');
                return;
            }

            if (currentEditingNode) {
                const speakerEl = currentEditingNode.querySelector('.speaker');
                const textEl = currentEditingNode.querySelector('.text');
                const emotionEl = currentEditingNode.querySelector('.emotion-badge');
                const actionEl = currentEditingNode.querySelector('.action');

                if (speakerEl) speakerEl.textContent = newSpeaker;
                if (textEl) textEl.textContent = newText;
                if (emotionEl && newEmotion) emotionEl.textContent = newEmotion;
                if (actionEl && newAction) actionEl.textContent = newAction;

                currentEditingNode.classList.add('edited');
            }

            closeEditModal();
            console.log('ÂØπËØùÂ∑≤ÁºñËæë');
        }

        // ÂØºÂá∫YAML
        document.getElementById('exportBtn').addEventListener('click', function() {
            try {
                const dialogLines = document.querySelectorAll('.dialog-line');
                const loop = document.getElementById('loopSelect').value;

                if (!loop) {
                    alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Âæ™ÁéØ!');
                    return;
                }

                if (dialogLines.length === 0) {
                    alert('ÂΩìÂâçÈ°µÈù¢Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑÂØπËØùÂÜÖÂÆπ!');
                    return;
                }

                const exportData = {
                    dialog_id: 'loop' + loop + '_edited_' + Date.now(),
                    loop: parseInt(loop),
                    type: 'edited',
                    edited_at: new Date().toISOString(),
                    editor_note: 'Ê≠§Êñá‰ª∂Áî±ÂâßÊÉÖÈ¢ÑËßàÂô®ÁºñËæëÂäüËÉΩÂØºÂá∫',
                    sections: {
                        main: {
                            description: 'ÁºñËæëÂêéÁöÑÂØπËØù',
                            lines: []
                        }
                    }
                };

                dialogLines.forEach(line => {
                    const speaker = line.querySelector('.speaker')?.textContent.trim() || '';
                    const text = line.querySelector('.text')?.textContent.trim() || '';
                    const emotion = line.querySelector('.emotion-badge')?.textContent.trim() || '';
                    const action = line.querySelector('.action')?.textContent.trim() || '';

                    const lineData = {};
                    if (speaker) lineData.speaker = speaker;
                    if (emotion) lineData.emotion = emotion;
                    if (action) lineData.action = action;
                    if (text) lineData.text = text;

                    if (Object.keys(lineData).length > 0) {
                        exportData.sections.main.lines.push(lineData);
                    }
                });

                const yamlString = jsyaml.dump(exportData, {
                    indent: 2,
                    lineWidth: -1,
                    noRefs: true
                });

                const blob = new Blob([yamlString], { type: 'text/yaml;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'loop' + loop + '_edited_' + new Date().toISOString().slice(0,10) + '.yaml';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                alert('‚úÖ ÂØºÂá∫ÊàêÂäü!\\n\\nYAMLÊñá‰ª∂Â∑≤‰∏ãËΩΩÔºåÂåÖÂê´ ' + exportData.sections.main.lines.length + ' Êù°ÂØπËØù„ÄÇ');
            } catch (error) {
                console.error('ÂØºÂá∫Â§±Ë¥•:', error);
                alert('‚ùå ÂØºÂá∫Â§±Ë¥•: ' + error.message);
            }
        });

        // ESCÂÖ≥Èó≠ÂºπÁ™ó
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('editModal').classList.contains('active')) {
                closeEditModal();
            }
        });

        // ÁÇπÂáªÂºπÁ™óÂ§ñÈÉ®ÂÖ≥Èó≠
        document.getElementById('editModal')?.addEventListener('click', function(e) {
            if (e.target === this) closeEditModal();
        });
    </script>

    <!-- ÁºñËæëÂºπÁ™ó -->
    <div class="edit-modal" id="editModal">
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h3>ÁºñËæëÂØπËØù</h3>
                <button class="edit-close-btn" onclick="closeEditModal()">√ó</button>
            </div>
            <div class="edit-field">
                <label>ËØ¥ËØù‰∫∫</label>
                <input type="text" id="editSpeaker" placeholder="‰æãÂ¶Ç: NPC101">
            </div>
            <div class="edit-field">
                <label>ÂØπËØùÂÜÖÂÆπ</label>
                <textarea id="editText" placeholder="ËæìÂÖ•ÂØπËØùÂÜÖÂÆπ..."></textarea>
            </div>
            <div class="edit-field">
                <label>ÊÉÖÁª™Ê†áÁ≠æ (ÂèØÈÄâ)</label>
                <input type="text" id="editEmotion" placeholder="‰æãÂ¶Ç: calm, angry">
            </div>
            <div class="edit-field">
                <label>Âä®‰ΩúÊèèËø∞ (ÂèØÈÄâ)</label>
                <input type="text" id="editAction" placeholder="‰æãÂ¶Ç: Á´ôËµ∑Êù•ÔºåËµ∞ÂêëÈó®Âè£">
            </div>
            <div class="edit-actions">
                <button class="edit-cancel-btn" onclick="closeEditModal()">ÂèñÊ∂à</button>
                <button class="edit-save-btn" onclick="saveEdit()">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>
</body>
</html>
